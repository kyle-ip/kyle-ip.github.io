<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Docker &amp; K8S Cheat Sheet | YWH's Studio</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker &amp; K8S Cheat Sheet</h1><a id="logo" href="/.">YWH's Studio</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker &amp; K8S Cheat Sheet</h1><div class="post-meta">2020-02-15<span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2,203</span><span class="post-meta-item-text"> Words</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 11</span><span class="post-meta-item-text"> Minutes</span></span></span></div><div class="post-content"><blockquote>
<p>总结 Docker、K8S 一些基本用法，便于日常运维时查阅。</p>
</blockquote>
<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><h2 id="容器管理"><a href="#容器管理" class="headerlink" title="容器管理"></a>容器管理</h2><p>启动容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d jenkins:v1			<span class="comment"># 后台进程</span></span><br><span class="line">docker run -it ubuntu bash			<span class="comment"># 交互式 Shell</span></span><br><span class="line">docker run --rm ubuntu bash			<span class="comment"># 自动删除</span></span><br><span class="line">docker run -p 8080:80 -d nginx		<span class="comment"># 端口映射，宿主机端口:容器端口</span></span><br><span class="line">docker run --name mydb redis		<span class="comment"># 命名</span></span><br><span class="line">docker run -d label=traefik.backend=jenkins jenkins		<span class="comment"># 添加标签</span></span><br></pre></td></tr></table></figure>

<p>进入容器（运行 Shell）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it container_id /bin/bash       			# 对 Container 执行命令，进入其所在的命名空间并开启一个 shell</span><br></pre></td></tr></table></figure>

<p>停止、重启容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker start mydb</span><br><span class="line">docker stop mydb</span><br><span class="line">docker restart mydb</span><br></pre></td></tr></table></figure>

<p>查看容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps [-a]									# 启动中</span><br><span class="line">docker ps --filter label=traefik.backend		# 带指定标签</span><br></pre></td></tr></table></figure>

<p>查看容器元信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker inspect c7337</span><br><span class="line">docker inspect -f '&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;' c7337</span><br></pre></td></tr></table></figure>

<p>删除所有停止的容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm $(docker ps --filter status=exited -q)</span><br></pre></td></tr></table></figure>

<p>导出容器（为文件）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 导出为文件，相当于 docker commit + docker save</span></span><br><span class="line">docker export -o ./app.tar app</span><br><span class="line"></span><br><span class="line">docker import ./app.tar app</span><br></pre></td></tr></table></figure>



<h2 id="镜像管理"><a href="#镜像管理" class="headerlink" title="镜像管理"></a>镜像管理</h2><p>创建镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build --tag myimage .		# 从 Dockerfile 创建</span><br><span class="line">docker build --no-cache .			# 强制重建</span><br><span class="line">docker commit c7337 myimage			# 把容器打包为镜像</span><br></pre></td></tr></table></figure>

<p>删除无用镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi $(docker images -q -f "dangling=true")		# 删除</span><br></pre></td></tr></table></figure>

<p>查看镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<p>打标签、推送镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag 2f415b0e9a6e 10.0.2.81:8080/project/rabbitmq:3.7.3-management</span><br><span class="line">docker push 10.0.2.81:80/project/rabbitmq</span><br></pre></td></tr></table></figure>

<p>容器打包为镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit container image</span><br></pre></td></tr></table></figure>

<p>导出/ 导出镜像（为文件）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker save -o ./image-tag.tar image:tag</span><br><span class="line">docker save image:tag &gt; image-tag.tar</span><br><span class="line"></span><br><span class="line">docker load &lt; image:tag.tar</span><br><span class="line">docker load -i image:tag.tar</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 批量操作</span></span><br><span class="line">docker save -o ./images.tar image1 image2 image3 ...</span><br></pre></td></tr></table></figure>



<h2 id="卷管理"><a href="#卷管理" class="headerlink" title="卷管理"></a>卷管理</h2><p>创建本地卷</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create --name myvol</span><br></pre></td></tr></table></figure>

<p>挂载卷到容器（卷:容器目录）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v myvol:/data redis</span><br></pre></td></tr></table></figure>

<p>查看所有卷</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume ls</span><br></pre></td></tr></table></figure>



<h2 id="网络管理"><a href="#网络管理" class="headerlink" title="网络管理"></a>网络管理</h2><p>创建本地网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create mynet</span><br></pre></td></tr></table></figure>

<p>绑定网络到容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net mynet redis</span><br></pre></td></tr></table></figure>

<p>容器连接网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker network connect mynet c7337</span><br><span class="line">docker network disconnect mynet c7337</span><br></pre></td></tr></table></figure>



<h2 id="调试、问题排查"><a href="#调试、问题排查" class="headerlink" title="调试、问题排查"></a>调试、问题排查</h2><p>在容器中启动另一个进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it c7337 bash</span><br></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f c7337</span><br></pre></td></tr></table></figure>

<p>查看暴露的端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker port c7337</span><br></pre></td></tr></table></figure>

<p>查看磁盘占用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">du -hs /var/lib/docker</span><br><span class="line">docker system df</span><br></pre></td></tr></table></figure>

<p>清理磁盘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker system prune</span><br><span class="line"><span class="meta">#</span><span class="bash"> 慎用，会清理磁盘，删除关闭的容器、无用的数据卷和网络</span></span><br></pre></td></tr></table></figure>



<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>Docker Compose 的命令可能需要在项目目录下执行。</p>
<p>查看版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>

<p>启动应用</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker-compose</span> <span class="selector-tag">-f</span> <span class="selector-tag">docker-compose</span><span class="selector-class">.yml</span> <span class="selector-tag">up</span></span><br></pre></td></tr></table></figure>

<p>删除容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down                 # 删除容器</span><br></pre></td></tr></table></figure>

<p>启动/ 停止容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br><span class="line">docker-compose start</span><br></pre></td></tr></table></figure>

<p>查看相关容器、镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose images</span><br><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure>

<p>执行交互式 Shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose exec xxx bash        # 在docker中执行命令，注意docker-compose下dodker的名称与docker本身的名称不同</span><br></pre></td></tr></table></figure>



<h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><p>Kubernetes 对象指的是 Pod、Service、Deployment、ReplicationController、Job、Node、Ingress、PersistentVolumn 等。</p>
<h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><p>查看 kubectl 版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl version</span><br></pre></td></tr></table></figure>

<p>查集群信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info</span><br><span class="line">kubectl get componentstatus</span><br></pre></td></tr></table></figure>

<p>查对象详细信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe [pods | svc | depoloy | rc | jobs | nodes | pvc | pv] name</span><br></pre></td></tr></table></figure>

<p>查对象（Namespace、Pod、Service、Deployment、ReplicationController、Node 等）信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get [ns | po | svc | depoloy | rc | job | node | pvc | pv] name</span><br><span class="line">			[-o wide] 				# 更多信息</span><br><span class="line">			[--all-namespaces]		# 所有命名空间</span><br><span class="line">			[--show-labels]			# 查看标签</span><br><span class="line">			[-l labelkey=labelvalue]</span><br><span class="line">			[-n namespace]			# 指定命名空间</span><br></pre></td></tr></table></figure>

<p>查看已部署的 Pod 完整定义</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po kubia-zxzij -o yaml</span><br></pre></td></tr></table></figure>

<p>使用 JSONPath（截取必要信息）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -o jsonpath='&#123;.items[*l.etatus.addresses[?(@.tye=="ExternalIP")].address&#125;'		# 获取节点 IP</span><br></pre></td></tr></table></figure>

<p>查看 API 对象的可用属性（yaml 字段）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pods</span><br></pre></td></tr></table></figure>



<h2 id="Pod、容器操作"><a href="#Pod、容器操作" class="headerlink" title="Pod、容器操作"></a>Pod、容器操作</h2><p>在已存在的 Pod 容器上执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec kubia-7nogl -- curl -s http://10.111.249.153		# 内部测试服务</span><br><span class="line"><span class="meta">#</span><span class="bash"> -- 用于分隔 K8S 命令和 Shell 命令</span></span><br></pre></td></tr></table></figure>

<p>进入容器 Shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it kubi a-3inly bash</span><br></pre></td></tr></table></figure>



<h2 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h2><p>创建 ConfigMap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap myconfigmap --from-literal=foo=bar --from-literal=bar=baz --from-literal=one=two		# 指定配置项</span><br><span class="line">kubectl create configmap my-config --from-file=/path/to/dir		# 指定配置文件目录（可多个）</span><br></pre></td></tr></table></figure>



<h2 id="应用部署"><a href="#应用部署" class="headerlink" title="应用部署"></a>应用部署</h2><p>直接启动</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubect1 <span class="builtin-name">run</span> dsutils <span class="attribute">--image</span>=tutu/dnsutils <span class="attribute">--generator</span>=run-pod/vl --comand -- sleep infinity</span><br></pre></td></tr></table></figure>

<p>从配置文件创建、替换对象</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubect1 create/replace -f kubia-manual.yml</span><br><span class="line">kubect1 apply -f kubia-manual.yml		# 更建议使用 apply，不会删除原有的对象再创建，而是直接在原有的基础上更新</span><br></pre></td></tr></table></figure>

<p>删除对象</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete po -1 creation_method=manual</span><br><span class="line">				[--all]		# 当前命名空间中的指定的对象</span><br><span class="line">                [all]		# 所有对象</span><br></pre></td></tr></table></figure>

<p>端口映射（宿主机端口:Pod 端口）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubect1 port-forard kubia-manual 8888:8080</span><br></pre></td></tr></table></figure>

<p>修改标签、注解</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl label po kubia-manual creation_method=manual		# 标签 creation_method=manual</span><br><span class="line">				[--overwrite]		# 确认覆盖现有的 key</span><br><span class="line">kubect1 annotate pod kubia-manual mycompany.com/someannotation="foo bar"</span><br></pre></td></tr></table></figure>



<h3 id="应用升级"><a href="#应用升级" class="headerlink" title="应用升级"></a>应用升级</h3><p>扩容、缩容（客户端模式，已过时）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl rolling-update kubia-vl kubia-v2 --image=luksa/kubia:v2 --v 6		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从 kubia-v1 升级到 kubia-v2，指定镜像为 luksa/kubia:v2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -- v 6 表示提高日志等级</span></span><br></pre></td></tr></table></figure>

<p>扩容、缩容到指定副本数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deploy kubernetes-bootcamp --replicas=4</span><br></pre></td></tr></table></figure>

<p>从 yaml 创建部署</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubect1 create -f kubia-deployent-vl.yaml --record		# --record 记录历史版本号</span><br></pre></td></tr></table></figure>

<p>通过完整的 yaml 或 json 文件修改对象</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubect1 apply -f kubia-deployment-v2.yaml		# 不存在则创建</span><br><span class="line">kubect1 create -f kubia-deployment-v2.yaml		# 不存在则报错</span><br></pre></td></tr></table></figure>

<p>修改单个属性（打补丁），不会触发更新</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch deployment kubia -p '&#123;"spec": &#123;"minReadySeconds": 10&#125;&#125;'</span><br></pre></td></tr></table></figure>

<p>编辑配置，保存后触发更新</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit re kubia		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用默认编辑器（可通过环境变量指定，比如 <span class="built_in">export</span> KBE_EDITOR=<span class="string">"/usr/bin/nano"</span>）</span></span><br></pre></td></tr></table></figure>

<p>更新镜像，自动触发更新</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deploy kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2</span><br></pre></td></tr></table></figure>

<p>暂停、恢复升级</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubect1 rollout pause deployment kubia</span><br><span class="line">kubect1 rollout resume deployment kubia</span><br></pre></td></tr></table></figure>

<p>回滚升级</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deploy kubernetes-bootcamp</span><br><span class="line">					[--to-revision=1]			# 回滚到特定版本</span><br></pre></td></tr></table></figure>

<p>查看部署状态、历史</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment kubia</span><br><span class="line">kubectl rollout history deployment kubia</span><br></pre></td></tr></table></figure>



<h2 id="调试、问题排查-1"><a href="#调试、问题排查-1" class="headerlink" title="调试、问题排查"></a>调试、问题排查</h2><p>查看日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">journalctl -f</span><br><span class="line">journalctl -u kubelet -n 1000 xxx</span><br><span class="line">kubectl logs -f podName -n namespace [-c containerName]		# 持续输出</span><br><span class="line">kubectl logs podName --previous		# 当前容器的上一个容器</span><br></pre></td></tr></table></figure>

<p>启动并测试通过 yaml 定义的 Service</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-service.yaml</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl run busybox --rm=true --image=busybox --restart=Never --tty -i</span><br><span class="line">    wget -qO - serviceIp:8080/serviceName</span><br></pre></td></tr></table></figure>



<h2 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h2><p>查看 Dashboard Web 页面 URL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info | grep dashboard</span><br></pre></td></tr></table></figure>

<p>查看登录密码（一般用户 read-user/ 管理员 admin-user）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span><br></pre></td></tr></table></figure>



<h2 id="集群安全"><a href="#集群安全" class="headerlink" title="集群安全"></a>集群安全</h2><p>创建 secret</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo test &gt; foo</span><br><span class="line">kubectl create secret generic fortune-https --from-file=https.key --from-file=https.cert --from-file=foo</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> secrets</span><br><span class="line">kubectl <span class="builtin-name">get</span> serviceaccount</span><br><span class="line">kubectl <span class="builtin-name">get</span> sa -o yaml/json</span><br><span class="line">kubectl <span class="builtin-name">get</span> secrets -o yaml/json</span><br></pre></td></tr></table></figure>



<h2 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h2><h3 id="外部访问-API-Server"><a href="#外部访问-API-Server" class="headerlink" title="外部访问 API Server"></a>外部访问 API Server</h3><p>运行代理服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy			# 先运行代理服务，用于转发 HTTP 请求到 API Server</span><br></pre></td></tr></table></figure>

<p>请求 API</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8001/api/v1/proxy/namespaces/default/pods/podName/</span><br><span class="line">curl http://localhost:8001/apis/batch</span><br></pre></td></tr></table></figure>



<h3 id="Pod-内访问-API-Server"><a href="#Pod-内访问-API-Server" class="headerlink" title="Pod 内访问 API Server"></a>Pod 内访问 API Server</h3><p>查看 API Server 地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc</span><br><span class="line">kubectl exec mypod -- env | grep KUBERNETES_SERVICE</span><br></pre></td></tr></table></figure>

<p>查看 secret 挂载卷文件（ca.crt、namespace、token）</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec mypod ls <span class="regexp">/var/</span>run<span class="regexp">/secrets/</span>kubernetes.io<span class="regexp">/serviceaccount/</span></span><br></pre></td></tr></table></figure>

<p>在 Pod 中指定证书、验证服务器身份（客户端信任 API Server 的身份）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl extc -it podName</span><br><span class="line">curl --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt https://kubernetes</span><br></pre></td></tr></table></figure>

<p>获得 API Server 授权（API Server 确认客户端的身份）、访问资源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span><br><span class="line">curl -H "Authorization: Bearer $TOKEN" https://kubernetes</span><br></pre></td></tr></table></figure>



<h3 id="获取当前-Pod-所在命名空间所有-Pod"><a href="#获取当前-Pod-所在命名空间所有-Pod" class="headerlink" title="获取当前 Pod 所在命名空间所有 Pod"></a>获取当前 Pod 所在命名空间所有 Pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl extc -it podName</span><br><span class="line">NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span><br><span class="line">curl -H "Authorization: Bearer $TOKEN" https://kubernetes/api/vl/naespaces/$NS/pods</span><br></pre></td></tr></table></figure>



<h1 id="Vagrant"><a href="#Vagrant" class="headerlink" title="Vagrant"></a>Vagrant</h1><p>其实 Vagrant 与 Docker、K8S 无关，只是用来管理虚拟机、方便搭建测试环境而已。</p>
<h2 id="全局管理"><a href="#全局管理" class="headerlink" title="全局管理"></a>全局管理</h2><p>查看所有虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant global-status</span><br></pre></td></tr></table></figure>

<p>查看所有 box（镜像）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box list</span><br></pre></td></tr></table></figure>

<p>销毁指定虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant destroy [vmName|vmId]</span><br></pre></td></tr></table></figure>

<p>推送 box 到仓库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add boxName path</span><br></pre></td></tr></table></figure>

<p>删除 box</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vagrant box remove boxName</span><br><span class="line">vagrant box remove boxName --box-version &lt;version&gt;    # 指定版本</span><br></pre></td></tr></table></figure>

<p>更新 box</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box update --box boxName</span><br></pre></td></tr></table></figure>



<h2 id="当前虚拟机"><a href="#当前虚拟机" class="headerlink" title="当前虚拟机"></a>当前虚拟机</h2><p>初始化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant init [centos/7]</span><br></pre></td></tr></table></figure>

<p>启动、关闭、删除虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant up</span><br><span class="line">vagrant halt</span><br><span class="line">vagrant destroy [-f]</span><br></pre></td></tr></table></figure>

<p>SSH 连接虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh</span><br></pre></td></tr></table></figure>

<p>更改并应用虚拟机配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vagrant provision</span><br><span class="line">vagrant reload</span><br></pre></td></tr></table></figure>

<p>打包虚拟机为 box</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vagrant package</span><br><span class="line">	--ouput=boxName</span><br></pre></td></tr></table></figure>

<p>更新 box 版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box update</span><br></pre></td></tr></table></figure>

<p>查看虚拟机状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant status</span><br></pre></td></tr></table></figure>



<h2 id="Vagrantfile"><a href="#Vagrantfile" class="headerlink" title="Vagrantfile"></a>Vagrantfile</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">      config.vm.box = <span class="string">"centos/7"</span></span><br><span class="line">      config.vm.network <span class="string">"private_network"</span>, <span class="symbol">ip:</span> <span class="string">"10.0.3.110"</span></span><br><span class="line">      config.vm.provision <span class="string">"shell"</span>, <span class="symbol">inline:</span> &lt;&lt;-SHELL</span><br><span class="line">        sudo su</span><br><span class="line">        service network restart</span><br><span class="line">        </span><br><span class="line">        yum -y install net-tools vim wget</span><br><span class="line">        systemctl start docker</span><br><span class="line">        </span><br><span class="line">        echo <span class="string">"10.0.3.110 Master"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span><br><span class="line">        echo <span class="string">"10.0.3.111 Slave1"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span><br><span class="line">        echo <span class="string">"10.0.3.112 Slave2"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span><br><span class="line">        </span><br><span class="line">        echo <span class="string">"Master"</span> &gt; <span class="regexp">/etc/hostname</span></span><br><span class="line">        hostname Master</span><br><span class="line">        </span><br><span class="line">        wget <span class="symbol">http:</span>/<span class="regexp">/apache.mirrors.pair.com/zookeeper</span><span class="regexp">/zookeeper-3.4.13/zookeeper</span>-<span class="number">3.4</span>.<span class="number">13</span>.tar.gz \</span><br><span class="line">            -O /usr/local/src/zookeeper-<span class="number">3.4</span>.<span class="number">13</span>.tar.gz</span><br><span class="line">        tar -zxf /usr/local/src/zookeeper-<span class="number">3.4</span>.<span class="number">13</span>.tar.gz</span><br><span class="line">    SHELL</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p>以上。</p>
</div><div class="tags"><a href="/tags/%E6%8A%80%E6%9C%AF/"><i class="fa fa-tag"></i>技术</a><a href="/tags/Docker/"><i class="fa fa-tag"></i>Docker</a><a href="/tags/Kubernetes/"><i class="fa fa-tag"></i>Kubernetes</a></div><div class="post-nav"><a class="pre" href="/2020/02/15/Git_Cheat-Sheet/">Git Cheat Sheet</a><a class="next" href="/2020/02/15/2020-02-15_diary/">疫情过后最想做的事</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC80ODYzMi8yNTEyNg=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://yipwinghong.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/%E6%9D%82%E4%BA%8B/" style="font-size: 15px;">杂事</a> <a href="/tags/%E6%8A%80%E6%9C%AF/" style="font-size: 15px;">技术</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 15px;">大数据</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Kubernetes/" style="font-size: 15px;">Kubernetes</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" style="font-size: 15px;">信息安全</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/04/08/2020-04-08_diary/">关于使用思维导图做笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/28/Algorithm-leetcode-high-frequency-problems/">LeetCode 高频面试题</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/06/InfoSecty_personal-infomation-security-guide/">個人信息安全保護指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/22/2020-02-22_diary/">免费 JetBrains 全家桶</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/15/DataWarehouse_design-basic/">数据仓库设计基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/15/Git_Cheat-Sheet/">Git Cheat Sheet</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/15/Docker&K8S_Cheat-Sheet/">Docker & K8S Cheat Sheet</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/15/2020-02-15_diary/">疫情过后最想做的事</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/06/Python_async-programming/">Python 异步编程总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/03/JVM_jstat-monitor-analysis/">JVM jstat 监控分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">YWH's Studio.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-nietzsche"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>