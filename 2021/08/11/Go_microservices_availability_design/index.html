<!DOCTYPE html>
<html lang="en">
    <!-- title -->




<!-- keywords -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="Kylo Yip">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Kylo Yip">
	
	<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="/live2d-widget/autoload.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
	
    
    <meta name="keywords" content="Kylo's Notebook,Kylo Yip">
    
    <meta name="description" content="">
    <meta name="description" content="系统的可用性设计，主要包括隔离、超时、限流、降级、重试、负载均衡等方面。">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务可用性设计">
<meta property="og:url" content="https://yipwinghong.github.io/2021/08/11/Go_microservices_availability_design/index.html">
<meta property="og:site_name" content="Kylo&#39;s Notebook">
<meta property="og:description" content="系统的可用性设计，主要包括隔离、超时、限流、降级、重试、负载均衡等方面。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_microservices_availability_design.assets/image-20210808160550587.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_microservices_availability_design.assets/image-20210809150151913.png">
<meta property="article:published_time" content="2021-08-11T13:42:39.000Z">
<meta property="article:modified_time" content="2021-08-11T15:40:30.619Z">
<meta property="article:author" content="Kylo Yip">
<meta property="article:tag" content="技术">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_microservices_availability_design.assets/image-20210808160550587.png">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    
    <title>微服务可用性设计 · Kylo&#39;s Notebook</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= "/css/style.css?v=20210204" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= "/css/mobile.css?v=20210204" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/favicon.ico" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js?v=20210204" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    <script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/js/all.min.js"  data-auto-replace-svg="nest" ></script>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Kylo's Notebook" type="application/atom+xml">
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <!-- top read progress line -->
    <div class="header-element">
        
        <div class="read-progress"></div>
        
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        
        <div class="header-sidebar-menu header-sidebar-menu-rounded">
        
            
            <i class="fas fa-bars"></i>
            
        </div>
    </div>
    <!-- back to home page text -->
    <a class="home-link header-element" href=/>Kylo's Notebook</a>
    <!-- toggle banner for post layout -->
    
    
    <div class="banner">
    
        <div class="blog-title header-element">
            <a href="/" >Kylo&#39;s Notebook</a>
        </div>
        <div class="post-title header-element">
            <a href="#" class="post-name">微服务可用性设计</a>
        </div>
    </div>
    
</header>
    
<footer class="footer-fixed">

    <!-- back to top button -->
    <div class="footer-fixed-element">
        
        <div class="back-top back-top-rounded">
        
            
            <i class="fas fa-chevron-up"></i>
            
        </div>
    </div>
</footer>
    <div class="wrapper">
        <div class="site-intro" style="







height:100vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(https://api.ixiaowai.cn/mcapi/mcapi.php)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            微服务可用性设计
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "技术">技术</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "Go">Go</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "微服务">微服务</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">6.6k</span>Reading time: <span class="post-count reading-time">23 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2021/08/11</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h1 id="微服务可用性设计"><a href="#微服务可用性设计" class="headerlink" title="微服务可用性设计"></a>微服务可用性设计</h1><p>从单体架构到微服务架构，系统的复杂度变高。因此要接受系统出错的情况变得更频繁的现实，而由局部故障引起连锁反应的情况尤其需要重视。总的来说是要做到：</p>
<ul>
<li><p>变更管理：大多数问题是由变更引起的，出错首先考虑回滚。</p>
</li>
<li><p>避免过载：过载保护（卸载部分流量）、流量调度（多集群）等。</p>
</li>
<li><p>依赖管理：任何依赖都可能故障，需要做注入故障测试（chaos monkey testing）。</p>
</li>
<li><p>优雅降级：提供有损服务，避免核心链路依赖故障。</p>
</li>
<li><p>重试退避：结合退避算法和冻结时间，API retry detail 控制策略。</p>
</li>
<li><p>超时控制：结合进程内 + 服务间实现超时控制。</p>
</li>
<li><p>极限压测 + 故障演练：持续加压，观察服务在高负载时的表现（而不仅是能否支撑）。</p>
</li>
<li><p>扩容 + 重启 + 消除有害流量。</p>
</li>
</ul>
<h2 id="隔离设计"><a href="#隔离设计" class="headerlink" title="隔离设计"></a>隔离设计</h2><p>本质上是对系统或资源进行分割，从而实现当系统发生故障时能限定传播范围和影响范围，即发生故障后只有出问题的服务不可用，保证其他服务仍然可用。</p>
<p>没有考虑隔离可能出现的问题：</p>
<ul>
<li><p>转码集群被超大视频资源攻击，导致转码大量延迟。</p>
</li>
<li><p>缩略图服务，被大图实时缩略耗尽所有 CPU，导致正常缩略小图被丢弃。</p>
</li>
<li><p>数据库实例 cgroup 未隔离，导致大 SQL 引起集体故障。</p>
</li>
<li><p>INFO 日志量过大，导致异常 ERROR 日志采集延迟。</p>
</li>
</ul>
<h3 id="服务隔离"><a href="#服务隔离" class="headerlink" title="服务隔离"></a>服务隔离</h3><p><strong>动静隔离</strong>：小到 CPU 的 cacheline false sharing、数据库表设计中为避免 buffer pool 频繁过期隔离动静表，大到架构设计中的图片、静态资源等缓存加速，本质上都体现动静隔离的思路，即加速/缓存访问变换频次小的资源。比如 CDN 场景中，将静态资源和动态 API 分离。</p>
<ul>
<li><p>通过 CDN 访问静态文件，降低应用服务器负载。</p>
</li>
<li><p>对象存储存储费用最低。</p>
</li>
<li><p>海量存储空间，无需考虑存储架构升级。</p>
</li>
<li><p>静态 CDN 带宽加速，延迟低。</p>
</li>
</ul>
<p><strong>读写分离</strong>：MySQL BufferPool 用于缓存 DataPage（缓存表的行），如果频繁更新 DataPage 会不断置换，导致命中率下降。所以在表设计时可沿用类似的思路，分离主表和统计表，减少主表更新而更多地更新统计表。即便在上游 Cache 未命中而透穿到 MySQL，仍然能利用上 BufferPool 的缓存。</p>
<blockquote>
<p>  主从、Replicaset、CQRS，都是读写分离的思路。</p>
</blockquote>
<h3 id="轻重隔离"><a href="#轻重隔离" class="headerlink" title="轻重隔离"></a>轻重隔离</h3><p><strong>核心隔离</strong>：业务根据不同等级进行资源池划分（L0/L1/L2），根据核心/非核心的故障域的差异隔离（机器资源、依赖资源）；部署多集群（使用子集算法选取部分连接进行 RPC 建联），通过冗余资源来提升吞吐和容灾能力。</p>
<p><strong>快慢隔离</strong>：服务吞吐类似蓄水池，当出现洪流时需要一定时间才能排放完，此时其他支流在池中停留的时间取决于前面的排放能力，耗时就会增加，从而对小请求产生延迟上的影响。比如在日志传输体系架构设计中，如果整个流都投放到单个 Kafka topic 中（实现更好的顺序 IO），流内区分不同的 logid、发送到指定的 sink 端（ES、HDFS deng1），则会出现差速（即消费能力的差异，比如 HDFS 抖动吞吐下降，ES 正常水位，全局数据就会整体反压），最终整体吞吐能力就被最慢的一端拉低。因此可以按照各种纬度隔离：sink、部门、业务、logid、重要性（S/A/B/C）等。而且业务日志也属于某个 logid，日志等级可以作为隔离通道。</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_microservices_availability_design.assets/image-20210808160550587.png" alt="image-20210808160550587" style="zoom: 67%;" /></p>
<p><strong>热点隔离</strong>：热点即经常访问的数据，比如统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行缓存。</p>
<ul>
<li><p>小表广播：从 remote cache 提升为 local cache，app 定时更新；甚至可让运营平台支持广播刷新 local cache。</p>
</li>
<li><p>主动预热：比如某些页面高在线率情况下通过 bypass 监控主动防御。</p>
</li>
</ul>
<h3 id="物理隔离"><a href="#物理隔离" class="headerlink" title="物理隔离"></a>物理隔离</h3><p><strong>线程隔离</strong>：主要通过线程池隔离（也是实现服务隔离的基础）。把业务分类并交给不同的线程池处理，当某个线程池处理某种业务请求发生问题时，不会将故障扩散和影响到其他线程池，保证服务可用。</p>
<blockquote>
<p>  正常调用不受影响，一旦出现故障、线程池的使用达到 maxSize，再次请求接口会触发 fallback 处理并进行熔断（除此之外还可以基于信号量）。</p>
<p>  对于 Go 而言所有 I/O 都是非阻塞且托管给 Runtime 的，因此只会阻塞 Goroutine、不阻塞底层线程（协程被阻塞时，线程与协程解绑）。因此只需要考虑对 Goroutine 总量的控制，不需要考虑语言层面的线程隔离。</p>
<p>  限制 Goroutine 的总量，可参考 <strong>自适应限流</strong>。</p>
</blockquote>
<p><strong>进程隔离</strong>：比如基于虚拟化和容器化的编排（KVM、Docker Swarm、Kubernetes）。</p>
<p><strong>集群隔离</strong>：配置多套集群，在逻辑上是同一个应用，而在物理上部署多套、通过 cluster 区分（region.zone.cluster.appid）。</p>
<h2 id="超时控制"><a href="#超时控制" class="headerlink" title="超时控制"></a>超时控制</h2><p>超时控制本质上是快速失败（Failfast），以免等待断开的实例直到超时，引起连锁故障。</p>
<p>挂起的请求和无响应浪费资源、降低用户体验，比如：</p>
<ul>
<li><p>SLB 入口 Nginx 没配置超时导致连锁故障。</p>
</li>
<li><p>服务依赖数据库连接池漏配超时导致请求阻塞，最终服务集体 OOM。</p>
</li>
<li><p>下游服务发版耗时增加，而上游服务配置超时过短，导致请求失败。</p>
</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                             <span class="keyword">Reset</span> ReadTimeout</span><br><span class="line">[<span class="keyword">Start</span>] —&gt; [<span class="keyword">Connect</span>] -&gt; [<span class="keyword">Write</span>] -&gt; [<span class="keyword">Read</span>] -&gt; [<span class="keyword">End</span>]</span><br><span class="line">                  <span class="keyword">Reset</span> WriteTimeout</span><br></pre></td></tr></table></figure>
<p>良好的超时策略应尽可能避免服务堆积请求，尽快清空高延迟的请求、释放 Goroutine。服务互相调用，在延迟叠加前应注意防止超时操作。</p>
<ul>
<li><p>关注网路传递的不确定性。</p>
</li>
<li><p>客户端和服务端要设置一致的超时策略。</p>
</li>
<li><p>设置合适的默认值（比如内网 RPC 不能超过 100ms、公网 1s）。</p>
</li>
<li><p>高延迟服务导致客户端浪费资源等待。</p>
</li>
</ul>
<h3 id="超时策略"><a href="#超时策略" class="headerlink" title="超时策略"></a>超时策略</h3><p>超时设置不当会造成问题：不清楚依赖的微服务超时策略，或随着业务迭代耗时变化，意外导致依赖者出现超时。</p>
<p>服务提供者应定义好 latency SLO、更新到 gRPC Proto 定义中，在后续迭代中应保证该 SLO。</p>
<ul>
<li><p>在 kit 基础库配置默认超时兜底，配置防御保护，避免出现过大的超时策略。</p>
</li>
<li><p>配置中心设置公共模版，对于未配置的服务统一使用公共配置。</p>
</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> google.example.library.v1;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">LibraryService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Lagency SLO: 95th in 100ms, 99th in 150ms.</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> CreateBook(CreateBookRequest) <span class="keyword">returns</span> (Book)</span>; </span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetBook(GetBookRequest) <span class="keyword">returns</span> Book)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> ListBooks(ListBooksRequest) <span class="keyword">returns</span> (ListBooksResponse)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如何运用好超时监控？</p>
<ul>
<li><p>双峰分布：比如 95% 的请求耗时在 100ms 内，5% 的请求可能永远不会完成（长超时）。</p>
</li>
<li><p>不能只看均值，应参考耗时分布统计，比如 95th，99th。</p>
</li>
<li><p>设置合理的超时（通常还要加上 ping、2~3 个 TTL 的时间），拒绝超长请求，或当服务端不可用要主动失败。</p>
</li>
</ul>
<h3 id="超时传递"><a href="#超时传递" class="headerlink" title="超时传递"></a>超时传递</h3><p>指把当前服务剩余 quota 传递到下游服务中，继承超时策略，实现请求级别的全局超时控制（当上游服务已经超时返回错误，下游服务仍在执行，则会浪费资源）。</p>
<p>要使策略生效，应该取当前剩下的 quota 与配置超时策略的最小值，才是允许执行的时间。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">1s</span>   <span class="selector-tag">100ms</span></span><br><span class="line"><span class="selector-tag">----</span>&gt; <span class="selector-attr">[SvcA]</span> <span class="selector-tag">----</span>&gt; <span class="selector-attr">[Redis]</span> (left <span class="number">900ms</span>)</span><br><span class="line">           | <span class="selector-tag">500ms</span></span><br><span class="line">           +<span class="selector-tag">-----</span>&gt; <span class="selector-attr">[SvcB]</span> (left <span class="number">400ms</span>)</span><br><span class="line"><span class="selector-tag">350ms</span></span><br><span class="line"><span class="selector-tag">min</span>(<span class="attribute">config</span>: <span class="number">500ms</span>, <span class="attribute">left</span>: <span class="number">400ms</span>)</span><br></pre></td></tr></table></figure>
<p><strong>进程内超时控制</strong>：请求在每个阶段开始前就要检查是否有足够的时间来处理，以及继承该超时策略（可使用 Go 标准库 <code>context.WithTimeout</code>）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *asiiConn)</span> <span class="title">Get</span><span class="params">(ctx context.Context, key <span class="keyword">string</span>)</span> <span class="params">(result *Item, err error)</span></span> &#123;</span><br><span class="line">	c.conn.SetWriteDeadline(shrinkDeadline(ctx, c.writeTimeout))</span><br><span class="line">	<span class="keyword">if</span> _, err = fmt.Fprintf(c.rw, <span class="string">&quot;gets %s\r\n&quot;</span>, key); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在传递到某个环节发现剩余时间小于超时时间，应马上取消传递。在需要强制执行时，下游服务可覆盖上游超时传递和配额。</p>
<blockquote>
<p>  gRPC 框架依赖 gRPC Metadata Exchange，基于 HTTP2 的 Headers 传递 grpc-timeout 字段，自动传递到下游，构建带 timeout 的 context。</p>
<p>  只有确保服务能运行，后续的限流、熔断、降级才有机会生效。</p>
</blockquote>
<h2 id="过载保护"><a href="#过载保护" class="headerlink" title="过载保护"></a>过载保护</h2><h3 id="静态限流"><a href="#静态限流" class="headerlink" title="静态限流"></a>静态限流</h3><p><strong>令牌桶算法</strong>：设置固定容量存放令牌的桶，按照固定速率往桶里添加令牌（/x/time/rate）。</p>
<ul>
<li><p>比如限制 2req/s，则以 500ms 的速率往桶中添加令牌。</p>
</li>
<li><p>桶中最多存放 b 个令牌，在桶满时新添加的令牌被丢弃。</p>
</li>
<li><p>当某 n 字节大的数据包到达，从桶中删除 n 个令牌，并允许发送数据包。</p>
</li>
<li><p>如果桶中令牌不足 n 个，则不会删除令牌，该数据包被限流处理（丢弃或进入缓冲区等待）。</p>
</li>
</ul>
<p><strong>漏桶算法</strong>：固定容量的漏桶作为计量工具，可用于流量整形或可以用于流量整形（/go.uber.org/ratelimit）。</p>
<ul>
<li><p>按固定速率流出水滴（为空则没有流出）。</p>
</li>
<li><p>允许以任意速率把水滴加入漏桶，超过桶容量时则丢弃。</p>
</li>
</ul>
<p>思路都是设定指标，在超过该指标后则阻止或减少流量进入，当系统负载降低到某一水平后再恢复。这些策略相对被动、难以适应流量变化，实际效果取决于阈值设置的合理性：</p>
<ul>
<li><p>当集群增减机器要重新设置限流阈值。</p>
</li>
<li><p>考虑设置限流阈值的依据。</p>
</li>
<li><p>考虑如何降低人力运维成本。</p>
</li>
<li><p>在调用方反馈故障后设置限流，但错过流量高峰再评估则没有意义。</p>
</li>
</ul>
<h3 id="自适应限流"><a href="#自适应限流" class="headerlink" title="自适应限流"></a>自适应限流</h3><p><strong>过载保护</strong>：计算系统临近过载时的峰值吞吐量，作为限流阈值来进行流量控制，实现系统保护。在系统稳定时可保持吞吐量，当临近过载则主动抛弃一定量的负载以自保。常见做法：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Little%27s_law">利特尔法则</a>：在服务高峰时测量 QPS * latency，表示系统最大吞吐量。</p>
</li>
<li><p>CPU、内存作为信号量进行节流。</p>
</li>
<li><p>队列管理：队列长度、LIFO。</p>
</li>
<li><p>可控延迟算法：CoDel。</p>
</li>
</ul>
<p>考虑接近峰值时的系统吞吐：</p>
<ul>
<li><p>CPU：使用独立的线程采样，每隔 250ms 触发一次测量，计算均值时使用滑动平均去除峰值的影响。</p>
</li>
<li><p>Inflight：当前线上服务中进行请求的计量：比如设置一个共享变量，每接入一个请求数值 +1，处理完成 -1。</p>
</li>
<li><p>Pass&amp;RT: 比如最近 5s，pass 为每 100ms 采样窗口内成功请求的数量，rt 为单个采样窗口中平均响应时间。</p>
</li>
</ul>
<p>具体做法：</p>
<ul>
<li>使用 CPU 滑动均值（如 CPU &gt; 800）作为启发阈值，一旦触发则进入过载保护：<code>pass * rt &lt; inflight</code>。</li>
<li>限流生效后 CPU 会在临界值（800）附近抖动。如果不使用冷却时间，短时间的 CPU 下降就可能导致大量请求被放行，严重时迅速占满 CPU。</li>
<li>设置冷却时间，在冷却后重新判断阈值（CPU &gt; 800 ），再决定是否持续进入过载保护。</li>
<li>合理的过载保护应该是无论接入多大压力，放行的请求数量都是恒定、延迟都是稳定的。</li>
</ul>
<h2 id="限流设计"><a href="#限流设计" class="headerlink" title="限流设计"></a>限流设计</h2><p>指在一段时间内，定义某个客户端或应用可接收或处理多少个请求。通过限流可以过滤产生流量峰值的客户端或微服务，或确保应用程序在自动扩展失效前不会出现过载的情况。由于拒绝请求也有成本，不能无限制地接入、然后拒绝（过载保护），因此必须引入限流。</p>
<p>缺少限流措施：</p>
<ul>
<li><p>二层缓存穿透、大量回源导致的核心服务故障。</p>
</li>
<li><p>异常客户端引起的服务故障：请求放大或资源数放大。</p>
</li>
<li><p>用户重试导致的大面积故障。</p>
</li>
<li><p>…</p>
</li>
</ul>
<p>设计难点：</p>
<ul>
<li><p>令牌桶、漏桶算法仅针对单个节点，无法实现分布式限流。</p>
</li>
<li><p>根据 QPS 限流：不同的请求可能需要不同数量的资源处理；某种静态 QPS 限流不太准确。</p>
</li>
<li><p>要为每个租户设置限制：全局过载发生时针对某些异常进行控制，且可能出现配额超售。</p>
</li>
<li><p>可根据优先级丢弃请求（不容易实现）。</p>
</li>
<li><p>要考虑拒绝请求的成本。</p>
</li>
</ul>
<h3 id="分布式限流"><a href="#分布式限流" class="headerlink" title="分布式限流"></a>分布式限流</h3><p>目的是控制某个应用全局的流量，而非只对单个节点处理。</p>
<p>最简单的思路是使用 Redis，但存在以下问题：</p>
<ul>
<li><p>单个大流量的接口，Redis 本身容易成为热点。</p>
</li>
<li><p>pre-request 模式产生高频的网络往返，对性能有一定影响。</p>
</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                                 判断超限</span><br><span class="line">                                 +------------&gt; <span class="selector-attr">[限制算法模块]</span></span><br><span class="line">                                 ↓         逐条上报汇总</span><br><span class="line"><span class="selector-attr">[req1]</span><span class="selector-attr">[req2]</span>...<span class="selector-attr">[reqn]</span> ----&gt; <span class="selector-attr">[计数控制模块]</span> &lt;-----------&gt; <span class="selector-attr">[Redis]</span></span><br><span class="line">                                 ↑</span><br><span class="line">                                 +------------- <span class="selector-attr">[配置模块]</span></span><br><span class="line">                                 规则匹配</span><br></pre></td></tr></table></figure>
<p>可以从获取单个速率 quota 升级为批量 quota，在本地使用令牌桶算法限制。</p>
<ul>
<li><p>每次接收服务心跳后异步批量获取 quota，减少请求 Redis 的频次，获取后在本地消费，基于令牌桶实现拦截。</p>
</li>
<li><p>如果每次申请的 quota 是静态值则不够灵活（数值过大容易产生饥饿，过小则不够用）。可在最初使用时指定默认值，保留历史窗口数据，再基于窗口数据发起 quota 请求。</p>
</li>
</ul>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">                               ↑ 丢弃或等待</span><br><span class="line">                               |       放行</span><br><span class="line"><span class="comment">[req1]</span><span class="comment">[req2]</span>...<span class="comment">[reqn]</span> ----&gt; <span class="comment">[拦截器]</span> -------&gt; </span><br><span class="line">                             ↑   |</span><br><span class="line">                             |   +--------+ 反馈统计信息</span><br><span class="line">                             |            ↓</span><br><span class="line">                    异步更新  +-----&gt; <span class="comment">[算法分配调度]</span> &lt;--- <span class="comment">[配额管理]</span></span><br><span class="line">              （每秒增加 n 个令牌）</span><br></pre></td></tr></table></figure>
<p>基于单个节点按需申请要避免不公平，可基于 <strong>最大最小公平分享</strong>（Max-Min Fairness）分配资源：分配给每个用户想要的、可以满足的最小需求，并将没有使用的资源均匀分配给需要大资源的用户。其定义如下：</p>
<ul>
<li><p>按照资源需求递增的顺序进行分配。</p>
</li>
<li><p>不存在用户得到的资源超过自身需求。</p>
</li>
<li><p>未被满足的用户等价的分享资源。</p>
</li>
</ul>
<p>假设每次分配 10 个资源给四个节点，其各自需求如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>A (2)</th>
<th>B (2.6)</th>
<th>C (4)</th>
<th>D (5)</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>第一次</td>
<td>2.5</td>
<td>2.5</td>
<td>2.5</td>
<td>2.5</td>
<td>初次平均分配：10/4</td>
</tr>
<tr>
<td>第二次</td>
<td>2</td>
<td>2.666</td>
<td>2.666</td>
<td>2.666</td>
<td>A 只需要 2，因此多出 0.5 分给其它：<br />(2.5-2)/3 + 2.5</td>
</tr>
<tr>
<td>第三次</td>
<td>2.6</td>
<td>2.7</td>
<td>2.7</td>
<td>2.7</td>
<td>为避免饥饿，之后按此方案都如此分配。</td>
</tr>
</tbody>
</table>
</div>
<p>各种限流措施对比：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>类型</th>
<th>优点</th>
<th>缺点</th>
<th>现有实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>单机限制</td>
<td>实现简单<br />稳定可靠<br />性能高</td>
<td>流量不均匀会引发错误<br />机器数量变化时，需要手动调整配额</td>
<td>多数语言都提供相应实现</td>
</tr>
<tr>
<td>动态限制</td>
<td>根据服务情况动态限流<br />无需调整额度</td>
<td>需要主动收集性能数据<br />要实现客户端主动善意限流<br />只限于接口调用，应用场景较少</td>
<td>BBR 限流（各种连接池）</td>
</tr>
<tr>
<td>全局限制</td>
<td>流量不均不会误触发限流<br />机器数量变动时无需调整<br />应用场景丰富，任何资源都能使用</td>
<td>实现较复杂<br />需要手动配置</td>
<td>无</td>
</tr>
</tbody>
</table>
</div>
<h3 id="重要性"><a href="#重要性" class="headerlink" title="重要性"></a>重要性</h3><p>如果每个接口配置阈值会导致运营工作繁重，按服务级别配置则粒度太粗。最简单做法是配置服务级别 quota，更细粒度则根据不同重要性设定 quota，因此引入重要性（criticality）:</p>
<ul>
<li><p><strong>最重要</strong>（CRITICAL_PLUS）：最终的要求预留类型，拒绝这些请求会造成严重的用户可见性问题。</p>
</li>
<li><p><strong>重要</strong>（CRITICAL）：生产任务的默认请求类型。拒绝这些请求也会造成用户可见性问题（次重要）。</p>
</li>
<li><p><strong>可丢弃</strong>（SHEDDABLE_PLUS）：可容忍某种程度不可用性，是批量任务的默认请求类型，通常可以过几分钟、几小时后重试。</p>
</li>
<li><strong>可丢弃</strong>（SHEDDABLE）：可能会经常遇到部分不可用、偶尔会完全不可用的情况。</li>
</ul>
<p>gRPC 系统之间需要自动传递重要性信息：如果后端接收请求 A，在处理过程中发出请求 B 和 C 给其他后端，则这些请求会使用与 A 相同的重要性属性。</p>
<ul>
<li><p>全局配额不足时优先拒绝较低优先级的。</p>
</li>
<li><p>全局配额可按重要性分别设置。</p>
</li>
<li><p>过载保护时低优先级请求先被拒绝。</p>
</li>
</ul>
<h3 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h3><p>虽然使用超时限制操作的持续时间，防止挂起操作并保证系统响应，但由于环境是高度动态变化的，几乎不可能确定准确的、每种情况下都能正常工作的时间限制。</p>
<p>当服务依赖的资源出现大量错误或某用户超过资源配额时，后端任务会快速拒绝请求、返回配额不足的错误。但由于拒绝回复仍然会消耗一定资源，有可能导致后端忙于发送拒绝请求导致过载。</p>
<p>断路器（Circuit Breakers）：在客户端侧保护下游服务，阻止重复的故障，避免导致雪崩效应使整个系统崩溃。其一般有三个状态：</p>
<ul>
<li><p><strong>关闭</strong>（CLOSED）：默认状态，远程请求会真正发送给服务提供者。此后持续监视远程请求的数量和执行结果，决定是否要进入 OPEN 状态。</p>
</li>
<li><p><strong>开启</strong>（OPEN）：此时不会进行远程请求，直接给服务调用者返回调用失败信息，以实现快速失败策略。转变为 OPEN 的条件：</p>
<ul>
<li><p>一段时间内请求数量达到一定阈值（比如 10s、20 个请求）。即如果请求本身很少就无需断路器介入。</p>
</li>
<li><p>一段时间内（比如 10 秒）请求的故障率（发生失败、超时、拒绝的统计比例）到达一定阈值（比如 50%）。即如果请求本身能正确返回就不用断路器介入。</p>
</li>
</ul>
</li>
<li><p><strong>半开启</strong>（HALF OPEN）：断路器必须带有自动故障恢复能力，进入 OPEN 状态一段时间后，将自动（下次请求触发）切换到该状态。先放行一次远程调用，根据调用结果转换为 CLOSED 或 OPEN 状态，以实现断路器的弹性恢复。</p>
</li>
</ul>
<h4 id="Gutter"><a href="#Gutter" class="headerlink" title="Gutter"></a>Gutter</h4><p>基于 Failover 思路解决可用性问题很普遍，但是完整的 Failover 需要翻倍的机器资源，在平时不接收流量时造成资源浪费；而且高负载情况下接管流量也不一定能完整接住。</p>
<p>基于熔断的 Gutter Kafka 用于接管自动修复系统运行过程中的负载，只需要付出 10% 的资源就能解决部分系统可用性问题。利用熔断的思路把抛弃的流量转移到 Gutter 集群，Gutter 也接不住的流量再重新回抛到主集群（最大力度接收）。</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_microservices_availability_design.assets/image-20210809150151913.png" alt="image-20210809150151913" style="zoom:80%;" /></p>
<h3 id="客户端流控"><a href="#客户端流控" class="headerlink" title="客户端流控"></a>客户端流控</h3><p>一般客户端总是会积极重试，访问一个不可达的服务。要实现流控：</p>
<ul>
<li><p>客户端需要限制请求频次，做一定的请求退让（retry backoff）。</p>
</li>
<li><p>可通过接口级别的 error_details，挂载到每个 API 的响应。</p>
</li>
</ul>
<h2 id="降级设计"><a href="#降级设计" class="headerlink" title="降级设计"></a>降级设计</h2><p>通过降级回复可减少工作量，或丢弃不重要的请求，保障用户体验。通常需要有能力区分不同的请求、了解可以降级的流量（比如降低回复质量来减少回复所需的计算量或时间）。</p>
<p>缺少降级措施的例子：</p>
<ul>
<li><p>客户端解析协议失败，app 奔溃。</p>
</li>
<li><p>客户端部分协议不兼容，导致页面失败。</p>
</li>
<li><p>local cache 数据源缓存，发版失效 + 依赖接口故障，引起白屏。</p>
</li>
<li><p>没有 playbook，导致的 MTTR 上升。</p>
</li>
</ul>
<p>需要考虑：</p>
<ul>
<li><p>流量评估和优雅降级的决定性指标（CPU、延迟、队列长度、线程数量、错误等）。</p>
</li>
<li><p>进入降级模式时需要执行的动作。</p>
</li>
<li><p>一般在 BFF 层处理，如果由底层服务提供降级、上层再基于低质量数据做缓存会造成污染。</p>
</li>
<li><p>优雅降级只在容量规划失误或出现意外的负载时触发，不应频繁出现。</p>
</li>
<li><p>充分的测试演练，平时不会触发和使用代码，需要定期针对一小部分流量进行演练，保证功能正常。</p>
</li>
<li><p>足够简单。</p>
</li>
</ul>
<p>降级的本质是提供有损的服务：</p>
<ul>
<li><p>模块化 UI ，对非核心模块降级。</p>
</li>
<li><p>页面上次缓存副本。</p>
</li>
<li><p>设置默认值、热门推荐等。</p>
</li>
<li><p>流量拦截 + 定期数据缓存（过期副本策略）。</p>
</li>
</ul>
<p>一般处理方法：</p>
<ul>
<li><p>页面降级、延迟服务、写/读降级、缓存降级。</p>
</li>
<li><p>抛出异常、返回约定协议、Mock 数据、Fallback 处理。</p>
</li>
</ul>
<h2 id="重试设计"><a href="#重试设计" class="headerlink" title="重试设计"></a>重试设计</h2><p>当请求返回错误（比如配额不足、超时、内部错误等），对于后端部分节点过载的情况，倾向于立刻重试（前提是该错误是否可以通过重试解决，比如鉴权失败则没有必要反复重试）。</p>
<p>首先应确保接口幂等性：</p>
<ul>
<li><p>遵循 RESTful 的通用原则，一般只有 POST 是非幂等。</p>
</li>
<li><p>全局唯一 ID：根据业务生成全局唯一 ID，在调用接口时会传入。接口提供方从存储系统中去检索该 ID 是否存在，如果存在则说明操作已经执行过，将拒绝本次服务请求；否则接收服务请求并将 ID 存入存储系统中，之后包含相同业务 ID 参数的请求将被拒绝。</p>
</li>
<li><p>去重表：适用于在业务中有唯一标识的插入场景。比如一个订单只能支付一次，可建立将订单 ID 作为唯一索引的去重表。在一个事务中完成支付和去重操作，当出现重复支付时抛出唯一约束异常，操作回滚。</p>
</li>
<li><p>多版本并发控制：适合对更新请求作幂等性控制。比如在更新接口中增加版本号实现幂等性控制。</p>
</li>
</ul>
<p>留意流量放大：</p>
<ul>
<li><p>限制重试次数和基于重试分布的策略（重试比率：10%）。</p>
</li>
<li><p>随机化、指数型递增的重试周期：exponential ackoff + jitter。</p>
</li>
<li><p>客户端记录重试次数直方图，传递到服务端进行分布判定，交由服务端判定拒绝。</p>
</li>
<li><p>只在主路逻辑的关键服务上进行重试，非关键服务不建议首选重试，尤其不应同步重试。</p>
</li>
<li><p>只应在失败层次进行重试，当重试仍然失败，返回全局约定错误码以避免级联重试。</p>
</li>
</ul>
<p>重试要有明确的终止条件：</p>
<ul>
<li><p>超时终止：重试模式更应配合超时机制使用，否则可能对系统有害。</p>
</li>
<li><p>次数终止：不能无限制，一般只重试 2 至 5 次（可结合退避策略），或重试请求只占所有请求较小的比例。</p>
</li>
</ul>
<p>重试设计不当的例子：</p>
<ul>
<li><p>Nginx upstream retry 过大，导致服务雪崩。</p>
</li>
<li><p>业务不幂等，重试导致数据重复。</p>
</li>
<li><p>多层级重试传递，放大流量引起雪崩。</p>
</li>
</ul>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>特指数据中心内部的负载均衡。在理想情况下，某个服务的负载会完全均匀地分发给所有后端任务，在任何时刻节点消耗同样数量的 CPU。目标是实现：</p>
<ul>
<li><p>均衡的流量分发。</p>
</li>
<li><p>可靠地识别异常节点。</p>
</li>
<li><p>scale-out，增加同质节点扩容。</p>
</li>
<li><p>减少错误，提高可用性。</p>
</li>
</ul>
<p>有时 backend 之间的负载差异较大，一般是使用 JSQ（最闲轮询）算法、缺乏服务端全局视图带来的问题：</p>
<ul>
<li><p>每个请求的处理成本不同。</p>
</li>
<li><p>物理机环境的差异：服务器本身很难强同质性，以及存在共享资源争用的情况（内存缓存、带宽、I/O 等）。</p>
</li>
<li><p>性能因素，比如 Java 的 FGC、JIT 等。</p>
</li>
</ul>
<p>因此目标需要综合考虑负载和可用性。参考《<a target="_blank" rel="noopener" href="http://www.eecs.harvard.edu/~michaelm/postscripts/tpds2001.pdf">The power of two choices in randomized load balancing</a>》，可采用 p2c 算法随机选取两个节点打分，选择更优的节点：</p>
<ul>
<li><p>考虑服务端指标（CPU 等）和客户端指标（health、inflight、latency 等），使用简单的线性方程进行打分。</p>
</li>
<li><p>对新启动的节点使用常量惩罚值（penalty），以及使用探针方式最小化放量，目的是预热。</p>
</li>
<li><p>对于打分较低的节点，为避免进入黑名单而无法恢复，要使用统计衰减的方式，让节点指标逐渐恢复到初始状态（默认值）。</p>
</li>
<li><p>当前发出的请求超过了 predict lagtency，就会增加惩罚。</p>
</li>
</ul>
<blockquote>
<p>  指标计算结合 moving average，使用时间衰减，计算 vt = v(t-1) * β + at * (1-β) 。</p>
<p>  其中 β 为若干次幂的倒数，即：Math.Exp((-span) / 600ms)。</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a target="_blank" rel="noopener" href="http://www.360doc.com/content/16/1124/21/31263000_609259745.shtml">大神讲解微服务治理的技术演进和架构实践 (360doc.com)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/basis-frameworkto-implement-micro-service/">实施微服务，我们需要哪些基础框架？-InfoQ</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/news/2017/04/linkerd-celebrates-one-year/">开源Linkerd项目庆祝一周年纪念日-InfoQ</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://netflixtechblog.com/netflix-edge-load-balancing-695308b5548c">Rethinking Netflix’s Edge Load Balancing | by Netflix Technology Blog | Netflix TechBlog</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAwNjQwNzU2NQ==&amp;mid=402841629&amp;idx=1&amp;sn=f598fec9b370b8a6f2062233b31122e0&amp;mpshare=1&amp;scene=23&amp;srcid=0404qP0fH8zRiIiFzQBiuzuU#rd">亿级Web系统的容错性建设实践 (qq.com)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIzMzk2NDQyMw==&amp;mid=2247486641&amp;idx=1&amp;sn=1660fb41b0c5b8d8d6eacdfc1b26b6a6&amp;source=41#wechat_redirect">阿里微服务之殇及分布式链路追踪技术原理 (qq.com)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.acolyer.org/2018/11/16/overload-control-for-scaling-wechat-microservices/">Overload control for scaling WeChat microservices | the morning paper (acolyer.org)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cs.columbia.edu/~ruigu/papers/socc18-final100.pdf">Overload Control for Scaling WeChat Microservices (columbia.edu)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki">Home · alibaba/Sentinel Wiki (github.com)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/okiwilldoit/article/details/81738782">分布式系统常见负载均衡算法<em>罗布泊coding-CSDN博客</em>负载均衡算法</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://alex-ii.github.io/notes/2019/02/13/predictive_load_balancing.html">Predictive Load-Balancing: Unfair But Faster &amp; More Robust by Steve Gury Talk | Little Big Engineer (alex-ii.github.io)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_38106113/article/details/81542863">深入解析TensorFlow中滑动平均模型与代码实现_Star_Platinum的博客-CSDN博客</a></p>
</li>
</ul>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    </article>
    <!-- license  -->
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/2021/08/27/DDIA_note-14/" title= "《DDIA》阅读笔记（十）：批处理系统">
                    <div class="nextTitle">《DDIA》阅读笔记（十）：批处理系统</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2021/08/10/Algorithm_reliable-distributed-timer/" title= "可靠的分布式计时器（译）">
                    <div class="prevTitle">可靠的分布式计时器（译）</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

    <div id="lv-container" data-id="city" data-uid= MTAyMC80ODYzMi8yNTEyNg==>
        <script type="text/javascript">
            (function (d, s) {
                var j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') { return; }
                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>

<!-- City版安装代码已完成 -->
    
    
     
    <!-- utteranc评论 -->

    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->

    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
</main>

            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:yipwinghong@outlook.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/yipwinghong" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                    
                    <img class="profile-qr" src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/WeChat.jpg" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="https://www.v2ex.com/member/yipwinghong" class="iconfont-archer v2ex" target="_blank" title=v2ex></a>
            
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:100vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8F%AF%E7%94%A8%E6%80%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">微服务可用性设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text">隔离设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%9A%94%E7%A6%BB"><span class="toc-number">1.1.1.</span> <span class="toc-text">服务隔离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%BB%E9%87%8D%E9%9A%94%E7%A6%BB"><span class="toc-number">1.1.2.</span> <span class="toc-text">轻重隔离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E9%9A%94%E7%A6%BB"><span class="toc-number">1.1.3.</span> <span class="toc-text">物理隔离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">超时控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E7%AD%96%E7%95%A5"><span class="toc-number">1.2.1.</span> <span class="toc-text">超时策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E4%BC%A0%E9%80%92"><span class="toc-number">1.2.2.</span> <span class="toc-text">超时传递</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E8%BD%BD%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.3.</span> <span class="toc-text">过载保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%99%90%E6%B5%81"><span class="toc-number">1.3.1.</span> <span class="toc-text">静态限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81"><span class="toc-number">1.3.2.</span> <span class="toc-text">自适应限流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E6%B5%81%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.4.</span> <span class="toc-text">限流设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">分布式限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%80%A7"><span class="toc-number">1.4.2.</span> <span class="toc-text">重要性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%86%94%E6%96%AD"><span class="toc-number">1.4.3.</span> <span class="toc-text">熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Gutter"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">Gutter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81%E6%8E%A7"><span class="toc-number">1.4.4.</span> <span class="toc-text">客户端流控</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.5.</span> <span class="toc-text">降级设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.</span> <span class="toc-text">重试设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.7.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.8.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
    </div>
    
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 81
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2021 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span><a class="archive-post-title" href= "/2021/09/12/DB_mysql-optimization-basic/" >MySQL 性能优化基础</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span><a class="archive-post-title" href= "/2021/09/05/DB_b-trees-more-than-i-thought-id-want-to-know/" >关于 B-Trees 的更多细节（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/27</span><a class="archive-post-title" href= "/2021/08/27/DDIA_note-16/" >《DDIA》阅读笔记（十二）：数据系统的未来</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/27</span><a class="archive-post-title" href= "/2021/08/27/DDIA_note-15/" >《DDIA》阅读笔记（十一）：流处理系统</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/27</span><a class="archive-post-title" href= "/2021/08/27/DDIA_note-14/" >《DDIA》阅读笔记（十）：批处理系统</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/11</span><a class="archive-post-title" href= "/2021/08/11/Go_microservices_availability_design/" >微服务可用性设计</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/10</span><a class="archive-post-title" href= "/2021/08/10/Algorithm_reliable-distributed-timer/" >可靠的分布式计时器（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/08</span><a class="archive-post-title" href= "/2021/08/08/Go_concurrency_primitives_2/" >Go 并发原语（二）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/04</span><a class="archive-post-title" href= "/2021/08/04/Go_engineering-standard/" >Go 工程化标准实践</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/31</span><a class="archive-post-title" href= "/2021/07/31/Go_memory-model/" >Go 内存模型（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/28</span><a class="archive-post-title" href= "/2021/07/28/Go_channel-applications/" >Go Channel 应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/25</span><a class="archive-post-title" href= "/2021/07/25/Fenix_build-services/" >《凤凰架构》阅读笔记（五）：服务构建与流量治理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/23</span><a class="archive-post-title" href= "/2021/07/23/Fenix_transparent-multilevel-diversion-system/" >《凤凰架构》阅读笔记（四）：透明多级分流系统</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/22</span><a class="archive-post-title" href= "/2021/07/22/Fenix_transaction/" >《凤凰架构》阅读笔记（三）：事务处理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/21</span><a class="archive-post-title" href= "/2021/07/21/Fenix_access-remote-service/" >《凤凰架构》阅读笔记（二）：访问远程服务</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/18</span><a class="archive-post-title" href= "/2021/07/18/Go_error_handling/" >Go 异常处理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/15</span><a class="archive-post-title" href= "/2021/07/15/Fenix_architecture-evolution/" >《凤凰架构》阅读笔记（一）：软件架构演进</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/12</span><a class="archive-post-title" href= "/2021/07/12/Go_microservices_governance/" >微服务概览与治理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/09</span><a class="archive-post-title" href= "/2021/07/09/Algorithm_max-flow-problem/" >最大流问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span><a class="archive-post-title" href= "/2021/07/08/Algorithm_minimum_spanning_tree_problem/" >最小生成树问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span><a class="archive-post-title" href= "/2021/07/08/Algorithm_shortest-path-problem/" >最短路径问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/01</span><a class="archive-post-title" href= "/2021/07/01/DistributedSystem_gossip-dissemination/" >分布式系统模式：Gossip 传播（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span><a class="archive-post-title" href= "/2021/06/23/DistributedSystem_versioned-value/" >分布式系统模式：版本化值（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/19</span><a class="archive-post-title" href= "/2021/06/19/Algorithm_consistent-hashing/" >一致性哈希（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/17</span><a class="archive-post-title" href= "/2021/06/17/Go_concurrency_primitives_1/" >Go 并发原语（一）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/13</span><a class="archive-post-title" href= "/2021/06/13/Go_cheat-sheet/" >Go Cheat Sheet</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span><a class="archive-post-title" href= "/2021/06/06/2021-06-06_diary/" >Weekly Summary (2021-05-31_2021-06-06)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/05</span><a class="archive-post-title" href= "/2021/06/05/2021-06-05_diary/" >基于记忆规律的学习方法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/31</span><a class="archive-post-title" href= "/2021/05/31/2021-05-31_diary/" >2021 下半年工作学习安排</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span><a class="archive-post-title" href= "/2021/05/16/Algorithm_how-to-solve-the-secret-santa-problem-using-graph-theory/" >如何用图论解决 Secret Santa 问题？（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span><a class="archive-post-title" href= "/2021/05/12/DB_using-postgresql-as-a-data-warehouse/" >把 PostgreSQL 用作数据仓库（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/28</span><a class="archive-post-title" href= "/2021/04/28/OS_linux-memory-monitoring/" >Linux 内存原理与分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/20</span><a class="archive-post-title" href= "/2021/04/20/OS_linux-io-monitoring/" >Linux I/O 原理与分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/10</span><a class="archive-post-title" href= "/2021/04/10/OS_linux-cpu-monitoring/" >Linux CPU 原理与分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span><a class="archive-post-title" href= "/2021/04/05/OS_linux-network-monitoring/" >Linux 网络原理与分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span><a class="archive-post-title" href= "/2021/04/01/OS_system_initialization/" >Linux - 架构与系统初始化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/17</span><a class="archive-post-title" href= "/2021/03/17/Java_cpp-for-java-programmers/" >Java 程序员的 C++（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span><a class="archive-post-title" href= "/2021/02/24/DDIA_note-13/" >《DDIA》阅读笔记（九）：一致性与共识（共识问题）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/21</span><a class="archive-post-title" href= "/2021/02/21/2021-02-21_diary/" >近期工作学习规划</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span><a class="archive-post-title" href= "/2021/02/19/DDIA_note-12/" >《DDIA》阅读笔记（九）：一致性与共识（顺序保证）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span><a class="archive-post-title" href= "/2021/02/13/DDIA_note-11/" >《DDIA》阅读笔记（九）：一致性与共识（可线性化）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span><a class="archive-post-title" href= "/2021/02/06/DDIA_note-10/" >《DDIA》阅读笔记（八）：分布式系统的挑战</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/27</span><a class="archive-post-title" href= "/2021/01/27/DDIA_note-9/" >《DDIA》阅读笔记（七）：事务</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/22</span><a class="archive-post-title" href= "/2021/01/22/DDIA_note-8/" >《DDIA》阅读笔记（六）：数据分区</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/21</span><a class="archive-post-title" href= "/2021/01/21/DDIA_note-7/" >《DDIA》阅读笔记（五）：数据复制（无主节点）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/20</span><a class="archive-post-title" href= "/2021/01/20/DDIA_note-6/" >《DDIA》阅读笔记（五）：数据复制（多主节点）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/10</span><a class="archive-post-title" href= "/2021/01/10/DB_right-database/" >选择合适的数据库（译）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/09</span><a class="archive-post-title" href= "/2021/01/09/DDIA_note-5/" >《DDIA》阅读笔记（五）：数据复制（单主节点）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/2021/01/01/DB_tree-table-design-summary/" >树形表结构设计总结</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/19</span><a class="archive-post-title" href= "/2020/12/19/DDIA_note-4/" >《DDIA》阅读笔记（四）：数据编码与演化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/13</span><a class="archive-post-title" href= "/2020/12/13/DDIA_note-3/" >《DDIA》阅读笔记（三）：数据存储与检索</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/04</span><a class="archive-post-title" href= "/2020/12/04/DDIA_note-2/" >《DDIA》阅读笔记（二）：数据模型与查询语言</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/02</span><a class="archive-post-title" href= "/2020/12/02/DDIA_note-1/" >《DDIA》阅读笔记（一）：可靠、可扩展与可维护的应用系统</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span><a class="archive-post-title" href= "/2020/10/08/Maven_external_dependencies_management/" >Maven 打包依赖外置</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/04</span><a class="archive-post-title" href= "/2020/10/04/JVM_prod-analysis-cmd/" >Java 应用常用调试分析方法总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span><a class="archive-post-title" href= "/2020/09/24/Kafka_cheat-sheet/" >Kafka Cheat Sheet</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/09</span><a class="archive-post-title" href= "/2020/08/09/Arthas_cheat-sheet/" >Arthas Cheat Sheet</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/12</span><a class="archive-post-title" href= "/2020/07/12/Java_override-and-bridge-method/" >Java 多态、重写与桥接方法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span><a class="archive-post-title" href= "/2020/06/30/JVM_java-memory-area/" >Java 内存区域</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span><a class="archive-post-title" href= "/2020/05/28/DB_data-warehouse-design-basic/" >数据仓库设计基础</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/08</span><a class="archive-post-title" href= "/2020/04/08/2020-04-08_diary/" >关于使用思维导图做笔记</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/28</span><a class="archive-post-title" href= "/2020/03/28/Algorithm_leetcode-high-frequency-problems/" >LeetCode 高频面试题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/06</span><a class="archive-post-title" href= "/2020/03/06/InfoSecty_personal-infomation-security-guide/" >個人信息安全保護指南</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/22</span><a class="archive-post-title" href= "/2020/02/22/2020-02-22_diary/" >免费 JetBrains 全家桶</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/16</span><a class="archive-post-title" href= "/2020/02/16/Nginx_cheat-sheet/" >Nginx Cheat Sheet</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span><a class="archive-post-title" href= "/2020/02/15/Git_cheat-sheet/" >Git Cheat Sheet</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span><a class="archive-post-title" href= "/2020/02/15/Docker&K8S_cheat-sheet/" >Docker & K8S Cheat Sheet</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/03</span><a class="archive-post-title" href= "/2020/02/03/JVM_jstat-monitor-analysis/" >JVM jstat 监控分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/01</span><a class="archive-post-title" href= "/2020/02/01/JVM_GC-log-analysis/" >JVM GC 日志分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span><a class="archive-post-title" href= "/2020/01/01/JVM_mindmap/" >Java 虚拟机与并发编程</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span><a class="archive-post-title" href= "/2019/12/05/Design_design-patterns/" >设计模式与设计原则</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/04</span><a class="archive-post-title" href= "/2019/10/04/Python_async-programming/" >Python 异步编程总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span><a class="archive-post-title" href= "/2019/09/19/Python_data-structure/" >Python 数据结构应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span><a class="archive-post-title" href= "/2019/09/13/Python_decorator/" >Python 装饰器基本用法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/22</span><a class="archive-post-title" href= "/2019/08/22/Python_OOP-summary/" >Python 类与对象总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span><a class="archive-post-title" href= "/2019/06/28/JavaScript_cheat-sheet/" >JavaScript Cheat Sheet</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href= "/2019/06/02/JavaScript_ES6-grammar/" >ES6 语法总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/30</span><a class="archive-post-title" href= "/2019/05/30/Vue_user-guide-4/" >Vue 学习笔记：前端路由、请求发送和状态管理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/24</span><a class="archive-post-title" href= "/2019/05/24/Vue_user-guide-3/" >Vue 学习笔记：组件</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/23</span><a class="archive-post-title" href= "/2019/05/23/Vue_user-guide-2/" >Vue 学习笔记（2）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/20</span><a class="archive-post-title" href= "/2019/05/20/Vue_user-guide-1/" >Vue 学习笔记（1）</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="杂事"><span class="iconfont-archer">&#xe606;</span>杂事</span>
    
        <span class="sidebar-tag-name" data-tags="技术"><span class="iconfont-archer">&#xe606;</span>技术</span>
    
        <span class="sidebar-tag-name" data-tags="算法"><span class="iconfont-archer">&#xe606;</span>算法</span>
    
        <span class="sidebar-tag-name" data-tags="Java"><span class="iconfont-archer">&#xe606;</span>Java</span>
    
        <span class="sidebar-tag-name" data-tags="数据库"><span class="iconfont-archer">&#xe606;</span>数据库</span>
    
        <span class="sidebar-tag-name" data-tags="大数据"><span class="iconfont-archer">&#xe606;</span>大数据</span>
    
        <span class="sidebar-tag-name" data-tags="设计"><span class="iconfont-archer">&#xe606;</span>设计</span>
    
        <span class="sidebar-tag-name" data-tags="分布式系统"><span class="iconfont-archer">&#xe606;</span>分布式系统</span>
    
        <span class="sidebar-tag-name" data-tags="Docker"><span class="iconfont-archer">&#xe606;</span>Docker</span>
    
        <span class="sidebar-tag-name" data-tags="Kubernetes"><span class="iconfont-archer">&#xe606;</span>Kubernetes</span>
    
        <span class="sidebar-tag-name" data-tags="Go"><span class="iconfont-archer">&#xe606;</span>Go</span>
    
        <span class="sidebar-tag-name" data-tags="信息安全"><span class="iconfont-archer">&#xe606;</span>信息安全</span>
    
        <span class="sidebar-tag-name" data-tags="Maven"><span class="iconfont-archer">&#xe606;</span>Maven</span>
    
        <span class="sidebar-tag-name" data-tags="Nginx"><span class="iconfont-archer">&#xe606;</span>Nginx</span>
    
        <span class="sidebar-tag-name" data-tags="Linux"><span class="iconfont-archer">&#xe606;</span>Linux</span>
    
        <span class="sidebar-tag-name" data-tags="OS"><span class="iconfont-archer">&#xe606;</span>OS</span>
    
        <span class="sidebar-tag-name" data-tags="Python"><span class="iconfont-archer">&#xe606;</span>Python</span>
    
        <span class="sidebar-tag-name" data-tags="Vue"><span class="iconfont-archer">&#xe606;</span>Vue</span>
    
        <span class="sidebar-tag-name" data-tags="前端"><span class="iconfont-archer">&#xe606;</span>前端</span>
    
        <span class="sidebar-tag-name" data-tags="Git"><span class="iconfont-archer">&#xe606;</span>Git</span>
    
        <span class="sidebar-tag-name" data-tags="微服务"><span class="iconfont-archer">&#xe606;</span>微服务</span>
    
        <span class="sidebar-tag-name" data-tags="JavaScript"><span class="iconfont-archer">&#xe606;</span>JavaScript</span>
    
        <span class="sidebar-tag-name" data-tags="MySQL"><span class="iconfont-archer">&#xe606;</span>MySQL</span>
    
        <span class="sidebar-tag-name" data-tags="Kafka"><span class="iconfont-archer">&#xe606;</span>Kafka</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="《数据密集型应用系统设计》阅读笔记"><span class="iconfont-archer">&#xe60a;</span>《数据密集型应用系统设计》阅读笔记</span>
    
        <span class="sidebar-category-name" data-categories="《凤凰架构》阅读笔记"><span class="iconfont-archer">&#xe60a;</span>《凤凰架构》阅读笔记</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "Kylo Yip"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>


