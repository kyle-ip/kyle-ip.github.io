<!DOCTYPE html>
<html lang="en">
    <!-- title -->


    

<!-- keywords -->



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Kyle Yip">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Kyle Yip">
    
        <meta name="keywords" content="Kyle's Notebook,Kyle Yip">
    
    <meta name="description" content="">
    <meta name="description" content="关于 Go 工程化与企业级应用开发的总结，持续更新中。">
<meta property="og:type" content="article">
<meta property="og:title" content="Go 工程化规范设计">
<meta property="og:url" content="https://yipwinghong.github.io/2021/12/10/Go_engineering-specification-design/index.html">
<meta property="og:site_name" content="Kyle&#39;s Notebook">
<meta property="og:description" content="关于 Go 工程化与企业级应用开发的总结，持续更新中。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/61b4d5da6c8327b738e9657c6c144000.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/1699f5c1933cfe72803dfb038152fc48.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/da69572c5605556b8144eb4ee281c4cb.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/89c618a7415c0c38b09d86d7f882a427.png">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/35/a7/3509bd169ce285f59fbcfa6ebea75aa7.png?wh=2513*1078">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/5f5a79a5d2bde029d4de9d98026ef3f2.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/5503ce60f7c2ae5d7628222a4d87cc07.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/1c0b08a1c9032c87c35b85de6ca6820b.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/fa611f83053afd77cf3ddf83561ba1d9.png">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/63/ea/63419f767c61c9580861b59445b90fea.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/94e521c6eb884096ea107fc4c36f30a3.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/1e32f9d8318c8968b50e9ea7e89bbe01.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/34617a68604b7b5613948f89230c7a42.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/79e517e6a7fd3882ce30320f28aa7088.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/e6ae61fc4b0fc821f94d257239f332ab.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/82ebe90b0490b9a2a76e2f302dd896ce.jpg">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/ab6ac57696c0e90cf82624f78a82333b.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/ddb314275ba1bab28413221bc56ac80f.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/9a290c28b0c238dd69e24dcc9f5c7ea3.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/40a1e20b153bb3ba1005cea4aefe62d5.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/81296e3f9f0f90e77dd771ee4f61b71b-163906708572615.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/137a2a20067d1472c9f00c6387a30857-163906712099217.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/37yy6e0896daa8f97883631624996388.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/e0a4d8ed5f3a6a8a4bc4035e261881b5.png">
<meta property="og:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/90ca527c2863fe642f9ab3d5b90fe980.png">
<meta property="article:published_time" content="2021-12-09T17:42:39.000Z">
<meta property="article:modified_time" content="2022-01-01T05:39:12.984Z">
<meta property="article:author" content="Kyle Yip">
<meta property="article:tag" content="技术">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/61b4d5da6c8327b738e9657c6c144000.png">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/favicon.ico">
    
    <title>Go 工程化规范设计 · Kyle&#39;s Notebook</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link rel="preload" href="/css/style.css?v=20211217" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/css/dark.css?v=20211217" as="style">
    <link rel="stylesheet" href="/css/dark.css">
    <link rel="stylesheet" href="/css/mobile.css?v=20211217" media="(max-width: 960px)">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js?v=20211217" as="script">
    <link rel="preload" href="/scripts/dark.js?v=20211217" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Kyle's Notebook" type="application/atom+xml">
</head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
    
        <body class="post-body">
    
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        
            <div class="header-sidebar-menu">
        
            
                <div style="padding-left: 1px;">&#xe775;</div>
            
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href=/>Kyle's Notebook</a>
        </span>
    </div>
    <!-- toggle banner for post layout -->
    
        
            <div class="banner">
        
            <div class="blog-title header-element">
                <a href="/">Kyle&#39;s Notebook</a>
            </div>
            <div class="post-title header-element">
                <a href="#" class="post-name">Go 工程化规范设计</a>
            </div>
        </div>
    
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- back to top button -->
    <div class="footer-fixed-element">
        
            <div class="back-top back-top-hidden">
        
        
            <div>&#xe639;</div>
        
        </div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="







    height:0vh;

">
    
    <!-- 主页  -->
    
        
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(https://api.ixiaowai.cn/mcapi/mcapi.php)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
                Go 工程化规范设计
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
                
            <!-- 404 -->
            
        </p>
        <!-- 文章页 meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
    
        <a class="post-tag" href="javascript:void(0);" data-tags="技术">技术</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags="Go">Go</a>
    
</div>

                
                
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">22.7k</span>Reading time: <span class="post-count reading-time">93 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2021/12/10</span>
                    <!-- busuanzi -->
                    
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h1 id="Go-工程化规范设计"><a href="#Go-工程化规范设计" class="headerlink" title="Go 工程化规范设计"></a>Go 工程化规范设计</h1><blockquote>
<p>  主要参考极客时间《Go 语言项目开发实战》规范设计。</p>
</blockquote>
<p>首先理解工程化规范包括的两方面：</p>
<ul>
<li><p>  非编码类规范：开源规范，文档规范，版本规范，Git 规范，发布规范，…</p>
</li>
<li><p>  编码类规范：目录规范，代码规范，接口规范，日志规范，错误码规范，…</p>
</li>
</ul>
<h2 id="开源规范"><a href="#开源规范" class="headerlink" title="开源规范"></a>开源规范</h2><p>主流的开源许可证：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/61b4d5da6c8327b738e9657c6c144000.png" alt="img"></p>
<p>开源项目应遵循：</p>
<ul>
<li><p>  高单元覆盖率。可确保第三方开发者在开发完代码后，能很方便地对整个项目做详细的单元测试，也能保证提交代码的质量。</p>
</li>
<li><p>  要确保整个代码库和提交记录中，不能出现内部 IP、内部域名、密码、密钥这类信息。否则会造成敏感信息外漏，可能会对内部业务造成安全隐患。</p>
</li>
<li><p>  当开源项目被其他开发者提交 pull request、issue、comment 时要及时处理，可确保项目不断被更新，也可以激发其他开发者贡献代码的积极性。</p>
</li>
<li><p>  持续地更新功能和修复 Bug。对于已经结项、不维护的开源项目，需要及时地对项目进行归档，并在项目描述中加以说明。</p>
</li>
<li><p>  …</p>
</li>
</ul>
<h2 id="文档规范"><a href="#文档规范" class="headerlink" title="文档规范"></a>文档规范</h2><h3 id="README-文档"><a href="#README-文档" class="headerlink" title="README 文档"></a>README 文档</h3><p>README.md 用于介绍项目的功能、安装、部署、使用。</p>
<p>建议使用 <a target="_blank" rel="noopener" href="https://readme.so/">readme.so</a> 生成。</p>
<h3 id="项目文档"><a href="#项目文档" class="headerlink" title="项目文档"></a>项目文档</h3><p>要求易读和可快速定位目标内容，可提供中文与英文版本：</p>
<ul>
<li><p>  开发文档：描述项目开发流程，包括如何搭建开发环境、构建二进制文件、测试、部署等。</p>
</li>
<li><p>  用户文档：软件的使用文档，对象一般是软件使用者。内容包括 API 文档、SDK 文档、安装文档、功能介绍文档、最佳实践、操作指南、常见问题等。</p>
</li>
</ul>
<p>参考目录结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">docs</span><br><span class="line">├── devel                            # 开发文档，可以提前规划好，英文版文档和中文版文档</span><br><span class="line">│   ├── en-US/                       # 英文版文档，可以根据需要组织文件结构</span><br><span class="line">│   └── zh-CN                        # 中文版文档，可以根据需要组织文件结构</span><br><span class="line">│       └── development.md           # 开发手册，可以说明如何编译、构建、运行项目</span><br><span class="line">├── guide                            # 用户文档</span><br><span class="line">│   ├── en-US/                       # 英文版文档，可以根据需要组织文件结构</span><br><span class="line">│   └── zh-CN                        # 中文版文档，可以根据需要组织文件结构</span><br><span class="line">│       ├── api/                     # API 文档</span><br><span class="line">│       ├── best-practice            # 最佳实践，存放一些比较重要的实践文章</span><br><span class="line">│       │   └── authorization.md</span><br><span class="line">│       ├── faq                      # 常见问题</span><br><span class="line">│       │   ├── iam-apiserver</span><br><span class="line">│       │   └── installation</span><br><span class="line">│       ├── installation             # 安装文档</span><br><span class="line">│       │   └── installation.md</span><br><span class="line">│       ├── introduction/            # 产品介绍文档</span><br><span class="line">│       ├── operation-guide          # 操作指南，可根据 RESTful 资源再划分为更细的子目录，存放系统功能操作手册</span><br><span class="line">│       │   ├── policy.md</span><br><span class="line">│       │   ├── secret.md</span><br><span class="line">│       │   └── user.md</span><br><span class="line">│       ├── quickstart               # 快速入门</span><br><span class="line">│       │   └── quickstart.md</span><br><span class="line">│       ├── README.md                # 用户文档入口文件</span><br><span class="line">│       └── sdk                      # SDK 文档</span><br><span class="line">│           └── golang.md</span><br><span class="line">└── images                           # 图片存放目录</span><br><span class="line">    └── 部署架构v1.png</span><br></pre></td></tr></table></figure>

<h3 id="API-文档"><a href="#API-文档" class="headerlink" title="API 文档"></a>API 文档</h3><p>一般由后端开发人员编写，描述组件提供的 API 以及调用方法。</p>
<p>可以编写 Word/Markdown 格式文档、借助工具编写（填充内容）、通过注释生成（如 Swagger）等。</p>
<p>通常需要包含完整的 API 接口介绍文档（接口描述、请求方法、请求参数、输出参数和请求示例）、API 接口变更历史文档、通用说明、数据结构说明、错误码描述和 API 接口使用文档。</p>
<ul>
<li><p>  README.md ：API 接口介绍文档，会分类介绍 IAM 支持的 API 接口，并会存放相关 API 接口文档的链接，方便开发者查看。</p>
</li>
<li><p>  CHANGELOG.md ：API 接口文档变更历史，方便进行历史回溯，也可以使调用者决定是否进行功能更新和版本更新。</p>
</li>
<li><p>  generic.md ：用来说明通用的请求参数、返回参数、认证方法和请求方法等。</p>
</li>
<li><p>  struct.md ：用来列出接口文档中使用的数据结构。这些数据结构可能被多个 API 接口使用，会在 user.md、secret.md、policy.md 文件中被引用。</p>
</li>
<li><p>  user.md 、 secret.md 、 policy.md ：API 接口文档，相同 REST 资源的接口会存放在一个文件中，以 REST 资源名命名文档名。</p>
</li>
<li><p>  error_code.md ：错误码描述，通过程序自动生成。</p>
</li>
</ul>
<p>其中接口描述：</p>
<ul>
<li><p>  接口描述：描述接口实现的功能。</p>
</li>
<li><p>  请求方法：接口的请求方法，格式为 HTTP 方法 请求路径，比如 POST /v1/users。在 <strong>通用说明</strong> 中的 <strong>请求方法</strong> 部分，会说明接口的请求协议和请求地址。</p>
</li>
<li><p>  输入参数：接口的输入字段，分为 Header 参数、Query 参数、Body 参数、Path 参数。每个字段通过：<strong>参数名称</strong>、<strong>必选</strong>、<strong>类型</strong> 和 <strong>描述</strong> 4 个属性来描述。如果参数有限制或者默认值，可在描述部分注明。</p>
</li>
<li><p>  输出参数：接口返回字段，每个字段通过 <strong>参数名称</strong>、<strong>类型</strong> 和 <strong>描述</strong> 3 个属性来描述。</p>
</li>
<li><p>  请求示例：真实的 API 接口请求和返回示例。</p>
</li>
</ul>
<h4 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h4><p>使用 go-swagger 生成文档，可参考代码：<a target="_blank" rel="noopener" href="https://github.com/marmotedu/gopractise-demo/tree/main/swagger">gopractise-demo/swagger</a>。</p>
<p>安装 swagger 命令行工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/go-swagger/go-swagger/cmd/swagger</span><br><span class="line">swagger version</span><br><span class="line"><span class="meta">#</span><span class="bash"> dev</span></span><br></pre></td></tr></table></figure>

<p>在 Model 层代码中写上 Swagger 注释 sg/api/user.go：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package api defines the user model.</span></span><br><span class="line"><span class="keyword">package</span> api</span><br><span class="line"></span><br><span class="line"><span class="comment">// User represents body of User request and response.</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// User&#x27;s name.</span></span><br><span class="line">    <span class="comment">// Required: true</span></span><br><span class="line">    Name <span class="keyword">string</span> <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// User&#x27;s nickname.</span></span><br><span class="line">    <span class="comment">// Required: true</span></span><br><span class="line">    Nickname <span class="keyword">string</span> <span class="string">`json:&quot;nickname&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// User&#x27;s address.</span></span><br><span class="line">    Address <span class="keyword">string</span> <span class="string">`json:&quot;address&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// User&#x27;s email.</span></span><br><span class="line">    Email <span class="keyword">string</span> <span class="string">`json:&quot;email&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写带 go-swagger 注释的 API 文档 sg/docs/doc.go：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package docs awesome.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Documentation of our awesome API.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Schemes: http, https</span></span><br><span class="line"><span class="comment">//     BasePath: /</span></span><br><span class="line"><span class="comment">//     Version: 0.1.0</span></span><br><span class="line"><span class="comment">//     Host: some-url.com</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Consumes:</span></span><br><span class="line"><span class="comment">//     - application/json</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Produces:</span></span><br><span class="line"><span class="comment">//     - application/json</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Security:</span></span><br><span class="line"><span class="comment">//     - basic</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    SecurityDefinitions:</span></span><br><span class="line"><span class="comment">//    basic:</span></span><br><span class="line"><span class="comment">//      type: basic</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// swagger:meta</span></span><br><span class="line"><span class="keyword">package</span> docs</span><br></pre></td></tr></table></figure>

<p>编写 API 定义文件 sg/docs/user.go ：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> docs</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/marmotedu/gopractise-demo/sg/api&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// swagger:route POST /users user createUserRequest</span></span><br><span class="line"><span class="comment">// Create a user in memory.</span></span><br><span class="line"><span class="comment">// responses:</span></span><br><span class="line"><span class="comment">//   200: createUserResponse</span></span><br><span class="line"><span class="comment">//   default: errResponse</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// swagger:route GET /users/&#123;name&#125; user getUserRequest</span></span><br><span class="line"><span class="comment">// Get a user from memory.</span></span><br><span class="line"><span class="comment">// responses:</span></span><br><span class="line"><span class="comment">//   200: getUserResponse</span></span><br><span class="line"><span class="comment">//   default: errResponse</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// swagger:parameters createUserRequest</span></span><br><span class="line"><span class="keyword">type</span> userParamsWrapper <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// This text will appear as description of your request body.</span></span><br><span class="line">    <span class="comment">// in:body</span></span><br><span class="line">    Body api.User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This text will appear as description of your request url path.</span></span><br><span class="line"><span class="comment">// swagger:parameters getUserRequest</span></span><br><span class="line"><span class="keyword">type</span> getUserParamsWrapper <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// in:path</span></span><br><span class="line">    Name <span class="keyword">string</span> <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This text will appear as description of your response body.</span></span><br><span class="line"><span class="comment">// swagger:response createUserResponse</span></span><br><span class="line"><span class="keyword">type</span> createUserResponseWrapper <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// in:body</span></span><br><span class="line">    Body api.User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This text will appear as description of your response body.</span></span><br><span class="line"><span class="comment">// swagger:response getUserResponse</span></span><br><span class="line"><span class="keyword">type</span> getUserResponseWrapper <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// in:body</span></span><br><span class="line">    Body api.User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This text will appear as description of your error response body.</span></span><br><span class="line"><span class="comment">// swagger:response errResponse</span></span><br><span class="line"><span class="keyword">type</span> errResponseWrapper <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Error code.</span></span><br><span class="line">    Code <span class="keyword">int</span> <span class="string">`json:&quot;code&quot;`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error message.</span></span><br><span class="line">    Message <span class="keyword">string</span> <span class="string">`json:&quot;message&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 main.go 文件中导入 docs 包，使 go-swagger 在递归解析 main 包的依赖时找到 docs 包，并解析包中的注释。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// This line is necessary for go-swagger to find your docs!</span></span><br><span class="line">	_ <span class="string">&quot;github.com/marmotedu/gopractise-demo/sg/docs&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>生成 Swagger API 文档，并启动 HTTP 服务，在浏览器查看 Swagger：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swagger generate spec -o swagger.yaml</span><br><span class="line">swagger serve --no-open -F=redoc --port 36666 swagger.yaml</span><br></pre></td></tr></table></figure>

<p>也可以生成 JSON 格式的 Swagger 文档：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swagger generate spec -i ./swagger.yaml -o ./swagger.json</span><br></pre></td></tr></table></figure>

<p>其它功能可参考：<a target="_blank" rel="noopener" href="https://goswagger.io/"> Swagger 2.0</a>。</p>
<h2 id="版本规范"><a href="#版本规范" class="headerlink" title="版本规范"></a>版本规范</h2><p>一般使用 <strong>语义化版本规范</strong>（SemVer，Semantic Versioning），即 <code>主版本号.次版本号.修订号</code>（X.Y.Z，其中 X、Y 和 Z 为非负的整数，且禁止在数字前方补零）。</p>
<p>也有先行版本号与编译版本号 <code>v1.2.3-aplha.1+001</code>：即把先行版本号（Pre-release）和版本编译元数据，作为延伸加到了主版本号.次版本号.修订号的后面：<code>X.Y.Z[-先行版本号][+版本编译元数据]</code>。</p>
<ul>
<li><p>主版本号（MAJOR）：不兼容的 API 修改。</p>
<ul>
<li><p>  必须在有任何不兼容的修改被加入公共 API 时递增。其中可以包括次版本号及修订级别的改变。每当主版本号递增时，次版本号和修订号必须归零。</p>
</li>
<li><p>  主版本号为零（0.y.z）的软件处于开发初始阶段，由于一切都可能随时被改变，不应该被视为稳定版。<code>1.0.0</code> 被界定为第一个稳定版本，之后的所有版本号更新都基于该版本修改。</p>
</li>
</ul>
</li>
<li><p>  次版本号（MINOR）：向下兼容的功能性新增及修改。一般偶数为稳定版本，奇数为开发版本。在任何公共 API 功能被标记为弃用时也必须递增，当有改进时也可以递增。其中可以包括修订级别的改变。每当次版本号递增时，修订号必须归零。</p>
</li>
<li><p>  修订号（PATCH）：向下兼容的问题修正，即 bug 修复。</p>
</li>
<li><p>  先行版本号：该版本不稳定，可能存在兼容性问题。</p>
</li>
<li><p>  编译版本号：编译器在编译过程中自动生成，开发者只定义其格式、不进行人为控制。</p>
</li>
</ul>
<p>使用建议：</p>
<ul>
<li><p>  使用 0.1.0 作为首个开发版本号，在后续每次发行时递增次版本号。</p>
</li>
<li><p>  稳定版本并第一次对外发布时版本号可定为 1.0.0。</p>
</li>
<li><p>严格按照 Angular commit message 规范提交代码时：</p>
<ul>
<li><p>  fix 类型的 commit 可将修订号 +1。</p>
</li>
<li><p>  feat 类型的 commit 可将次版本号 +1。</p>
</li>
<li><p>  带 BREAKING CHANGE 的 commit 可将主版本号 +1。</p>
</li>
</ul>
</li>
</ul>
<h3 id="自动生成"><a href="#自动生成" class="headerlink" title="自动生成"></a>自动生成</h3><p>IAM 项目采用 gsemver 自动生成版本号，参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/scripts/ensure_tag.sh">iam/ensure_tag.sh</a>。</p>
<p>Makefile 和 Shell 脚本用到的所有版本号使用 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.0/scripts/make-rules/common.mk#L28">iam/common.mk</a> 中的 VERSION 变量。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VERSION := <span class="variable">$(<span class="built_in">shell</span> git describe --tags --always --match=&#x27;v*&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 git describe 时，符合条件的 tag 指向最新提交，则只显示 tag 的名字，否则会有相关的后缀描述该 tag 后有多少次提交，以及最新的提交 commit id。比如 v1.0.0-3-g1909e47：</span></span><br><span class="line"><span class="comment"># 3：表示自打 tag v1.0.0 以来有 3 次提交。</span></span><br><span class="line"><span class="comment"># g1909e47：g 为 git 的缩写，在多种管理工具并存的环境中很有用处。</span></span><br><span class="line"><span class="comment"># 1909e47：7 位字符表示为最新提交的 commit id 前 7 位。</span></span><br></pre></td></tr></table></figure>

<h2 id="Git-规范"><a href="#Git-规范" class="headerlink" title="Git 规范"></a>Git 规范</h2><h3 id="Commit-规范"><a href="#Commit-规范" class="headerlink" title="Commit 规范"></a>Commit 规范</h3><p>常见的开源社区 commit message 规范：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/1699f5c1933cfe72803dfb038152fc48.png" alt="img"></p>
<p>比如 Angular 规范：</p>
<ul>
<li><p>  语义化：commit message 被归为有意义的类型用来说明本次 commit 的类型。</p>
</li>
<li><p>  规范化：commit message 遵循预先定义好的规范，比如格式固定、都属于某个类型，可被开发者和工具识别。</p>
</li>
</ul>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/da69572c5605556b8144eb4ee281c4cb.png" alt="img"></p>
<p>基本格式：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;type&gt;[<span class="keyword">optional</span> scope]: &lt;description&gt;</span><br><span class="line"><span class="comment">// 空行</span></span><br><span class="line">[<span class="keyword">optional</span> body]</span><br><span class="line"><span class="comment">// 空行</span></span><br><span class="line">[<span class="keyword">optional</span> footer(s)]</span><br></pre></td></tr></table></figure>

<p>建议使用 <code>git commit</code> 时不要使用 <code>-m</code> 选项，而 <code>-a</code> 进入交互界面编辑 commit message。</p>
<h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>只有一行，包括：type（必选）、scope（可选）和 subject（必选）。</p>
<p>type 分为：</p>
<ul>
<li><p>  Development：一般是项目管理类的变更，不会影响最终用户和生产环境的代码，比如 CI 流程、构建方式等的修改。通常可以免测发布。</p>
</li>
<li><p>  Production：会影响最终的用户和生产环境的代码。一定要慎重并在提交前做好充分的测试。</p>
</li>
</ul>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/89c618a7415c0c38b09d86d7f882a427.png" alt="img"></p>
<img src="https://static001.geekbang.org/resource/image/35/a7/3509bd169ce285f59fbcfa6ebea75aa7.png?wh=2513*1078" alt="img" style="zoom:67%;" />

<p>scope 说明 commit 影响范围，必须是名词，因项目而异。</p>
<ul>
<li><p>  初期可设置粒度较大的 scope（如按组件名或功能设置），后续项目有变动或有新功能时可添加新的 scope。</p>
</li>
<li><p>  不适合设置太具体的值。会导致项目有太多的 scope 难以维护，开发者也难以确定 commit 所属的 scope 导致错放，反而失去分类的意义。</p>
</li>
</ul>
<p>subject 是 commit 的简短描述，明确指出 commit 执行的操作，以动词开头（小写）、使用现在时，不加句号。</p>
<h4 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h4><p>可分成多行，格式较自由。以动词开头、使用现在时。</p>
<p>必须包括修改的动机、跟上一版本相比的改动点。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The <span class="keyword">body</span> <span class="keyword">is</span> mandatory <span class="keyword">for</span> <span class="keyword">all</span> commits except <span class="keyword">for</span> those <span class="keyword">of</span> scope <span class="string">&quot;docs&quot;</span>. <span class="keyword">When</span> the <span class="keyword">body</span> <span class="keyword">is</span> required it must be <span class="keyword">at</span> least <span class="number">20</span> characters long.</span><br></pre></td></tr></table></figure>

<h4 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h4><p>根据需要选择，一般格式：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BREAKING CHANGE: &lt;breaking change summary&gt;</span><br><span class="line"><span class="regexp">//</span> 空行</span><br><span class="line">&lt;breaking change description + migration instructions&gt;</span><br><span class="line"><span class="regexp">//</span> 空行</span><br><span class="line"><span class="regexp">//</span> 空行</span><br><span class="line">Fixes <span class="comment">#&lt;issue number&gt;</span></span><br></pre></td></tr></table></figure>

<p>可说明本次 commit 导致的后果。</p>
<p><strong>不兼容的改动</strong>：如当前代码跟上一个版本不兼容，需要在 Footer 部分以 BREAKING CHANG: 开头，跟上不兼容改动的摘要。其他部分需要说明变动的描述、变动的理由和迁移方法：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">BREAKING CHANGE:</span> <span class="string">isolate</span> <span class="string">scope</span> <span class="string">bindings</span> <span class="string">definition</span> <span class="string">has</span> <span class="string">changed</span> <span class="string">and</span></span><br><span class="line">    <span class="string">the</span> <span class="string">inject</span> <span class="string">option</span> <span class="string">for</span> <span class="string">the</span> <span class="string">directive</span> <span class="string">controller</span> <span class="string">injection</span> <span class="string">was</span> <span class="string">removed.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">To migrate the code follow the example below:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Before:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scope:</span> &#123;</span><br><span class="line">      <span class="attr">myAttr:</span> <span class="string">&#x27;attribute&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attr">After:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scope:</span> &#123;</span><br><span class="line">      <span class="attr">myAttr:</span> <span class="string">&#x27;@&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="string">The</span> <span class="string">removed</span> <span class="string">`inject`</span> <span class="string">wasn&#x27;t</span> <span class="string">generaly</span> <span class="string">useful</span> <span class="string">for</span> <span class="string">directives</span> <span class="string">so</span> <span class="string">there</span> <span class="string">should</span> <span class="string">be</span> <span class="literal">no</span> <span class="string">code</span> <span class="string">using</span> <span class="string">it.</span></span><br></pre></td></tr></table></figure>

<p><strong>关闭的 Issue 列表</strong>：关闭的 Bug 需要在 Footer 部分新建一行，并以 Closes 开头列出，比如：<code>Closes #123</code>。如果关闭多个 Issue，可以列出：<code>Closes #123, #432, #886</code>。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Change pause <span class="built_in">version</span> <span class="built_in">value</span> <span class="built_in">to</span> <span class="keyword">a</span> <span class="built_in">constant</span> <span class="keyword">for</span> image</span><br><span class="line">   </span><br><span class="line">   Closes <span class="comment">#1137</span></span><br></pre></td></tr></table></figure>

<h4 id="Revert-Commit"><a href="#Revert-Commit" class="headerlink" title="Revert Commit"></a>Revert Commit</h4><p>如果当前 commit 还原了先前的 commit，则应以 revert: 开头，后跟还原的 commit 的 Header。而且，在 Body 中必须写成 <code>This reverts commit &lt;hash&gt;</code> ，其中 hash 是要还原的 commit 的 SHA 标识。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">revert</span>: feat(iam-apiserver): add &#x27;Host&#x27; option</span><br><span class="line"></span><br><span class="line"><span class="attribute">This</span> reverts commit <span class="number">079360</span>c<span class="number">7</span>cfc<span class="number">830</span>ea<span class="number">8</span>a<span class="number">6</span>e<span class="number">13</span>f<span class="number">4</span>c<span class="number">8</span>b<span class="number">8114</span>febc<span class="number">9</span>b<span class="number">48</span>a.</span><br></pre></td></tr></table></figure>

<h4 id="管理-Commit"><a href="#管理-Commit" class="headerlink" title="管理 Commit"></a>管理 Commit</h4><p>在对项目进行修改，通过测试（修复 bug、完成 feature）后立即 commit；或约定一个提交的周期，减少本地代码丢失造成的代码丢失量。要避免 commit 太多，可在合并代码或提交 PR 时使用 <code>git rebase -i</code> 合并之前所有提交：建议把新的 commit 合并到主干时只保留 2~3 个 commit 记录。</p>
<p>使用 <code>git rebase -i commitId</code> 进入交互界面，可列出该 commitId 之后的所有 commit。其支持的操作（默认是 pick）：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/5f5a79a5d2bde029d4de9d98026ef3f2.png" alt="img"></p>
<p>其中 squash 和 fixup 可用于合并 commit（注意是处理 commitId 和 HEAD 之间的 commit，开区间）。比如临时切换到 feature 分支进行开发：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">git log --oneline</span><br><span class="line"><span class="meta">#</span><span class="bash"> 7157e9e docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update3&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5a26aa2 docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update2&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 55892fa docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update1&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 89651d4 docs(doc): add README.md</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ========== feature/user 开发... ==========</span></span><br><span class="line"></span><br><span class="line">git log --oneline</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4ee51d6 docs(user): update user/README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 176ba5d docs(user): update user/README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5e829f8 docs(user): add README.md <span class="keyword">for</span> user</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> f40929f feat(user): add delete user <span class="keyword">function</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> fc70a21 feat(user): add create user <span class="keyword">function</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以上是切换到 feature/user 分支进行开发后提交的 commit。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7157e9e docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update3&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5a26aa2 docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update2&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 55892fa docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update1&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 89651d4 docs(doc): add README.md</span></span><br></pre></td></tr></table></figure>

<p>在 feature 分支上的 5 个 commit 要在合并到 master 分支前进行精简，可选取切换 feature 分支前的最后一个 commit 进行 rebase（比如 squash 操作）。最终 pick 前的四个 commit 都会被删除。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i 7157e9e</span><br><span class="line"><span class="meta">#</span><span class="bash"> pick 4ee51d6 docs(user): update user/README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> s 176ba5d docs(user): update user/README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> s 5e829f8 docs(user): add README.md <span class="keyword">for</span> user</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> s f40929f feat(user): add delete user <span class="keyword">function</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> s fc70a21 feat(user): add create user <span class="keyword">function</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Rebase 7157e9e..4ee51d6 onto 7157e9e (5 commands(s))</span></span><br><span class="line"></span><br><span class="line">git log --oneline</span><br><span class="line"><span class="meta">#</span><span class="bash"> d6b17e0 feat(user): add user module with all <span class="keyword">function</span> implements</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7157e9e docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update3&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5a26aa2 docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update2&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 55892fa docs(docs): append <span class="built_in">test</span> line <span class="string">&#x27;update1&#x27;</span> to README.md</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 89651d4 docs(doc): add README.md</span></span><br></pre></td></tr></table></figure>

<p>除此之外，如果有太多 commit 需要合并，可以先撤销过去的 commit，再创建一个新的（需要重新整理 commit message）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD~3</span><br><span class="line">git add .</span><br><span class="line">git commit -am &quot;feat(user): add user resource&quot;</span><br></pre></td></tr></table></figure>

<h4 id="修改-Commit"><a href="#修改-Commit" class="headerlink" title="修改 Commit"></a>修改 Commit</h4><p>修改最近提交的 commit：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git log --oneline</span><br><span class="line">git commit --amend</span><br></pre></td></tr></table></figure>

<p>修改某次 commit：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i previousCommitId</span><br></pre></td></tr></table></figure>

<p>第二种会导致父 commit 之后所有 commit 的 commitId。可能需要 <code>git stash</code> 将当前分支工作状态暂存，修改完成后再进行 <code>git stash pop</code> 恢复。</p>
<h3 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h3><p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/5503ce60f7c2ae5d7628222a4d87cc07.png" alt="img"></p>
<h4 id="集中式"><a href="#集中式" class="headerlink" title="集中式"></a>集中式</h4><p>所有开发者直接在 master 分支上工作。</p>
<h4 id="功能分支"><a href="#功能分支" class="headerlink" title="功能分支"></a>功能分支</h4><p>在开发新功能时基于 master 分支新建一个功能分支，在功能分支上进行开发，完成之后合并到 master 分支。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新建功能分支</span></span><br><span class="line">git checkout -b feature/rate-limiting</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开发工作提交到功能分支</span></span><br><span class="line">git add limit.go</span><br><span class="line">git commit -m &quot;add rate limiting&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将本地功能分支代码 push 到远程仓库</span></span><br><span class="line">git push origin feature/rate-limiting</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在远程仓库上创建 PR，CR 后 Merge 即可</span></span><br></pre></td></tr></table></figure>

<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/1c0b08a1c9032c87c35b85de6ca6820b.png" alt="img"></p>
<p>Merge PR 推荐使用 Create a merge commit 模式，即 <code>git merge --no-ff</code>，feature 分支上所有的 commit 都会加到 master 分支上，并且会生成一个 merge commit，避免丢失历史记录。</p>
<h4 id="Git-Flow（推荐）"><a href="#Git-Flow（推荐）" class="headerlink" title="Git Flow（推荐）"></a>Git Flow（推荐）</h4><p>常用于非开源项目。共有以下类型的分支：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/fa611f83053afd77cf3ddf83561ba1d9.png" alt="img"></p>
<p>示例场景：</p>
<ul>
<li><p>  当前版本为：0.9.0。</p>
</li>
<li><p>  需要新开发一个功能。</p>
</li>
<li><p>  同时线上代码有 Bug 需要紧急修复。</p>
</li>
</ul>
<p>基本流程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建要给常驻分支</span></span><br><span class="line">git checkout -b develop master</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 基于 develop 分支，新建一个功能分支：feature/hello-world。</span></span><br><span class="line">git checkout -b feature/hello-world develop</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. feature/hello-world 分支上开发</span></span><br><span class="line">echo &quot;feature1&quot; &gt;&gt; test.txt </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 开发过程中需要先紧急修复线上代码的 bug</span></span><br><span class="line">git stash                                         # 临时保存修改至堆栈区</span><br><span class="line">git checkout -b hotfix/error master               # 从 master 建立 hotfix 分支</span><br><span class="line">echo &quot;hotfix&quot; &gt;&gt; test.txt                         # 修复 bug</span><br><span class="line">git commit -a -m &#x27;fix print message error bug&#x27;    # 提交修复</span><br><span class="line">git checkout develop                              # 切换到 develop 分支</span><br><span class="line">git merge --no-ff hotfix/error                    # 把 hotfix 分支合并到 develop 分支</span><br><span class="line">git checkout master                               # 切换到 master 分支</span><br><span class="line">git merge --no-ff hotfix/error                    # 把 hotfix 分支合并到 master</span><br><span class="line">git tag -a v0.9.1 -m &quot;fix log bug&quot;                # 在 master 分支打上 tag</span><br><span class="line">scp test root@target:/opt/                        # 编译并部署代码</span><br><span class="line">git branch -d hotfix/error                        # 修复完成后删除 hotfix/xxx 分支</span><br><span class="line">git checkout feature/hello-world                  # 切换到 feature 分支下</span><br><span class="line">git merge --no-ff develop                         # develop 有更新，需要同步更新下</span><br><span class="line">git stash pop                                     # 恢复到修复前的工作状态</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 继续开发</span></span><br><span class="line">echo &quot;feature2&quot; &gt;&gt; test.txt </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6. 提交代码到 feature/hello-world 分支</span></span><br><span class="line">git commit -a -m &quot;print &#x27;hello world&#x27;&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7. 在 feature/hello-world 分支上做 code review</span></span><br><span class="line">git push origin feature/print-hello-world         # 提交到远程仓库</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建 PR、指定 Reviewers 进行 CR</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 8. CR 过后，由代码仓库 Matainer 将功能分支合并到 develop 分支</span></span><br><span class="line">git checkout develop</span><br><span class="line">git merge --no-ff feature/hello-world</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 9. 基于 develop 分支创建 release 分支，测试代码</span></span><br><span class="line">git checkout -b release/1.0.0 develop</span><br><span class="line">cat test.txt </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 10. 如果测试失败，直接在 release/1.0.0 分支修改代码，完成后提交并编译部署</span></span><br><span class="line">git commit -a -m &quot;fix bug&quot;</span><br><span class="line">scp test root@target:/opt/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 11. 测试通过后，将 release/1.0.0 分支合并到 master 分支和 develop 分支</span></span><br><span class="line">git checkout develop</span><br><span class="line">git merge --no-ff release/1.0.0</span><br><span class="line">git checkout master</span><br><span class="line">git merge --no-ff release/1.0.0</span><br><span class="line">git tag -a v1.0.0 -m &quot;add print hello world&quot; # master 分支打 tag</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 12. 删除 feature/hello-world 分支，也可以选择性删除 release/1.0.0 分支</span></span><br><span class="line">git branch -d feature/hello-world</span><br><span class="line"><span class="meta">#</span><span class="bash"> git branch -d release/1.0.0</span></span><br></pre></td></tr></table></figure>

<h4 id="Forking（推荐）"><a href="#Forking（推荐）" class="headerlink" title="Forking（推荐）"></a>Forking（推荐）</h4><p>常用于开源项目，开发者有衍生出自己的衍生版的需求，或开发者不固定、可能是任意一个能访问到项目的开发者。</p>
<p>其中 fork 操作是在个人远程仓库新建一份目标远程仓库的副本。</p>
<img src="https://static001.geekbang.org/resource/image/63/ea/63419f767c61c9580861b59445b90fea.png" alt="img" style="zoom:67%;" />

<p>基本流程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 在远程仓库上 fork 仓库：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 比如 https://github.com/marmotedu/gitflow-demo =&gt; https://github.com/colin404fork/gitflow-demo</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. <span class="built_in">clone</span> 到本地</span></span><br><span class="line">git clone https://github.com/colin404fork/gitflow-demo</span><br><span class="line">cd gitflow-demo</span><br><span class="line">git remote add upstream https://github.com/marmotedu/gitflow-demo</span><br><span class="line">git remote set-url --push upstream no_push # 不要 push 到 upstream master</span><br><span class="line">git remote -v # 查看远程分支</span><br><span class="line"><span class="meta">#</span><span class="bash"> origin  https://github.com/colin404fork/gitflow-demo (fetch)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> origin  https://github.com/colin404fork/gitflow-demo (push)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> upstream  https://github.com/marmotedu/gitflow-demo (fetch)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> upstream  https://github.com/marmotedu/gitflow-demo (push)</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 创建功能分支</span></span><br><span class="line">git fetch upstream                       # 同步本地仓库的 master 分支为最新状态（与 upstream master 分支一致）</span><br><span class="line">git checkout master</span><br><span class="line">git rebase upstream/master</span><br><span class="line">git checkout -b feature/add-function     # 创建功能分支</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 提交 commit</span></span><br><span class="line">git fetch upstream                       # commit 前需要再次同步 feature 跟 upstream/master</span><br><span class="line">git rebase upstream/master</span><br><span class="line">git add xxx</span><br><span class="line">git status</span><br><span class="line">git commit</span><br><span class="line">git rebase -i origin/master              # 合并多个、保留较少的 commit</span><br><span class="line"><span class="meta">#</span><span class="bash"> git reset HEAD~5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git add .</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git commit -am <span class="string">&quot;Here&#x27;s the bug fix that closes #28&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git push --force</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. push 功能分支到个人远程仓库</span></span><br><span class="line">git push -f origin feature/add-function</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6. 创建 PR，请求 Reviewers review、合并到 master</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建 pull request 时，base 通常选择目标远程仓库的 master 分支。</span></span><br></pre></td></tr></table></figure>

<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/94e521c6eb884096ea107fc4c36f30a3.png" alt="img" style="zoom:67%;" />

<p>参考 IAM 项目：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">├── api                     # 当前项目对外提供的各种不同类型的 API 接口定义文件</span><br><span class="line">│   ├── openapi</span><br><span class="line">|   ├── protobuf-spec</span><br><span class="line">|   ├── thrift-spec</span><br><span class="line">|   ├── http-spec</span><br><span class="line">│   └── swagger</span><br><span class="line">|       ├── docs/</span><br><span class="line">|       ├── README.md</span><br><span class="line">│       └── swagger.yaml</span><br><span class="line">├── assets                  # 项目的其他资源 (图片、CSS、JavaScript 等）</span><br><span class="line">├── build                   # 安装包和持续集成相关的文件</span><br><span class="line">│   ├── ci                  # CI（travis，circle，drone）的配置文件和脚本</span><br><span class="line">│   ├── docker              # 子项目各个组件的 Dockerfile 文件</span><br><span class="line">│   │   ├── iam-apiserver</span><br><span class="line">│   │   ├── iam-authz-server</span><br><span class="line">│   │   └── iam-pump</span><br><span class="line">│   └── package              # 容器（Docker）、系统（deb, rpm, pkg）的包配置和脚本</span><br><span class="line">├── CHANGELOG                # 更新记录，方便了解当前版本的更新内容或者历史更新内容</span><br><span class="line">|                            #     可结合 Angular 规范 和 git-chglog 来自动生成</span><br><span class="line">├── cmd 					 # 统一存放组件 main 函数所在目录，不存放过多代码</span><br><span class="line">|   |                        #     其下的目录名与可执行文件名一致 </span><br><span class="line">│   ├── iam-apiserver</span><br><span class="line">│   │   └── apiserver.go</span><br><span class="line">│   ├── iam-authz-server</span><br><span class="line">│   │   └── authzserver.go</span><br><span class="line">│   ├── iamctl</span><br><span class="line">│   │   └── iamctl.go</span><br><span class="line">│   └── iam-pump</span><br><span class="line">│       └── pump.go</span><br><span class="line">├── configs                  # 配置文件模板或默认配置，不携带敏感信息（占位符替代）</span><br><span class="line">├── CONTRIBUTING.md          # 说明如何贡献代码，如何开源协同等</span><br><span class="line">|                            #     用于规范协同流程、降低第三方开发者贡献代码的难度</span><br><span class="line">├── deploy                   # Iaas、PaaS 系统和容器编排部署配置和模板</span><br><span class="line">├── docs                     # 设计文档、开发文档和用户文档等（除了 godoc 生成的文档）</span><br><span class="line">│   ├── devel                # 开发文档、hack 文档等</span><br><span class="line">│   │   ├── en-US</span><br><span class="line">│   │   └── zh-CN</span><br><span class="line">│   ├── guide                # 用户手册，安装、quickstart、产品文档等</span><br><span class="line">│   │   ├── en-US</span><br><span class="line">│   │   └── zh-CN</span><br><span class="line">│   ├── images               # 图片文件</span><br><span class="line">│   └── README.md</span><br><span class="line">├── examples                 # 应用程序或者公共包的示例代码</span><br><span class="line">├── githooks</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── init                     # 初始化系统（systemd，upstart，sysv）、进程管理配置文件（runit，supervisord）</span><br><span class="line">├── internal                 # 私有应用和库代码，在被尝试引入时编译会报错</span><br><span class="line">│   ├── apiserver            # 应用目录，包含应用程序实现代码。</span><br><span class="line">│   │   ├── c</span><br><span class="line">│   │   │   └── v1           # HTTP API 具体实现，实现请求解包、参数校验、业务逻辑处理、返回。</span><br><span class="line">|   |   |       |            #     业务逻辑较轻，复杂的建议放到 /internal/apiserver/service 下</span><br><span class="line">│   │   │       └── user</span><br><span class="line">│   │   ├── apiserver.go</span><br><span class="line">│   │   ├── options</span><br><span class="line">│   │   ├── service</span><br><span class="line">│   │   ├── store            # 与数据库交互、持久化代码</span><br><span class="line">│   │   │   ├── mysql</span><br><span class="line">│   │   │   └── fake</span><br><span class="line">│   │   └── testing</span><br><span class="line">│   ├── iamctl               # 客户端工具</span><br><span class="line">│   │   ├── cmd</span><br><span class="line">│   │   │   ├── completion</span><br><span class="line">│   │   │   └── user</span><br><span class="line">│   │   └── util</span><br><span class="line">│   └── pkg                  # 项目内可共享，项目外不共享的包</span><br><span class="line">|       |                    #     准备对外开发时再转存到 /pkg</span><br><span class="line">│       ├── code             # 项目业务 Code 码</span><br><span class="line">│       ├── options</span><br><span class="line">│       ├── server</span><br><span class="line">│       ├── util</span><br><span class="line">|       ├── middleware       # HTTP 请求处理链</span><br><span class="line">│       └── validation       # 通用的验证函数</span><br><span class="line">├── LICENSE                  # 版权文件，可以是私有或开源</span><br><span class="line">├── Makefile                 # 执行静态代码检查、单元测试、编译等功能</span><br><span class="line">|                            #     gen -&gt; format -&gt; lint -&gt; test -&gt; build</span><br><span class="line">├── _output                  # 编译输出的二进制文件</span><br><span class="line">│   └── platforms</span><br><span class="line">│       └── linux</span><br><span class="line">│           └── amd64</span><br><span class="line">├── pkg                      # 可被外部应用使用的代码（import），需要慎重</span><br><span class="line">│   └── util</span><br><span class="line">│       └── genutil</span><br><span class="line">├── README.md                # 项目介绍、功能、快速安装和使用指引、详细文档链接、开发指引等</span><br><span class="line">├── scripts                  # 脚本文件，实现构建、安装、分析等不同功能</span><br><span class="line">│   ├── lib                  # 执行自动化任务 shell 的脚本，发布、更新文档、生成代码等</span><br><span class="line">|   |   ├── util.sh</span><br><span class="line">|   |   └── logging.sh</span><br><span class="line">|   ├── install              # 复杂的自动化部署脚本</span><br><span class="line">│   └── make-rules           # 实现 /Makefile 文件中的各个功能</span><br><span class="line">├── test                     # 其他外部测试应用和测试数据</span><br><span class="line">│   └── data                 # 需要 Go 忽略该目录中的内容时使用</span><br><span class="line">├── third_party              # 外部帮助工具，分支代码或其他第三方应用，比如 Swagger</span><br><span class="line">│   └── forked               #     fork 并作改动的第三方包，便于与 upstream 同步</span><br><span class="line">├── tools                    # 项目的支持工具。可导入来自 /pkg 和 /internal 的代码</span><br><span class="line">├── vendor                   # 项目依赖，可通过 go mod vendor 创建</span><br><span class="line">|                            #     对于 Go 库不要提交 vendor 依赖包</span><br><span class="line">├── website                  # 如不使用 GitHub 页面，可在此放置项目网站相关的数据</span><br><span class="line">└── web 					 # 前端代码，主要是静态资源，服务端模板和单页应用（SPAs）</span><br></pre></td></tr></table></figure>

<p>小型项目：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tms</span><br><span class="line">├── <span class="built_in">cmd</span></span><br><span class="line">├── internal</span><br><span class="line">├── pkg</span><br><span class="line">└── README.<span class="built_in">md</span></span><br></pre></td></tr></table></figure>

<p>对于空目录，可创建 <code>.keep</code> 文件保留目录结构。</p>
<h2 id="编码规范"><a href="#编码规范" class="headerlink" title="编码规范"></a>编码规范</h2><p>具体见参考链接提供的文档。</p>
<p>可从以下几个方面考虑：</p>
<ul>
<li><p>  代码结构：目录结构，按功能拆分模块。</p>
</li>
<li><p>  代码规范：编码规范，最佳实践。</p>
</li>
<li><p>  代码质量：编写可测试代码，高单元测试率，代码审查。</p>
</li>
<li><p>  编程哲学：面向接口编程，面向对象编程。</p>
</li>
<li><p>  软件设计方法：设计模式，SOLID 原则。</p>
</li>
</ul>
<h3 id="代码架构"><a href="#代码架构" class="headerlink" title="代码架构"></a>代码架构</h3><p>一般具备以下特性：</p>
<ul>
<li><p>  独立于框架：不依赖于软件库存在。使得可以使用强大的框架作为工具，而不是让系统陷入到框架的约束中。</p>
</li>
<li><p>  可测试性：业务规则可以在没有 UI、数据库、Web 服务或其他外部元素的情况下进行测试，通过 Mock 来解耦依赖。</p>
</li>
<li><p>  独立于 UI ：在无需改变系统其他部分的情况下，UI 可以轻松地改变。</p>
</li>
<li><p>  独立于数据库：业务规则不绑定到数据库。</p>
</li>
<li><p>  独立于外部媒介：业务规则可以简单到根本不了解外部世界。</p>
</li>
</ul>
<h4 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h4><p>主要分为四层，除模型层外，控制层、业务层、仓库层之间通过接口进行通信。</p>
<p>通过控制层将模型层和视图层解耦，从而使代码更容易维护和扩展，可使相同的功能支持不同的实现（插件化能力），也使每一层代码易于测试。</p>
<ul>
<li><p>  <strong>模型层</strong>（Models）：即实体层（Entities），封装结构及其方法，可供其它层引用。模型可作为数据库模型或 API 请求模型。如确保创建资源时的属性、资源保存在数据库中的属性、返回资源的属性三者一致就可以使用同一个，使代码更简洁、易维护，并提高开发效率，否则可另建模型适配。</p>
</li>
<li><p>  <strong>控制层</strong>（Controller）：接收 HTTP 请求，并进行参数解析、参数校验、逻辑分发处理、请求返回操作。将逻辑分发给业务层，业务层处理后返回，返回数据在控制层中被整合再加工，最终返回给请求方。相当于实现业务路由功能，应避免实现得太复杂。</p>
</li>
<li><p>  <strong>业务层</strong> （Service）：完成所有业务逻辑处理，即处理来自控制层的请求，根据需要请求仓库层完成数据的 CURD 操作。</p>
</li>
<li><p>  <strong>仓库层</strong>（Repository）：与数据库 / 第三方服务进行 CURD 交互，作为应用程序的数据引擎进行应用数据的输入和输出。同时实现数据转换：从数据库 / 微服务中获取的数据与控制层、业务层之间转换。</p>
</li>
</ul>
<blockquote>
<p>  跨层调用要求调用层包含被调用层的实例，比如在创建控制层实例时传入业务层的实例、在创建业务层实例时传入仓库层的实例，最终通过仓库层实例的 db 字段（*gorm.DB 类型）完成数据库的 CURD 操作。</p>
</blockquote>
<p>导入关系：</p>
<ul>
<li>  模型层的包可被仓库层、业务层和控制层导入。</li>
<li>  控制层可导入业务层和仓库层包。如果没有特殊需求，控制层要避免导入仓库层的包，控制层需要完成的业务功能都通过业务层来完成，使代码逻辑更加清晰、规范。</li>
<li>  业务层可导入仓库层的包。</li>
</ul>
<p>工厂方法模式：层间导入以接口类型代替具体实现，通过调用该接口实例的方法完成跨层调用。比如 <a target="_blank" rel="noopener" href="https://github.com/KyloForks/iam/blob/master/internal/apiserver/service/v1/service.go">iam/service.go</a> 是工厂接口，其中包含一系列创建具体业务层对象的工厂方法 <code>Users()</code>、<code>Secrets()</code>、<code>Policies()</code>。既隐藏业务层对象创建细节，还便于在 <code>Service</code> 工厂接口实现方法中添加新的业务层对象。</p>
<h3 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h3><h4 id="包"><a href="#包" class="headerlink" title="包"></a>包</h4><ul>
<li><p>  包名必须和目录名一致，尽量采取有意义、简短的包名，不要和标准库冲突。</p>
</li>
<li><p>  包名全部小写，没有大写或下划线，使用多级目录来划分层级。</p>
</li>
<li><p>  项目名可以通过中划线来连接多个单词。</p>
</li>
<li><p>  包名以及包所在的目录名，不要使用复数，比如 net/utl 而不是 net/urls。</p>
</li>
<li><p>  不要用 common、util、shared 或者 lib 这类宽泛的、无意义的包名。</p>
</li>
<li><p>  包名要简单明了，例如 net、time、log。</p>
</li>
</ul>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p>函数名采用驼峰式，首字母根据访问控制决定使用大写或小写，例如：MixedCaps 或者 mixedCaps。</p>
<p>代码生成工具自动生成的代码 (如 xxxx.pb.go) 和为了对相关测试用例进行分组，而采用的下划线 (如 <code>TestMyFunction_WhatIsBeingTested</code>) 可排除此规则。</p>
<h4 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h4><p>文件名要简短有意义，应小写并使用下划线分割单词。</p>
<h4 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h4><ul>
<li><p>  采用驼峰命名方式，首字母根据访问控制决定使用大写或小写，例如 MixedCaps 或者 mixedCaps。</p>
</li>
<li><p>  结构体名不应该是动词，应该是名词，比如 Node、NodeSpec。</p>
</li>
<li><p>  避免使用 Data、Info 这类无意义的结构体名。</p>
</li>
<li><p>  结构体的声明和初始化应采用多行：</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 多行声明</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name  <span class="keyword">string</span></span><br><span class="line">    Email <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多行初始化</span></span><br><span class="line">u := User&#123;</span><br><span class="line">    UserName: <span class="string">&quot;colin&quot;</span>,</span><br><span class="line">    Email:    <span class="string">&quot;colin404@foxmail.com&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><p>基本和结构体命名规则保持一致：</p>
<ul>
<li><p>  单个函数的接口名以 “er””作为后缀（例如 Reader，Writer），有时候可能导致蹩脚的英文，但是没关系。</p>
</li>
<li><p>  两个函数的接口名以两个函数名命名，例如 ReadWriter。</p>
</li>
<li><p>  三个以上函数的接口名，类似于结构体名。</p>
</li>
</ul>
<p>比如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Seeking to an offset before the start of the file is an error.</span></span><br><span class="line"><span class="comment">// Seeking to any positive offset is legal, but the behavior of subsequent</span></span><br><span class="line"><span class="comment">// I/O operations on the underlying object is implementation-dependent.</span></span><br><span class="line"><span class="keyword">type</span> Seeker <span class="keyword">interface</span> &#123;</span><br><span class="line">    Seek(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>) (<span class="keyword">int64</span>, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadWriter is the interface that groups the basic Read and Write methods.</span></span><br><span class="line"><span class="keyword">type</span> ReadWriter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Reader</span><br><span class="line">    Writer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><ul>
<li><p>  变量名必须遵循驼峰式，首字母根据访问控制决定使用大写或小写。</p>
</li>
<li><p>  在相对简单（对象数量少、针对性强）的环境中，可以将一些名称由完整单词简写为单个字母，比如：user 可简写为 u；userID 可简写 uid。</p>
</li>
<li><p>  对于私有特有名词为首个单词则使用小写（如 apiClient）。其他特有名词都应当使用该名词原有的写法，如 APIClient、repoID、UserID。</p>
</li>
<li><p>  若变量类型为 bool 类型，则名称应以 Has，Is，Can 或 Allow 开头。</p>
</li>
<li><p>  局部变量应当尽可能短小，比如使用 buf 指代 buffer，使用 i 指代 index。</p>
</li>
<li><p>  代码生成工具自动生成的代码可排除此规则 (如 xxx.pb.go 里面的 Id)。</p>
</li>
</ul>
<h4 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h4><p>常量名必须遵循驼峰式，首字母根据访问控制决定使用大写或小写。</p>
<p>如果是枚举类型的常量，需要先创建相应类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Code defines an error code type.</span></span><br><span class="line"><span class="keyword">type</span> Code <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Internal errors.</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    <span class="comment">// ErrUnknown - 0: An unknown error occurred.</span></span><br><span class="line">    ErrUnknown Code = <span class="literal">iota</span></span><br><span class="line">    <span class="comment">// ErrFatal - 1: An fatal error occurred.</span></span><br><span class="line">    ErrFatal</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h4><p><code>Error</code> 类型应该写成 FooError 的形式，比如 <code>type ExitError struct &#123;&#125;</code>。</p>
<p><code>Error</code> 变量写成 ErrFoo 的形式，比如 <code>var ErrFormat = errors.New(&quot;unknown format&quot;)</code>。</p>
<h3 id="注释规范"><a href="#注释规范" class="headerlink" title="注释规范"></a>注释规范</h3><ul>
<li><p>  每个可导出的名字都要有注释，该注释对导出的变量、函数、结构体、接口等进行简要介绍。</p>
</li>
<li><p>  全部使用单行注释，禁止使用多行注释。</p>
</li>
<li><p>  和代码的规范一样，单行注释不要过长，禁止超过 120 字符，超过的请使用换行展示，尽量保持格式优雅。</p>
</li>
<li><p>  注释必须是完整的句子，以需要注释的内容作为开头，句点作为结尾，格式为 // 名称 描述。</p>
</li>
</ul>
<h4 id="包-1"><a href="#包-1" class="headerlink" title="包"></a>包</h4><p>每个包都有且仅有一个包级别的注释，格式统一为 <code>// Package 包名 包描述.</code>，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package genericclioptions contains flags which can be added to you command, bound, completed, and produce</span></span><br><span class="line"><span class="comment">// useful helper functions.</span></span><br><span class="line"><span class="keyword">package</span> genericclioptions</span><br></pre></td></tr></table></figure>

<h4 id="变量，常量"><a href="#变量，常量" class="headerlink" title="变量，常量"></a>变量，常量</h4><p>导出的变量和常量常量都必须有注释说明，格式为 <code>// 变量名 变量描述.</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ErrSigningMethod defines invalid signing method error.</span></span><br><span class="line"><span class="keyword">var</span> ErrSigningMethod = errors.New(<span class="string">&quot;Invalid signing method&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>出现大块常量或变量定义时，可在前面注释一个总的说明，然后在每一行常量的前一行或末尾详细注释该常量的定义，比如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Code must start with 1xxxxx.    </span></span><br><span class="line"><span class="keyword">const</span> (                         </span><br><span class="line">    <span class="comment">// ErrSuccess - 200: OK.          </span></span><br><span class="line">    ErrSuccess <span class="keyword">int</span> = <span class="literal">iota</span> + <span class="number">100001</span>    </span><br><span class="line">                                                   </span><br><span class="line">    <span class="comment">// ErrUnknown - 500: Internal server error.    </span></span><br><span class="line">    ErrUnknown    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ErrBind - 400: Error occurred while binding the request body to the struct.    </span></span><br><span class="line">    ErrBind    </span><br><span class="line">                                                  </span><br><span class="line">    <span class="comment">// ErrValidation - 400: Validation failed.    </span></span><br><span class="line">    ErrValidation </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="结构体-1"><a href="#结构体-1" class="headerlink" title="结构体"></a>结构体</h4><p>导出的结构体或者接口都必须有注释，格式为 <code>// 结构体名 结构体描述.</code>。</p>
<p>结构体内的可导出成员变量名，如果意义不明确，必须要给出注释，放在成员变量的前一行或同一行的末尾。比如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User represents a user restful resource. It is also used as gorm model.</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Standard object&#x27;s metadata.</span></span><br><span class="line">    metav1.ObjectMeta <span class="string">`json:&quot;metadata,omitempty&quot;`</span></span><br><span class="line"></span><br><span class="line">    Nickname <span class="keyword">string</span> <span class="string">`json:&quot;nickname&quot; gorm:&quot;column:nickname&quot;`</span></span><br><span class="line">    Password <span class="keyword">string</span> <span class="string">`json:&quot;password&quot; gorm:&quot;column:password&quot;`</span></span><br><span class="line">    Email    <span class="keyword">string</span> <span class="string">`json:&quot;email&quot; gorm:&quot;column:email&quot;`</span></span><br><span class="line">    Phone    <span class="keyword">string</span> <span class="string">`json:&quot;phone&quot; gorm:&quot;column:phone&quot;`</span></span><br><span class="line">    IsAdmin  <span class="keyword">int</span>    <span class="string">`json:&quot;isAdmin,omitempty&quot; gorm:&quot;column:isAdmin&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p>导出的函数或者方法都必须有注释，格式为 <code>// 函数名 函数描述.</code>，比如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BeforeUpdate run before update database record.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Policy)</span> <span class="title">BeforeUpdate</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// normal code</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><p>每个需要导出的类型定义和类型别名都必须有注释说明，格式为 <code>// 类型名 类型描述.</code>，比如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Code defines an error code type.</span></span><br><span class="line"><span class="keyword">type</span> Code <span class="keyword">int</span></span><br></pre></td></tr></table></figure>

<h3 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h3><p>最常用的几种：</p>
<ul>
<li><p>  创建型：单例，简单工厂，抽象工厂，工厂方法。</p>
</li>
<li><p>  结构型：策略，模板。</p>
</li>
<li><p>  行为型：代理，选项。</p>
</li>
</ul>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/1e32f9d8318c8968b50e9ea7e89bbe01.png" alt="img"></p>
<p>具体实现参考 <a target="_blank" rel="noopener" href="https://github.com/yipwinghong/learning-go/tree/main/src/design_pattern">learning-go/src/design_pattern</a>。</p>
<h3 id="静态检查"><a href="#静态检查" class="headerlink" title="静态检查"></a>静态检查</h3><p>建议使用 golangci-lint，优点是速度快、可配置、可集成 IDE、支持 linter 聚合器、误报数小、输出良好。</p>
<p>常用命令：run、cache、completion、config、linters 等，配置参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/.golangci.yaml">iam/.golangci.yaml</a>。</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/34617a68604b7b5613948f89230c7a42.png" alt="img"></p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/79e517e6a7fd3882ce30320f28aa7088.png" alt="img"></p>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><p>对当前目录及子目录下的所有 Go 文件进行检查：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">golangci-lint run</span><br><span class="line"><span class="meta">#</span><span class="bash"> golangci-lint run ./...</span></span><br></pre></td></tr></table></figure>

<p>对指定的 Go 文件或者指定目录下的 Go 文件进行检查：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">golangci-lint run -c .golangci.yaml ./...</span><br></pre></td></tr></table></figure>

<p>根据指定配置文件，进行检查：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">golangci-lint run -c .golangci.yaml ./...</span><br></pre></td></tr></table></figure>

<p>运行指定的 linter：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可不指定配置文件运行默认启用的 linter，查看：</span></span><br><span class="line">golangci-lint help linters</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 传入参数 -E/--<span class="built_in">enable</span> 使某个 linter 可用，或使用 -D/--<span class="built_in">disable</span> 参数使某个 linter 不可用。</span></span><br><span class="line">golangci-lint run --no-config --disable-all -E errcheck ./...</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下，golangci-lint 从当前目录逐层往上寻找配置文件名 .golangci.yaml、.golangci.toml、.golangci.json 直到根目录。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 为防止读取到未知的配置文件可用 --no-config 使之不读取任何配置文件。</span></span><br></pre></td></tr></table></figure>

<p>禁止运行指定的 liner：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">golangci-lint run --no-config -D godot,errcheck</span><br></pre></td></tr></table></figure>

<p>为减少误报，可以：</p>
<ul>
<li><p>  在命令行中添加 <code>-e</code> 参数，或在配置文件的 <code>issues.exclude</code> 部分设置要排除的检查错误。也可以使用 <code>issues.exclude-rules</code> 配置哪些文件忽略哪些 linter。</p>
</li>
<li><p>  通过 <code>run.skip-dirs</code>、<code>run.skip-files</code> 或者 <code>issues.exclude-rules</code> 配置项来忽略指定目录下的所有 Go 文件或指定的 Go 文件。</p>
</li>
<li><p>  通过在 Go 源码文件中添加 <code>//nolint</code> 注释忽略指定的代码行。</p>
</li>
</ul>
<p>使用 nolint：</p>
<ul>
<li><p>  如果启用了 nolintlint，需要在 <code>//nolint</code> 后面添加 nolint 的原因 <code>// xxxx</code>。</p>
</li>
<li><p>  应该是 <code>//nolint</code>，需要程序读取的注释后面不应该有空格。</p>
</li>
<li><p>  如果要忽略所有 linter，可以用 <code>//nolint</code>；如果要忽略某个指定的 linter，可以用 <code>//nolint:&lt;linter1&gt;,&lt;linter2&gt;</code>。</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 忽略某一行所有 linter 的检查。</span></span><br><span class="line"><span class="keyword">var</span> bad_name <span class="keyword">int</span> <span class="comment">//nolint</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 忽略某一行指定 linter 的检查，可以指定多个 linter，用逗号隔开。</span></span><br><span class="line"><span class="keyword">var</span> bad_name <span class="keyword">int</span> <span class="comment">//nolint:golint,unused</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 忽略某个代码块的检查。</span></span><br><span class="line"><span class="comment">//nolint</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">allIssuesInThisFunctionAreExcluded</span><span class="params">()</span> *<span class="title">string</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//nolint:govet</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  a <span class="keyword">int</span></span><br><span class="line">  b <span class="keyword">int</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 忽略某个文件的指定 linter 检查。</span></span><br><span class="line"><span class="comment">//nolint:unparam</span></span><br><span class="line"><span class="keyword">package</span> pkg</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h4><p><strong>第一次修改可以按目录修改</strong>：为减轻修改的压力，可按目录检查代码并修改。可有效减少失败条数，减轻修改压力。如果错误太多，想以后慢慢修改或者不修复存量的 issues，可使用 golangci-lint 的 <code>--new-from-rev</code> 选项只检查新增的 code。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">golangci-lint run --new-from-rev=HEAD~1</span><br></pre></td></tr></table></figure>

<p><strong>按文件修改，减少文件切换次数，提高修改效率</strong>：如果有很多检查错误，涉及很多文件，建议先修改一个文件，避免来回切换。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 通过 grep 过滤出某个文件的检查失败项</span></span><br><span class="line">golangci-lint run ./...| grep pkg/storage/redis_cluster.go</span><br><span class="line"><span class="meta">#</span><span class="bash"> pkg/storage/redis_cluster.go:16:2: <span class="string">&quot;github.com/go-redis/redis/v7&quot;</span> imported but not used (typecheck)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkg/storage/redis_cluster.go:82:28: undeclared name: `redis` (typecheck)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkg/storage/redis_cluster.go:86:14: undeclared name: `redis` (typecheck)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ...</span></span><br></pre></td></tr></table></figure>

<p><strong>把 linters-setting.lll.line-length 设置得大一些</strong>：建议将 <code>linters-setting.lll.line-length</code> 设置为 120/240。</p>
<p><strong>尽可能多地使用 golangci-lint 提供的 linter</strong>：使用 <code>golangci-lint linters</code> 可查看，包括默认启用和禁用的。其中还包括 fast（可缓存类型信息，后续运行快）或 auto-fix（自动修复发现的错误）两个属性。使用的 linter 越多，检查越严格，意味着代码越规范，质量越高。如果时间和精力允许，建议打开 golangci-lint 提供的所有 linter。</p>
<p><strong>每次修改代码后，都要执行 golangci-lint</strong>：及时修改不规范的地方，减少错误堆积、减轻后续修改压力。</p>
<p><strong>根目录下放置通用的 golangci-lint 配置文件</strong>。</p>
<h3 id="日志处理"><a href="#日志处理" class="headerlink" title="日志处理"></a>日志处理</h3><p>打印日志：</p>
<ul>
<li><p>  <strong>在分支语句处打印</strong>。可判断出代码走了哪个分支，有助于判断请求的下一跳，继而继续排查问题。</p>
</li>
<li><p>  <strong>写操作必须打印</strong>。写操作最可能引起比较严重的业务故障，写操作打印日志可在出问题时找到关键信息。</p>
</li>
<li><p>  <strong>在循环中打印要慎重</strong>。如果循环次数过多会导致打印大量日志，严重拖累代码的性能，建议在循环中记录要点，在循环外面总结打印。</p>
</li>
<li><p>  <strong>在错误产生的最原始位置打印</strong>。对于嵌套 Error，可在 Error 产生的最初位置打印 Error 日志，上层如果不需要添加必要的信息，可直接返回下层 Error（减少重复的日志打印）。</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    flag.Parse()</span><br><span class="line">    <span class="keyword">defer</span> glog.Flush()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := loadConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        glog.Error(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadConfig</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> decodeConfig() <span class="comment">// 直接返回</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decodeConfig</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := readConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;could not decode configuration data for user %s: %v&quot;</span>, <span class="string">&quot;colin&quot;</span>, err) <span class="comment">// 添加必要的信息，用户名称</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readConfig</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    glog.Errorf(<span class="string">&quot;read: end of input.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;read: end of input&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h4><ul>
<li><p>  Debug：在开发测试阶段打印最详尽的信息（比如整个 HTTP 请求/响应的 Body）有助于 Debug，由于可能会严重拖慢性能，在上线时必须禁用。</p>
</li>
<li><p>  Info：记录有助于运营分析的有用信息，目标是满足需求但不至于日志量太大、频度过高。</p>
</li>
<li><p>  Warn：提示程序异常，一般是业务层面上不符合预期但不影响继续运行，或暂时影响但后续会恢复的情况。</p>
</li>
<li><p>  Error：提示程序出错（大部分），比如请求失败、创建资源失败等。需要记录以避免日后排障过程中被忽略。</p>
</li>
<li><p>  Panic：实际开发中很少用，通常只在需要错误堆栈，或不希望发生严重错误导致程序退出而采用 defer 处理错误时使用。</p>
</li>
<li><p>  Fatal：实际开发中很少用，此时问题相当严重，导致整个程序无法运行。</p>
</li>
</ul>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">无发生错误 +<span class="params">---</span> 开发调试时需要：Debug</span><br><span class="line">          +<span class="params">---</span> 非开发调试时也需要：info</span><br><span class="line">             </span><br><span class="line">发生错误   +<span class="params">---</span> 基本无影响/影响暂时：Warn</span><br><span class="line">          +<span class="params">---</span> 影响有限/只影响某次请求：Error</span><br><span class="line">          |                       </span><br><span class="line">          +<span class="params">---</span> 肯定会出现严重问题 <span class="params">---</span>+<span class="params">---</span> defer 处理后可运行：Panic</span><br><span class="line">                                   +<span class="params">---</span> 完全无法运行：Fatal</span><br></pre></td></tr></table></figure>

<h4 id="日志内容"><a href="#日志内容" class="headerlink" title="日志内容"></a>日志内容</h4><ul>
<li><p>  避免输出敏感信息，例如密码、密钥等。</p>
</li>
<li><p>  为方便调试，通常在 Debug 级别记录临时日志，可以特殊字符开头，比如 <code>log.Debugf(&quot;XXXXXXXXXXXX-1:Input key was: %s&quot;, setKeyName) </code>。完成调试后可查找 <code>XXXXXXXXXXXX</code> 字符串找到临时日志，commit 前删除。</p>
</li>
<li><p>  以小写字母开头，以 <code>.</code> 结尾，比如 <code>log.Info(&quot;update user function called.&quot;)</code> 。</p>
</li>
<li><p>  为了提高性能，尽可能明确类型，例如使用 <code>log.Warnf(&quot;init datastore: %s&quot;, err.Error())</code> 而非 <code>log.Warnf(&quot;init datastore: %v&quot;, err) </code>。</p>
</li>
<li><p>  最好包含两个信息。请求 ID（每次请求的唯一 ID可放在请求的通用日志字段中，便于过滤出某次请求）以及用户和行为（标识谁做了什么）。</p>
</li>
<li><p>  避免将普通日志记录在错误级别上。</p>
</li>
</ul>
<h4 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h4><ul>
<li><p>  开发调试、现网故障排障时，根据排障的过程优化日志打印。</p>
</li>
<li><p>  避免打印无用日志，也不要遗漏关键信息，目标是仅凭借关键日志就能定位到问题。</p>
</li>
<li><p>  支持动态输出，方便线上问题定位。</p>
</li>
<li><p>  总是将记录在本地文件，与日志平台解耦（确保中间出错时仍能记录日志）。</p>
</li>
<li><p>  应用可能包含多个服务，一个服务包含多个实例，应集中化日志存储处理。</p>
</li>
<li><p>  结构化日志记录，即添加默认通用字段到每行日志，方便日志查询和分析。</p>
</li>
<li><p>  日志可分布在不同的组件、机器上，使用 RequestID 串联请求日志可提高排障效率。</p>
</li>
<li><p>  支持动态开关 Debug 日志，可避免为排查问题调整日志级别时重启服务。</p>
</li>
</ul>
<p>日志包设计参考：<a target="_blank" rel="noopener" href="https://github.com/marmotedu/gopractise-demo/tree/main/log/cuslog">gopractise-demo/log/cuslog</a>，<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/master/pkg/log">iam/pkg/log</a>。</p>
<h3 id="应用构建"><a href="#应用构建" class="headerlink" title="应用构建"></a>应用构建</h3><p>应用功能：</p>
<ul>
<li>  API 服务：通过对外提供 HTTP/RPC 接口来完成指定的功能。</li>
<li>  非 API 服务：通过监听、定时运行等方式。</li>
</ul>
<p>其应用框架应包括：</p>
<ul>
<li><p>  解析命令行参数（Pflag ）：解析命令行参数，可影响命令运行效果。</p>
</li>
<li><p>  解析配置文件（Viper）：大型应用具有很多参数，便于管理和配置，通常会将参数放在配置文件中，供程序读取并解析。</p>
</li>
<li><p>实现命令行框架（Cobra）：应用通过命令启动。包含功能：</p>
<ul>
<li><p>  打印帮助提示信息。</p>
</li>
<li><p>  解析命令行参数和配置文件。</p>
</li>
<li><p>  初始化业务代码，并最终启动业务进程。</p>
</li>
</ul>
</li>
</ul>
<p>构建应用框架注意（参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/master/pkg/app">iam/pkg/app</a>）：</p>
<ul>
<li><p>  清晰易读、扩展性强。</p>
</li>
<li><p>  至少支持命令行选项：-h 打印帮助信息，-v 打印应用程序的版本，-c 指定配置文件路径。</p>
</li>
<li><p>  如果应用有很多命令行选项，建议支持 –secure.bind-port 长选项，通过选项名字就可以知道选项作用。</p>
</li>
<li><p>  配置文件使用 yaml 格式，能支持复杂的配置，且清晰易读。</p>
</li>
<li><p>  如果有多个服务，要保持所有服务的应用构建方式一致的。</p>
</li>
</ul>
<h2 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h2><p>Go 测试文件名必须以 <code>_test.go</code> 结尾。如果不是必须使用黑盒测试，在做单元测试时要尽量使用白盒测试：这是 go test 工具的默认行为，而且使用白盒测试可以测试和使用不可导出的标识符。</p>
<ul>
<li><p>  <strong>白盒测试</strong>：将测试和生产代码放在同一个 Go 包中，这使可以同时测试 Go 包中可导出和不可导出的标识符。编写单元测试需要访问 Go 包中不可导出的变量、函数和方法时，就需要编写白盒测试用例。</p>
</li>
<li><p>  <strong>黑盒测试</strong>：将测试和生产代码放在不同的 Go 包中。仅可测试 Go 包的可导出标识符。测试包无法访问生产代码中的任何内部函数、变量或常量。</p>
</li>
</ul>
<p>命名规范：</p>
<ul>
<li>  测试用例函数必须以 <code>Test</code>、<code>Benchmark</code>、<code>Example</code> 开头，例如 <code>TestXxx</code>、<code>BenchmarkXxx</code>、<code>ExampleXxx</code>（Go 和 test 工具约束），Xxx 部分首字母大写（一般是函数名结合某些场景描述）。</li>
</ul>
<ul>
<li>  变量名应尽可能短，且距离声明越远、对名称的描述性要求越高。循环、索引之类的变量，名称可以是单个字母；对于不常见的变量和全局变量，则要求更多的描述性。</li>
</ul>
<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>用于测试代码功能是否正常，其函数名称必须以 <code>Test</code> 开头，参数为 <code>t *testing.T</code>，无返回值。参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/pkg/log/log_test.go#L52-L62">iam/log_test.go</a>、<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/service_test.go">iam/service_test.go</a>。</p>
<p>编写测试的时机：</p>
<ul>
<li><p>  TDD（测试驱动开发）</p>
</li>
<li><p>  增量测试（与编码同步）</p>
</li>
<li><p>  存量测试（编码后）</p>
</li>
</ul>
<p>通过对比预期输出（expected/got）与实际输出（got/want）判断单元测试是否通过。建议使用工具 <a target="_blank" rel="noopener" href="https://github.com/cweill/gotests">cweill/gotests</a> 生成测试模板，再填充测试用例（参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/pkg/util/gormutil/gorm_test.go">iam/gorm_test.go</a>）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// go get -u github.com/cweill/gotests/...</span></span><br><span class="line"><span class="comment">// cd targetDir &amp;&amp; gotests -all -w .</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestXxx</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Add function input parameter definition.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">type</span> want <span class="keyword">struct</span> &#123;</span><br><span class="line">         <span class="comment">// <span class="doctag">TODO:</span> Add function return parameter definition.</span></span><br><span class="line">    &#125;</span><br><span class="line">    tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">        name <span class="keyword">string</span></span><br><span class="line">        args args</span><br><span class="line">        want want</span><br><span class="line">    &#125;&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Add test cases.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> got := Xxx(tt.args); got != tt.want &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;Xxx() = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// go test -v -run=&#x27;Test.*&#x27; -count=2</span></span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="https://github.com/stretchr/testify">stretchr/testify</a> 提供的 <code>assert</code> 实现断言：</p>
<ul>
<li><p>  友好的输出结果，易于阅读。</p>
</li>
<li><p>  减少 <code>if got := Xxx(); got != tt.wang &#123;&#125;</code> 的判断，使代码简洁。</p>
</li>
<li><p>  可针对每次断言添加额外的消息说明：<code>assert.Equal(t, got, tt.want, &quot;Abs test&quot;)</code>。</p>
</li>
</ul>
<h4 id="Mock-测试"><a href="#Mock-测试" class="headerlink" title="Mock 测试"></a>Mock 测试</h4><p>单元测试不允许有外部依赖，可使用 <a target="_blank" rel="noopener" href="https://github.com/golang/mock">golang/mock</a> 工具模拟，参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/gopractise-demo/tree/master/gomock">gopractise-demo/gomock</a>。</p>
<p>需要安装 GoMock 包和 mockgen 工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/golang/mock/gomock</span><br><span class="line">go install github.com/golang/mock/mockgen</span><br></pre></td></tr></table></figure>

<p>使用 mockgen 工具生成 Mock 接口的实现：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tree .</span><br><span class="line"><span class="meta">#</span><span class="bash"> .</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ├── go_version.go</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ├── main.go</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> └── spider</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     └── spider.go</span></span><br><span class="line"></span><br><span class="line">mockgen -destination spider/mock/mock_spider.go -package spider github.com/marmotedu/gopractise-demo/gomock/spider Spider</span><br><span class="line"></span><br><span class="line">tree .</span><br><span class="line"><span class="meta">#</span><span class="bash"> .</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ├── go_version.go</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ├── go_version_test.go</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ├── go_version_test_traditional_method.go~</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> └── spider</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     ├── mock</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     │   └── mock_spider.go</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     └── spider.go</span></span><br></pre></td></tr></table></figure>

<p>使用基于 mockgen 生成的单元测试用例即可使用 Mock 测试。其它用法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 源码模式</span></span><br><span class="line">mockgen -destination spider/mock/mock_spider.go -package spider -source spider/spider.go</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 反射模式</span></span><br><span class="line">mockgen -destination spider/mock/mock_spider.go -package spider github.com/marmotedu/gopractise-demo/gomock/spider Spider</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用注释生成（在接口文件代码中添加注释）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> //go:generate mockgen -destination mock_spider.go -package spider github.com/cz-it/blog/blog/Go/testing/gomock/example/spider Spider</span></span><br><span class="line">go generate ./...</span><br></pre></td></tr></table></figure>

<p>基本流程：</p>
<ul>
<li><p>  创建 Mock 控制器：<code>ctrl := gomock.NewController(t)</code>。</p>
</li>
<li><p>  将 <code>*testing.T</code> 传递给 GoMock 生成 Controller 对象。在操作完后需要回收：<code>defer ctrl.Finish()</code>。</p>
</li>
<li><p>  调用 Mock 对象：<code>mockSpider := spider.NewMockSpider(ctrl)</code>。</p>
</li>
<li><p>  以链式调用断言方法：<code>mockSpider.EXPECT().GetBody(gomock.Any(), gomock.Eq(&quot;admin&quot;)).Return(&quot;go1.8.3&quot;).Times(3)</code>。</p>
</li>
<li><p>  执行单元测试：<code>go test -v</code>。</p>
</li>
</ul>
<blockquote>
<p>  如果需要指定执行顺序（比如先 Init、再 Recv）：</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">initCall := mockSpider.EXPECT().Init()</span><br><span class="line">mockSpider.EXPECT().Recv().After(initCall)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Mock 代码参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go">iam/user_test.go</a>，Mock 测试用例参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/controller/v1/user/create_test.go">iam/create_test.go</a>，使用 <code>go generate ./...</code> 在根目录下生成。</p>
<h4 id="覆盖率"><a href="#覆盖率" class="headerlink" title="覆盖率"></a>覆盖率</h4><p>测试并生成覆盖率数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">go test -race -cover  -coverprofile=./coverage.out -timeout=10m -short -v ./...</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> some setup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PASS</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> coverage: 40.0% of statements</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> some cleanup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ok    github.com/marmotedu/gopractise-demo/<span class="built_in">test</span>  0.003s</span></span><br></pre></td></tr></table></figure>

<p>覆盖率分析：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">go tool cover -func ./coverage.out</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> some setup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PASS</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> coverage: 40.0% of statements</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> some cleanup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ok    github.com/marmotedu/gopractise-demo/<span class="built_in">test</span>  0.003s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [colin@dev <span class="built_in">test</span>]$ go tool cover -func=coverage.out</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> github.com/marmotedu/gopractise-demo/<span class="built_in">test</span>/math.go:9:  Abs    100.0%</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> github.com/marmotedu/gopractise-demo/<span class="built_in">test</span>/math.go:14:  Max    100.0%</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> github.com/marmotedu/gopractise-demo/<span class="built_in">test</span>/math.go:19:  Min    0.0%</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> github.com/marmotedu/gopractise-demo/<span class="built_in">test</span>/math.go:24:  RandInt    0.0%</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> github.com/marmotedu/gopractise-demo/<span class="built_in">test</span>/math.go:29:  Floor    0.0%</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> total:              (statements)  40.0%</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或生成 HTML 文件</span></span><br><span class="line">go tool cover -html=coverage.out -o coverage.html</span><br></pre></td></tr></table></figure>

<h4 id="模型层（Models）测试"><a href="#模型层（Models）测试" class="headerlink" title="模型层（Models）测试"></a>模型层（Models）测试</h4><p>不依赖其他任何层，只需要测试其中定义的结构及其函数和方法即可。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/api/tree/master/apiserver/v1">api/apiserver/v1</a>。</p>
<h4 id="控制层（Controller）测试"><a href="#控制层（Controller）测试" class="headerlink" title="控制层（Controller）测试"></a>控制层（Controller）测试</h4><p>依赖于业务层，可使用 <a target="_blank" rel="noopener" href="https://github.com/golang/mock">golang/mock</a> mock 业务层测试（<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/controller/v1/user/create_test.go#L19">iam/create_test.go</a>）。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/controller">iam/internal/apiserver/controller</a>。</p>
<h4 id="业务层-（Service）测试"><a href="#业务层-（Service）测试" class="headerlink" title="业务层 （Service）测试"></a>业务层 （Service）测试</h4><p>依赖于仓库层，可使用 <a target="_blank" rel="noopener" href="https://github.com/golang/mock">golang/mock</a> mock 仓库层（<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/secret_test.go#L19">iam/secret_test.go</a>）或开发一个 fack 仓库层（<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/user_test.go#L76">iam/user_test.go</a>）测试。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/service/v1">iam/internal/apiserver/service/v1</a>。</p>
<h4 id="仓库层（Repository）测试"><a href="#仓库层（Repository）测试" class="headerlink" title="仓库层（Repository）测试"></a>仓库层（Repository）测试</h4><p>依赖于数据库或其它微服务，可通过 <a target="_blank" rel="noopener" href="https://github.com/DATA-DOG/go-sqlmock">DATA-DOG/go-sqlmock</a> 模拟数据库连接、通过 <a target="_blank" rel="noopener" href="https://github.com/jarcoal/httpmock">jarcoal/httpmock</a> 模拟 HTTP 请求。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/store">iam/internal/apiserver/store</a>。</p>
<h3 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h3><p>测试代码性能是否满足需求，其函数名称必须以 <code>Benchmark</code> 开头，参数为 <code>t *testing.B</code>，无返回值（参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go#L27-L41">iam/user_test.go</a>）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkListUser</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    b.ResetTimer()    <span class="comment">// 重置性能测试计数。</span></span><br><span class="line">    opts := metav1.ListOptions&#123;</span><br><span class="line">        Offset: pointer.ToInt64(<span class="number">0</span>),</span><br><span class="line">        Limit:  pointer.ToInt64(<span class="number">50</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    storeIns, _ := fake.GetFakeFactoryOr()</span><br><span class="line">    u := &amp;userService&#123;</span><br><span class="line">        store: storeIns,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        _, _ = u.List(context.TODO(), opts)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">go test -bench=&quot;.*&quot; -benchmem</span><br><span class="line"><span class="meta">#</span><span class="bash"> goos: linux</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> goarch: amd64</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkg: github.com/marmotedu/gopractise-demo/31/<span class="built_in">test</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> BenchmarkRandInt-4      96776823                12.8 ns/op             0 B/op          0 allocs/op</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PASS</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ok      github.com/marmotedu/gopractise-demo/31/<span class="built_in">test</span>    1.255s</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -benchmem 输出内存分配统计，还可以指定测试时间（-benchtime）、超时时间（-timeout）d</span></span><br></pre></td></tr></table></figure>

<h3 id="示例测试"><a href="#示例测试" class="headerlink" title="示例测试"></a>示例测试</h3><p>Godoc 将在函数文档旁提供其示例。示例测试函数名称必须以 <code>Example</code> 开头，无参数，无返回值。函数的结尾可能包含以 <code>Output:</code> 或 <code>Unordered output:</code> 开头的注释。<code>Unordered output:</code> 开头的注释会忽略输出行的顺序。参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/errors/blob/v1.0.2/example_test.go">errors/example_test.go</a>。</p>
<p>在执行 <code>go test</code> 时会自动执行这些测试，将示例测试输出到标准输出的内容与注释作对比（忽略行前后的空格）。相等通过，否则不通过。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s: %d&quot;</span>, p.Name, p.Age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ByAge implements sort.Interface for []Person based on</span></span><br><span class="line"><span class="comment">// the Age field.</span></span><br><span class="line"><span class="keyword">type</span> ByAge []Person</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByAge)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(a) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByAge)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; a[i], a[j] = a[j], a[i] &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByAge)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> a[i].Age &lt; a[j].Age &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// func Example_second() &#123;...&#125;</span></span><br><span class="line"><span class="comment">// func Example_third() &#123;...&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Example</span><span class="params">()</span></span> &#123;</span><br><span class="line">    people := []Person&#123;</span><br><span class="line">        &#123;<span class="string">&quot;Bob&quot;</span>, <span class="number">31</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;John&quot;</span>, <span class="number">42</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;Michael&quot;</span>, <span class="number">17</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;Jenny&quot;</span>, <span class="number">26</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(people)</span><br><span class="line">    sort.Sort(ByAge(people))</span><br><span class="line">    fmt.Println(people)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Output:</span></span><br><span class="line">    <span class="comment">// [Bob: 31 John: 42 Michael: 17 Jenny: 26]</span></span><br><span class="line">    <span class="comment">// [Michael: 17 Jenny: 26 Bob: 31 John: 42]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TestMain"><a href="#TestMain" class="headerlink" title="TestMain"></a>TestMain</h4><p>测试用例在执行时会先执行 <code>TestMain</code> 函数，可以在 <code>TestMain</code> 中调用 <code>m.Run()</code> 函数执行普通的测试函数。参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go">iam/user_test.go</a>。</p>
<p>可在 <code>m.Run()</code> 函数前面编写准备逻辑，在 <code>m.Run()</code> 后面编写清理逻辑。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMain</span><span class="params">(m *testing.M)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;do some setup&quot;</span>)</span><br><span class="line">    _, _ = fake.GetFakeFactoryOr()</span><br><span class="line">    os.Exit(m.Run())</span><br><span class="line">    fmt.Println(<span class="string">&quot;do some cleanup&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">go test -v</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> some setup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> === RUN   TestAbs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --- PASS: TestAbs (0.00s)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ...</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> === RUN   ExampleMax</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --- PASS: ExampleMax (0.00s)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PASS</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> some cleanup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ok    github.com/marmotedu/gopractise-demo/31/<span class="built_in">test</span>  0.006s</span></span><br></pre></td></tr></table></figure>

<h3 id="Fake-测试"><a href="#Fake-测试" class="headerlink" title="Fake 测试"></a>Fake 测试</h3><p>对于比较复杂的接口，可以 Fake 一个接口实现来进行测试。即针对接口实现假的实例。Fake 实例需要根据业务自行实现。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/store/fake">iam/internal/apiserver/store/fake</a>。通过 <code>TestMain</code> 初始化 fake 实例（<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/store/store.go#L12-L17">iam/store.go</a>）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 fake users、secrets、policies，并保存在了 fakeFactory 变量中供后面的测试用例使用，例如 BenchmarkListUser、Test_newUsers 等。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetFakeFactoryOr</span><span class="params">()</span> <span class="params">(store.Factory, error)</span></span> &#123;</span><br><span class="line">    once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fakeFactory = &amp;datastore&#123;</span><br><span class="line">            users:    FakeUsers(ResourceCount),</span><br><span class="line">            secrets:  FakeSecrets(ResourceCount),</span><br><span class="line">            policies: FakePolicies(ResourceCount),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> fakeFactory == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to get mysql store fatory, mysqlFactory: %+v&quot;</span>, fakeFactory)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fakeFactory, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><p>常用性能指标说明：</p>
<ul>
<li><p>  <strong>并发数</strong>（Concurrent）：某个时间范围内，同时在使用系统的用户个数。广义上的并发数是指同时使用系统的用户个数，用户可能调用不同的 API；严格意义上并发数指同时请求同一个 API 的用户个数。并发数设置过大时 API 同时处理大量请求，频繁切换上下文可能导致 QPS 降低，延长请求响应时间。</p>
</li>
<li><p>  <strong>每秒查询数</strong>（QPS）：对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。QPS = 并发数 / 平均请求响应时间。描述 QPS 时必须需要指明并发数，QPS 相同时并发数越大，API 性能越好。一般会指明在“某一并发数下，QPS 可达到最大，此时为最佳并发数”。</p>
</li>
<li><p>  <strong>请求响应时间</strong>（TTLB）：从客户端发出请求到得到响应的整个时间。从客户端发起的一个请求开始，到客户端收到服务器端的响应结束（即从发送一个请求开始，到客户端收到最后一个字节的响应为止所消费的时间）。单位一般为“秒”或“毫秒”。</p>
</li>
</ul>
<blockquote>
<p>  在有些 API 接口中，也会测试 API 接口的 TPS（Transactions Per Second，每秒事务数）。一个事务是指客户端向服务器发送请求，到收到服务器响应的过程，TPS 即计算使用的时间和完成的事务个数。</p>
<p>  对单场景下一个接口压测，且该接口内部不再请求其他接口，则 TPS=QPS，否则 TPS≠QPS；对混合场景下多个接口压测，如 N 个接口都是查询接口，且接口内部不再请求其他接口，则 QPS=N*TPS。</p>
</blockquote>
<h4 id="使用-wrk"><a href="#使用-wrk" class="headerlink" title="使用 wrk"></a>使用 wrk</h4><p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/wg/wrk</span><br><span class="line"></span><br><span class="line">cd wrk</span><br><span class="line">make</span><br><span class="line">sudo cp ./wrk /usr/bin</span><br></pre></td></tr></table></figure>

<p>基本使用：线程数为 CPU 核数 2~4 倍即可，避免切换过多造成效率降低。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 指定线程数、并发数、持续时间、超时时间、打印延迟，也可以指定 Lua 脚本实现复杂的请求。</span></span><br><span class="line">wrk -t144 -c30000 -d30s -T30s --latency http://10.0.4.57:8080/healthz</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Running 30s <span class="built_in">test</span> @ http://10.0.4.57:8080/healthz</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   144 threads and 30000 connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   Thread Stats   Avg      Stdev     Max   +/- Stdev</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     Latency   508.77ms  604.01ms   9.27s    81.59%</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     Req/Sec   772.48      0.94k   10.45k    86.82%</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   Latency Distribution</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      50%  413.35ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      75%  948.99ms</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      90%    1.33s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      99%    2.44s</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   2276265 requests <span class="keyword">in</span> 30.10s, 412.45MB <span class="built_in">read</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   Socket errors: connect 1754, <span class="built_in">read</span> 40, write 0, timeout 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Requests/sec:  75613.16</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Transfer/sec:     13.70MB</span></span><br></pre></td></tr></table></figure>

<p>测试分析流程参考：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/410920">39｜性能分析（下）：API Server性能测试和调优实战</a>。</p>
<h4 id="API-性能参考"><a href="#API-性能参考" class="headerlink" title="API 性能参考"></a>API 性能参考</h4><table>
<thead>
<tr>
<th>指标</th>
<th>要求</th>
</tr>
</thead>
<tbody><tr>
<td>响应时间</td>
<td>&lt;500ms，否则需要优化。</td>
</tr>
<tr>
<td>请求成功率</td>
<td>99.95%</td>
</tr>
<tr>
<td>QPS</td>
<td>满足预期的情况下，服务器状态稳定，单机 QPS 在 1000+。</td>
</tr>
</tbody></table>
<p>注意事项：</p>
<ul>
<li><p>  框架性能：在设计阶段确定 Web 框架，需要对框架本身有初步测试，要求其在性能和稳定性上足够优秀；在上线之前需要再次测试，确保按照最终使用方式，框架性能和稳定性仍然能满足要求。通常通过足够简单、不掺杂任何逻辑的接口测试框架性能，比如 <code>/healthz</code> 健康检查接口，返回最小内容即可。</p>
</li>
<li><p>  API 性能：对于读接口可使用压测工具模拟大量请求测试重要的接口。对于写接口为避免磁盘空间写满、数据库被压垮，可借助单元测试来测试其性能（一般较少有性能问题）。</p>
</li>
<li><p>  测试环境：要确保不能影响到生产环境，且要保证测试方法和测试环境一致，最好实现测试自动化。</p>
</li>
</ul>
<h2 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h2><h3 id="采集数据"><a href="#采集数据" class="headerlink" title="采集数据"></a>采集数据</h3><p>使用 Go 命令行工具生成性能数据文件：</p>
<ul>
<li><p>  v1.test，测试生成的二进制文件，进行性能分析时用于解析各种符号。</p>
</li>
<li><p>  cpu.profile，CPU 性能数据文件。</p>
</li>
<li><p>  mem.profile，内存性能数据文件。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go test -benchtime=30s -benchmem -bench=&quot;.*&quot; -cpuprofile cpu.profile -memprofile mem.profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> goos: linux</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> goarch: amd64</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pkg: github.com/marmotedu/iam/internal/apiserver/service/v1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cpu: AMD EPYC Processor</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> BenchmarkListUser-8          280     4283077 ns/op</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PASS</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ok    github.com/marmotedu/iam/internal/apiserver/service/v1  1.798s</span></span><br></pre></td></tr></table></figure>

<p>或使用代码生成：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cpuOut, _ := os.Create(<span class="string">&quot;cpu.out&quot;</span>)</span><br><span class="line">    <span class="keyword">defer</span> cpuOut.Close()</span><br><span class="line">    pprof.StartCPUProfile(cpuOut)</span><br><span class="line">    <span class="keyword">defer</span> pprof.StopCPUProfile()</span><br><span class="line"></span><br><span class="line">    memOut, _ := os.Create(<span class="string">&quot;mem.out&quot;</span>)</span><br><span class="line">    <span class="keyword">defer</span> memOut.Close()</span><br><span class="line">    <span class="keyword">defer</span> pprof.WriteHeapProfile(memOut)</span><br><span class="line"></span><br><span class="line">    Sum(<span class="number">3</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sum</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run pprof.go</span><br></pre></td></tr></table></figure>

<p>要分析 HTTP Server 性能，或使用 net/http/pprof 包（参考 <a target="_blank" rel="noopener" href="https://github.com/gin-contrib/pprof/blob/v1.3.0/pprof.go">pprof/pprof.go</a>、<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/v1.0.8/internal/pkg/server/genericapiserver.go#L75-L77">iam/genericapiserver.go</a>）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">(r *gin.Engine, prefixOptions ...<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    prefix := getPrefix(prefixOptions...)</span><br><span class="line"></span><br><span class="line">    prefixRouter := r.Group(prefix)</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        prefixRouter.GET(<span class="string">&quot;/profile&quot;</span>, pprofHandler(pprof.Profile))</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pprofHandler</span><span class="params">(h http.HandlerFunc)</span> <span class="title">gin</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">    handler := http.HandlerFunc(h)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        handler.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要开启 HTTP 性能分析，只需注册 HTTP Handler。</span></span><br><span class="line"><span class="comment">// 在启动服务后，访问：http:// x.x.x.x:8080/debug/pprof 查看 profiles 信息。</span></span><br><span class="line"><span class="keyword">if</span> s.enableProfiling &#123;</span><br><span class="line">    pprof.Register(s.Engine)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取性能数据文件</span></span><br><span class="line">curl http://127.0.0.1:8080/debug/pprof/profile -o cpu.profile</span><br><span class="line">curl http://127.0.0.1:8080/debug/pprof/heap -o mem.profile</span><br></pre></td></tr></table></figure>

<p>生成采用数据后，可按以下思路分析性能：</p>
<ul>
<li><p>  采样图：矩形面积最大。</p>
</li>
<li><p>  火焰图：格子最宽。</p>
</li>
<li><p>  go tool pprof：cum% 最大。</p>
</li>
</ul>
<h3 id="分析采样图"><a href="#分析采样图" class="headerlink" title="分析采样图"></a>分析采样图</h3><p>以 CPU 分析为例。Go 运行时默认以 100 Hz 的频率对 CPU 使用情况采样，即每秒采样 100 次、每 10 毫秒采样一次。每次采样时记录正在运行的函数，并统计其运行时间，生成 CPU 性能数据（cpu.profile）。</p>
<p>先安装 graphviz：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install graphviz.x86_64</span><br></pre></td></tr></table></figure>

<p>生成调用图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof -svg cpu.profile &gt; cpu.svg    # svg 格式</span><br><span class="line">go tool pprof -pdf cpu.profile &gt; cpu.pdf    # pdf 格式</span><br><span class="line">go tool pprof -png cpu.profile &gt; cpu.png    # png 格式</span><br></pre></td></tr></table></figure>

<p>其中有向线段描述了函数的调用关系（A 调用 B，A -&gt; B）。</p>
<p>矩形面积越大，表示累积采样时间越大。其中包含采样数据：</p>
<ul>
<li><p>  函数 / 方法名：包含包名、结构体名、函数名 / 方法名，方便快速定位，例如 <code>fake(*policies)List</code> 表示 <code>fake</code> 包，<code>policies</code> 结构体的 <code>List</code> 方法。</p>
</li>
<li><p>  <strong>本地采样时间</strong>：以及在采样总数中所占的比例。指采样点落在该函数中的总时间（只包含该函数本身、不包含函数体内调用其它函数占用的时间）。该数值较大说明函数本身耗时较大，应集中分析。</p>
</li>
<li><p>  <strong>累积采样时间</strong>：以及在采样总数中所占的比例。指采样点落在该函数，以及被它直接或者间接调用的函数中的总时间（整个函数执行耗时）。该数值较大未必是该函数本身有问题，可能是其调用的函数有性能瓶颈。</p>
</li>
</ul>
<h3 id="分析火焰图"><a href="#分析火焰图" class="headerlink" title="分析火焰图"></a>分析火焰图</h3><p>火焰图可把采样到的堆栈轨迹（Stack Trace）转化为直观图片显示。</p>
<p>使用 pprof 工具打开数据文件，可在浏览器中直观查看数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof -http=&quot;0.0.0.0:8081&quot; v1.test cpu.profile</span><br></pre></td></tr></table></figure>

<p>其中数据采样视图：</p>
<ul>
<li><p>  Top，类似于 linux top 的形式，从高到低排序。</p>
</li>
<li><p>  Graph，默认弹出来的就是该模式，也就是上一个图的那种带有调用关系的图。</p>
</li>
<li><p>  Flame Graph：pprof 火焰图。</p>
</li>
<li><p>  Peek：类似于 Top 也是从高到底的排序。</p>
</li>
<li><p>  Source：和交互命令式的那种一样，带有源码标注。</p>
</li>
<li><p>  Disassemble：显示所有的总量。</p>
</li>
</ul>
<p>选择火焰图（Flame Graph）：格子越宽的函数，就越可能存在性能问题。</p>
<ul>
<li><p>  每列代表一个调用栈，每个格子代表一个函数。</p>
</li>
<li><p>  纵轴展示了栈的深度，按照调用关系从上到下排列。最下面的格子代表采样时正在占用 CPU 的函数。</p>
</li>
<li><p>  调用栈在横向会按照字母排序，并且同样的调用栈会做合并。格子的宽度越大，表示该函数越可能是瓶颈。</p>
</li>
<li><p>  火焰图格子的颜色是随机的暖色调，方便区分各个调用信息。</p>
</li>
</ul>
<h3 id="分析数据"><a href="#分析数据" class="headerlink" title="分析数据"></a>分析数据</h3><p>交互式查看 CPU 性能数据文件：</p>
<ul>
<li><p>  File，二进制可执行文件名称。</p>
</li>
<li><p>  Type，采样文件的类型，例如 cpu、mem 等。</p>
</li>
<li><p>  Time，生成采样文件的时间。</p>
</li>
<li><p>  Duration，程序执行时间。程序在采样时，会自动分配采样任务给多个核心，总采样时间可能会大于总执行时间。</p>
</li>
<li><p>  (pprof)，命令行提示，表示当前在 go tool 的 pprof 工具命令行中（还包括 cgo、doc、pprof、trace 等）。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof v1.test cpu.profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> File: v1.test</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Type: cpu</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Time: Aug 17, 2021 at 2:17pm (CST)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Duration: 56.48s, Total samples = 440ms ( 0.78%)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Entering interactive mode (<span class="built_in">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (pprof)</span></span><br></pre></td></tr></table></figure>

<p>常用命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>top[N]</td>
<td>根据本地采样时间，从大到小列出函数采样数据。<br />默认列出 10 条，可执行 topN 列出 N 条。<br />-cum 参数按累积采样时间，从大到小列出函数采样数据。</td>
</tr>
<tr>
<td>list &lt;regexp&gt;</td>
<td>列出与正则表达式匹配的函数代码。</td>
</tr>
<tr>
<td>peek &lt;regexp&gt;</td>
<td>列出与正则表达式匹配的函数的调用函数和被调用函数。</td>
</tr>
</tbody></table>
<blockquote>
<p>  cum：表示采样点落在该函数中的，以及被它调用的函数中的总时间（和百分比）。</p>
</blockquote>
<blockquote>
<p>  内存的性能分析与 CPU 相似：Go 运行时系统会记录程序运行期间的所有堆内存分配。在采样的任何时刻，不管堆内存已用字节数是否有增长，只要有字节被分配且数量足够，分析器就会对它进行采样。</p>
<p>  优化的目标是减少内存分配次数以及每次分配的内存大小。</p>
</blockquote>
<h2 id="API-设计"><a href="#API-设计" class="headerlink" title="API 设计"></a>API 设计</h2><h3 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h3><p>一般用于处理对外业务。</p>
<h4 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h4><ul>
<li><p>资源名使用名词复数表示。资源分为 Collection 和 Member 两种。</p>
<ul>
<li><p>  Collection：一堆资源的集合。比如系统里有很多用户（User）, 这些用户的集合就是 Collection。Collection 的 URI 标识应该是 域名/资源名复数, 比如 https:// iam.api.marmotedu.com/users。</p>
</li>
<li><p>  Member：单个特定资源。比如系统中特定名字的用户，就是 Collection 里的一个 Member。Member 的 URI 标识应该是 域名/资源名复数/资源名称, 比如 https:// iam.api.marmotedu/users/admin。URI 结尾不应包含/。</p>
</li>
</ul>
</li>
<li><p>  URI 中不能出现下划线 _，可用中杠线 - 代替（统一一种即可）。</p>
</li>
<li><p>  URI 路径用小写。</p>
</li>
<li><p>  避免层级过深的 URI。超过 2 层的资源嵌套较乱，建议将其他资源转化为 ? 参数，比如：<code>/students?school=qinghua&amp;class=rooma</code> 以 Query 参数代替 <code>/schools/tsinghua/classes/rooma/students/zhang</code> Path 参数。</p>
</li>
</ul>
<p>当某些操作不便于映射为某个 REST 资源：</p>
<ul>
<li><p>  将操作变成资源属性，比如暂时禁用某个用户：<code>/users/zhangsan?active=false</code>。</p>
</li>
<li><p>  将操作当作是资源的嵌套资源，比如 GitHub 加星：<code>PUT /gists/:id/star</code>。</p>
</li>
<li><p>  以上都不能解决问题，则可以打破规范。比如登录操作 <code>/login</code>。</p>
</li>
</ul>
<h4 id="HTTP-方法"><a href="#HTTP-方法" class="headerlink" title="HTTP 方法"></a>HTTP 方法</h4><p>常用 GET（获取）、PUT（替换）、POST（新增）、DELETE（删除），其中 PUT 表示替换资源，不建议使用。</p>
<p>注意 <strong>安全性</strong>（不会改变资源状态，GET）和 <strong>幂等性</strong>（执行多次效果等价，GET、PUT、DELETE）。</p>
<p>关于批量删除，建议在操作路径中带多个用分隔符分隔的 id，比如：<code>DELETE /users?ids=1,2,3</code> 。可避免发送多次请求（可根据实际情况选择实现）。</p>
<h4 id="返回路径"><a href="#返回路径" class="headerlink" title="返回路径"></a>返回路径</h4><p>RESTful API 会向外界开放多个资源的接口，返回格式要保持一致；每个接口都会返回成功和失败两种消息，格式也要保持一致。</p>
<p>否则客户端代码要适配不同接口的返回格式，每个返回格式又要适配成功和失败两种消息格式，增加用户的学习和使用成本。</p>
<p>返回格式没有强制标准，可根据实际业务需要返回不同格式。</p>
<h4 id="错误码"><a href="#错误码" class="headerlink" title="错误码"></a>错误码</h4><p>错误码需要附带业务标识，且对内对外分别展示不同的错误信息（不必对外暴露内部信息）。</p>
<p>建议在 HTTP Status Code 根据错误类型设置，并在 Body 附带详细的的错误信息（简明扼要，统一大写开头，不带 <code>.</code>）。</p>
<p>业务码可覆盖场景：基本错误、数据库类错误、认证授权类错误、加解码类错误。参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/docs/guide/zh-CN/api/error_code_generated.md">iam/error_code_generated.md</a>，示例：100101</p>
<ul>
<li><p>  10：服务代号。</p>
</li>
<li><p>  01：功能模块代号。</p>
</li>
<li><p>  01：功能模块下错误码序号。</p>
</li>
</ul>
<p>HTTP Status Code 参考 HTTP 协议规范即可，一般以下几个即可满足需求：</p>
<ul>
<li><p>  200：请求成功执行。</p>
</li>
<li><p>  400：客户端错误。</p>
</li>
<li><p>  401：认证失败。</p>
</li>
<li><p>  403：授权失败。</p>
</li>
<li><p>  404：资源找不到，可以是 URL 或 RESTful 资源。</p>
</li>
<li><p>  500：服务端错误。</p>
</li>
</ul>
<p>可使用自定义的错误包以支持业务错误码，参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/errors">marmotedu/errors</a>。</p>
<h4 id="API-版本"><a href="#API-版本" class="headerlink" title="API 版本"></a>API 版本</h4><p>通常将版本标识放置在：</p>
<ul>
<li><p>  URL 中，比如 <code>/v1/users</code>。最直观，GitHub、Kubernetes、Etcd 都采用的做法。</p>
</li>
<li><p>  HTTP Header 中，比如 <code>Accept: vnd.example-com.foo+json; version=1.0</code>。</p>
</li>
<li><p>  Form 参数中，比如 <code>/users?version=v1</code>。</p>
</li>
</ul>
<h4 id="API-命名"><a href="#API-命名" class="headerlink" title="API 命名"></a>API 命名</h4><p>驼峰命名法（serverAddress）和蛇形命名法（server_address）需要切换输入法，会增加操作的复杂性，也容易出错。</p>
<p>建议用 <strong>脊柱命名法（server-address）</strong>，参考 GitHub API。</p>
<h4 id="分页-过滤-排序-搜索"><a href="#分页-过滤-排序-搜索" class="headerlink" title="分页 / 过滤 / 排序 / 搜索"></a>分页 / 过滤 / 排序 / 搜索</h4><ul>
<li><p>  分页：比如 <code>/users?offset=0&amp;limit=20</code>，可减少 API 响应延时、避免返回太多条目，导致服务器 / 客户端响应慢，甚至导致服务器 / 客户端 crash。</p>
</li>
<li><p>  过滤：如果不需要资源全部状态属性，可在 URI 参数里指定返回的属性，比如 <code>/users?fields=email,username,address</code>。</p>
</li>
<li><p>  排序：可在 URI 参数中指明排序参数，比如 <code>/users?sort=age,desc</code>。</p>
</li>
<li><p>  搜索：建议按模糊匹配来搜索。</p>
</li>
</ul>
<h4 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h4><p>建议采用 iam.api.marmotedu.com，支持 marmotedu.com 域名下扩展另一套域名系统，比如：storage.api.marmotedu.com、network.api.marmotedu.com。</p>
<h3 id="RPC-API"><a href="#RPC-API" class="headerlink" title="RPC API"></a>RPC API</h3><p>一般用于处理对内业务。</p>
<h4 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h4><p>具备以下特点：</p>
<ul>
<li><p>  调用方便：屏蔽了底层的网络通信细节、调用方便：<code>ClassName.ClassFuc(params)</code>。</p>
</li>
<li><p>  无需打包和解包：RPC 调用的入参和返回的结果都是 Go 结构体，简化了调用步骤。</p>
</li>
</ul>
<p>支持 4 种服务方法：</p>
<ul>
<li><p>  简单模式（Simple RPC）：客户端发送一次请求，服务端响应一次数据，<code>rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;</code>。</p>
</li>
<li><p>  服务端数据流模式：客户端发送请求，服务器返回数据流响应，客户端从流中读取数据直到为空，<code>rpc SayHello (HelloRequest) returns (stream HelloReply) &#123;&#125;</code>。</p>
</li>
<li><p>  客户端数据流模式：客户端将消息流发送给服务器，服务器全部处理完成后返回一次响应，<code>rpc SayHello (stream HelloRequest) returns (HelloReply) &#123;&#125;</code>。</p>
</li>
<li><p>  双向数据流模式：客户端和服务端都可同时相互发送数据流，<code>rpc SayHello (stream HelloRequest) returns (stream HelloReply) &#123;&#125;</code>。</p>
</li>
</ul>
<p>与 RESTful API 的对比：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/e6ae61fc4b0fc821f94d257239f332ab.png" alt="img"></p>
<h3 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h3><p>即由服务提供者或其它组织或个人提供的、封装后端服务 API 的软件包，通常包含相关的库、文档、使用示例、封装好的 API 接口和工具。</p>
<p>命名方式：xxx-sdk-go / xxx-sdk-python / xxx-sdk-java 等。</p>
<p>目录结构：</p>
<ul>
<li><p>  README.md：帮助文档，包含了安装、配置和使用 SDK 的方法。</p>
</li>
<li><p>  examples/sample/：使用示例。</p>
</li>
<li><p>  sdk/：SDK 共享包，封装最基础的通信功能。如果是 HTTP 服务，基本是基于 net/http 包封装。</p>
</li>
<li><p>  api：如果 xxx-sdk-go 只为某一个服务提供 SDK，可以把该服务的所有 API 封装代码存放在 api 目录下。</p>
</li>
<li><p>  services/{iam, tms} ：如果 xxx-sdk-go 中 xxx 是一个组织，这个 SDK 很可能会集成该组织中很多服务的 API，可以把某类服务 API 封装代码存放在 services/&lt;服务名&gt;下，如 AWS 的 Go SDK。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── examples            # 示例代码存放目录</span><br><span class="line">│   └── authz.go</span><br><span class="line">├── README.md           # SDK使用文档</span><br><span class="line">├── sdk                 # 公共包，封装了SDK配置、API请求、认证等代码</span><br><span class="line">│   ├── client.go</span><br><span class="line">│   ├── config.go</span><br><span class="line">│   ├── credential.go</span><br><span class="line">│   └── ...</span><br><span class="line">└── services            # API封装</span><br><span class="line">    ├── common</span><br><span class="line">    │   └── model</span><br><span class="line">    ├── iam             # iam服务的API接口</span><br><span class="line">    │   ├── authz.go</span><br><span class="line">    │   ├── client.go</span><br><span class="line">    │   └── ...</span><br><span class="line">    └── tms             # tms服务的API接口</span><br></pre></td></tr></table></figure>

<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">├── examples                        <span class="comment"># SDK 的使用示例</span></span><br><span class="line">├── Makefile                        <span class="comment"># 管理 SDK 源码，静态代码检查、代码格式化、测试、添加版权信息等</span></span><br><span class="line">├── marmotedu</span><br><span class="line">│   ├── clientset.go                <span class="comment"># clientset 实现，包含多个应用，多个服务的API接口</span></span><br><span class="line">│   ├── fake                        <span class="comment"># clientset 的 fake 实现，用于单元测试</span></span><br><span class="line">│   └── service                     <span class="comment"># 按应用进行分类，存放应用中各服务 API 接口的具体实现</span></span><br><span class="line">│       ├── iam                     <span class="comment"># iam 应用的 API 接口实现，包含多个服务</span></span><br><span class="line">│       │   ├── apiserver           <span class="comment"># iam 应用中，apiserver 服务的 API 接口，包含多个版本</span></span><br><span class="line">│       │   │   └── <span class="built_in">v1</span>              <span class="comment"># apiserver v1 版本 API 接口</span></span><br><span class="line">│       │   ├── authz               <span class="comment"># iam 应用中，authz 服务的 API 接口</span></span><br><span class="line">│       │   │   └── <span class="built_in">v1</span>              <span class="comment"># authz 服务 v1 版本接口</span></span><br><span class="line">│       │   └── iam_client.go       <span class="comment"># iam 应用的客户端，包含了 apiserver 和 authz 2 个服务的客户端</span></span><br><span class="line">│       └── tms                     <span class="comment"># tms 应用的 API 接口实现</span></span><br><span class="line">├── pkg                             <span class="comment"># 存放一些共享包，可对外暴露</span></span><br><span class="line">├── rest                            <span class="comment"># HTTP 请求的底层实现</span></span><br><span class="line">├── third_party                     <span class="comment"># 存放修改过的第三方包，例如：gorequest</span></span><br><span class="line">└── tools</span><br><span class="line">    └── clientcmd                   <span class="comment"># 用来帮助创建 rest.Config 配置的函数</span></span><br></pre></td></tr></table></figure>

<h4 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h4><p>通过 <code>Config</code> 配置创建客户端 Client，例如 <code>func NewClient(config sdk.Config) (Client, error)</code>，在配置中可以指定：</p>
<ul>
<li><p>  服务的后端地址：服务的后端地址可以通过配置文件来配置，也可以直接固化在 SDK 中，推荐后端服务地址可通过配置文件配置。</p>
</li>
<li><p>  认证信息：最常用的认证方式是通过密钥认证，也有一些是通过用户名和密码认证。</p>
</li>
<li><p>  其他配置：例如超时时间、重试次数、缓存时间等。</p>
</li>
</ul>
<p>创建的 Client 是 struct 或 interface。建议使用 interface，可以将定义和具体实现解耦。Client 的每个方法对应一个 API，比如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">    client *sdk.Request</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// req 中可指定 HTTP 请求方法、路径、消息体。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">CreateUser</span><span class="params">(req *CreateUserRequest)</span> <span class="params">(*CreateUserResponse, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// normal code</span></span><br><span class="line">    resp := &amp;CreateUserResponse&#123;&#125;</span><br><span class="line">    <span class="comment">// 发起 HTTP 请求：c.client 是 *Request 类型。</span></span><br><span class="line">    <span class="comment">// 可根据传入的请求参数 req 和 config 配置构造出请求路径、认证头和请求 Body，</span></span><br><span class="line">    <span class="comment">// 并调用 net/http 包完成最终的 HTTP 请求，将返回结果 Unmarshal 到传入的 resp 结构体中。</span></span><br><span class="line">    err := c.client.Send(req, resp)</span><br><span class="line">    <span class="keyword">return</span> resp, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="公有云厂商的-SDK-设计"><a href="#公有云厂商的-SDK-设计" class="headerlink" title="公有云厂商的 SDK 设计"></a>公有云厂商的 SDK 设计</h4><p>参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/medu-sdk-go">marmotedu/medu-sdk-go</a>。</p>
<ul>
<li><p>  API 层构建客户端实例，并调用客户端实例提供的方法来完成 API 请求，每个方法对应一个 API。API 层最终会调用基础层提供的能力来完成 REST API 请求。</p>
</li>
<li><p>  基础层通过依次执行构建请求参数（Builder）、签发并添加认证头（Signer）、执行 HTTP 请求（Request）三大步骤完成具体的 REST API 请求。</p>
</li>
</ul>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/82ebe90b0490b9a2a76e2f302dd896ce.jpg" alt="img"></p>
<h4 id="client-go-风格的-SDK-设计"><a href="#client-go-风格的-SDK-设计" class="headerlink" title="client-go 风格的 SDK 设计"></a>client-go 风格的 SDK 设计</h4><p>参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/marmotedu-sdk-go">marmotedu/marmotedu-sdk-go</a>。</p>
<p>具备以下特点：</p>
<ul>
<li><p>  大量使用 Go interface 特性，将接口的定义和实现解耦，支持多种实现方式。</p>
</li>
<li><p>  接口调用层级与资源的层级相匹配，调用方式更友好。</p>
</li>
<li><p>  支持多版本共存。</p>
</li>
</ul>
<h3 id="命令行工具"><a href="#命令行工具" class="headerlink" title="命令行工具"></a>命令行工具</h3><p>大型项目中配备命令行工具（比如 kubectl、istioctl、etcdctl），可通过在脚本中调用 实现自动化，且通过将应用的功能封装成命令和参数，方便运维、开发人员在 Linux 服务器上调用。</p>
<p>待续。</p>
<h2 id="项目管理"><a href="#项目管理" class="headerlink" title="项目管理"></a>项目管理</h2><h3 id="Go-项目"><a href="#Go-项目" class="headerlink" title="Go 项目"></a>Go 项目</h3><h4 id="GOPATH"><a href="#GOPATH" class="headerlink" title="GOPATH"></a>GOPATH</h4><p>Go 1.11 之后，弱化了 GOPATH 规则，已有代码（很多库肯定是在 1.11 之前建立的）肯定符合这个规则，建议保留 GOPATH 规则，便于维护代码。</p>
<p>建议只使用一个 GOPATH。如果使用多个 GOPATH，编译生效的 bin 目录是在第一个 GOPATH 下。</p>
<h4 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h4><p>Go 1.11 以上必须使用 Go Modules。</p>
<p>在提交代码时必须提交 go.sum 文件，不建议提交 vendor 目录。</p>
<h3 id="Makefile-设计"><a href="#Makefile-设计" class="headerlink" title="Makefile 设计"></a>Makefile 设计</h3><p>指代码工程项目的管理，一般使用 Makefile 管理 Go 项目。</p>
<h4 id="规划实现功能"><a href="#规划实现功能" class="headerlink" title="规划实现功能"></a>规划实现功能</h4><p>Go 项目的 Makefile 应实现：格式化代码、静态代码检查、单元测试、代码构建、文件清理、帮助等。如通过 docker 部署，还需要有 docker 镜像打包功能（注意支持不同的 CPU 架构和平台）。</p>
<p>为了能够更好地控制 Makefile 命令的行为，还需要支持 Options。可参考 IAM Makefile：<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/Makefile">iam/Makefile</a>，执行 <code>make help</code> 了解详情。</p>
<h4 id="设计结构"><a href="#设计结构" class="headerlink" title="设计结构"></a>设计结构</h4><p>建议分层设计，根目录下的 Makefile 聚合所有 Makefile 命令，具体实现则按功能分类放在另外的 Makefile 中。</p>
<p>复杂的 Shell 脚本可供 Makefile 调用，简单的命令可以直接集成在 Makefile 中。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">├── Makefile</span><br><span class="line">├── scripts</span><br><span class="line">│   ├── gendoc.<span class="keyword">sh</span></span><br><span class="line">│   ├── <span class="keyword">make</span>-rules</span><br><span class="line">│   │   ├── gen.<span class="keyword">mk</span></span><br><span class="line">│   │   ├── golang.<span class="keyword">mk</span></span><br><span class="line">│   │   ├── image.<span class="keyword">mk</span></span><br><span class="line">│   │   └── ...</span><br><span class="line">    └── ...</span><br><span class="line"></span><br><span class="line">          include                 <span class="keyword">call</span>   </span><br><span class="line">/Makefile ------&gt; makefile/xxx.<span class="keyword">mk</span> ---&gt; <span class="keyword">shell</span>/xxx.<span class="keyword">sh</span></span><br><span class="line">    |                                      ↑ </span><br><span class="line">    +--------------------------------------+ <span class="keyword">call</span></span><br></pre></td></tr></table></figure>

<h4 id="编写技巧"><a href="#编写技巧" class="headerlink" title="编写技巧"></a>编写技巧</h4><p><strong>善用通配符和自动变量</strong>：便于修改、定位具体的 Makefile 文件。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">  @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br></pre></td></tr></table></figure>

<p><strong>善用函数</strong>：参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/master/scripts/make-rules">iam/scripts/make-rules</a>。</p>
<p><strong>依赖工具</strong>：某个目标命令中用到某个工具，可将该工具放在目标的依赖中。当执行该目标时可以指定检查系统是否安装该工具，没有安装则自动安装。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: format</span></span><br><span class="line"><span class="section">format: tools.verify.golines tools.verify.goimports</span></span><br><span class="line">  @echo <span class="string">&quot;===========&gt; Formating codes&quot;</span></span><br><span class="line">  @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> gofmt -s -w</span><br><span class="line">  @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> goimports -w -local <span class="variable">$(ROOT_PACKAGE)</span></span><br><span class="line">  @<span class="variable">$(FIND)</span> -type f -name &#x27;*.go&#x27; | <span class="variable">$(XARGS)</span> golines -w --max-len=120 --reformat-tags --shorten-comments --ignore-generated .</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">  @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br><span class="line">  </span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: install.golines</span></span><br><span class="line"><span class="section">install.golines:</span></span><br><span class="line">  @<span class="variable">$(GO)</span> get -u github.com/segmentio/golines</span><br></pre></td></tr></table></figure>

<p><strong>常用功能放在 /Makefile 中，不常用的放在分类 Makefile 中</strong>。</p>
<p><strong>编写可扩展的 Makefile</strong>：</p>
<ul>
<li><p>  在不改变 Makefile 结构的情况下添加新功能。</p>
</li>
<li><p>  扩展项目时新功能可自动纳入到 Makefile 现有逻辑中。</p>
</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 make go.build 时可构建 cmd/ 目录下的所有组件，当有新组件添加时，make go.build 仍然能够构建新增的组件。</span></span><br><span class="line"></span><br><span class="line">COMMANDS ?= <span class="variable">$(<span class="built_in">filter</span>-out %.md, $(<span class="built_in">wildcard</span> $&#123;ROOT_DIR&#125;/cmd/*)</span>)</span><br><span class="line">BINS ?= <span class="variable">$(<span class="built_in">foreach</span> cmd,$&#123;COMMANDS&#125;,$(<span class="built_in">notdir</span> $&#123;cmd&#125;)</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: go.build</span></span><br><span class="line"><span class="section">go.build: go.build.verify $(addprefix go.build., $(addprefix <span class="variable">$(PLATFORM)</span>., <span class="variable">$(BINS)</span>))</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: go.build.%               </span></span><br><span class="line"></span><br><span class="line"><span class="section">go.build.%:             </span></span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> COMMAND := $(<span class="built_in">word</span> 2,$(<span class="built_in">subst</span> ., ,<span class="variable">$*</span>)</span>))</span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> PLATFORM := $(<span class="built_in">word</span> 1,$(<span class="built_in">subst</span> ., ,<span class="variable">$*</span>)</span>))</span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> OS := $(<span class="built_in">word</span> 1,$(<span class="built_in">subst</span> _, ,<span class="variable">$(PLATFORM)</span>)</span>))           </span><br><span class="line">  <span class="variable">$(<span class="built_in">eval</span> ARCH := $(<span class="built_in">word</span> 2,$(<span class="built_in">subst</span> _, ,<span class="variable">$(PLATFORM)</span>)</span>))                         </span><br><span class="line">  @echo <span class="string">&quot;===========&gt; Building binary <span class="variable">$(COMMAND)</span> <span class="variable">$(VERSION)</span> for <span class="variable">$(OS)</span> <span class="variable">$(ARCH)</span>&quot;</span></span><br><span class="line">  @mkdir -p <span class="variable">$(OUTPUT_DIR)</span>/platforms/<span class="variable">$(OS)</span>/<span class="variable">$(ARCH)</span></span><br><span class="line">  @CGO_ENABLED=0 GOOS=<span class="variable">$(OS)</span> GOARCH=<span class="variable">$(ARCH)</span> <span class="variable">$(GO)</span> build <span class="variable">$(GO_BUILD_FLAGS)</span> -o <span class="variable">$(OUTPUT_DIR)</span>/platforms/<span class="variable">$(OS)</span>/<span class="variable">$(ARCH)</span>/<span class="variable">$(COMMAND)</span><span class="variable">$(GO_OUT_EXT)</span> <span class="variable">$(ROOT_PACKAGE)</span>/cmd/<span class="variable">$(COMMAND)</span></span><br></pre></td></tr></table></figure>

<p><strong>将所有输出存放在一个目录下，方便清理和查找</strong>：例如 Go 编译后的二进制文件、测试覆盖率数据等。清理只需：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: go.clean</span></span><br><span class="line"><span class="section">go.clean:</span></span><br><span class="line">  @echo <span class="string">&quot;===========&gt; Cleaning all build output&quot;</span></span><br><span class="line">  @-rm -vrf <span class="variable">$(OUTPUT_DIR)</span></span><br></pre></td></tr></table></figure>

<p><strong>使用带层级的命名方式</strong>：可以实现目标分组管理。当 Makefile 有大量目标时，通过分组可以更好地管理；分组方便理解，通过组名一眼识别出该目标的功能类别；而且大大减小目标重名的概率。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gen.run</span></span><br><span class="line"><span class="section">gen.run: gen.clean gen.errcode gen.docgo</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gen.errcode</span></span><br><span class="line"><span class="section">gen.errcode: gen.errcode.code gen.errcode.doc</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gen.errcode.code</span></span><br><span class="line"><span class="section">gen.errcode.code: tools.verify.codegen</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: gen.errcode.doc</span></span><br><span class="line"><span class="section">gen.errcode.doc: tools.verify.codegen</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p><strong>做好目标拆分</strong>：将安装工具拆分成两个，即验证工具是否已安装和安装工具，可提高灵活性。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">gen.errcode.code: tools.verify.codegen</span></span><br><span class="line"></span><br><span class="line"><span class="section">tools.verify.%:    </span></span><br><span class="line">  @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi  </span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: install.codegen</span></span><br><span class="line"><span class="section">install.codegen:              </span></span><br><span class="line">  @<span class="variable">$(GO)</span> install $&#123;ROOT_DIR&#125;/tools/codegen/codegen.go</span><br></pre></td></tr></table></figure>

<p><strong>设置 OPTIONS</strong>：把一些可变的功能通过 OPTIONS 来控制。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /Makefile 中定义 USAGE_OPTIONS 。定义 USAGE_OPTIONS 可以使开发者在执行 make help 后感知到此 OPTION，并根据需要进行设置。</span></span><br><span class="line"><span class="keyword">define</span> USAGE_OPTIONS    </span><br><span class="line">                         </span><br><span class="line"><span class="section">Options:</span></span><br><span class="line">  ...</span><br><span class="line">  BINS         The binaries to build. Default is all of cmd.</span><br><span class="line">               ...</span><br><span class="line">  ...</span><br><span class="line">  V            Set to 1 enable verbose build. Default is 0.    </span><br><span class="line"><span class="keyword">endef</span>    </span><br><span class="line"><span class="keyword">export</span> USAGE_OPTIONS    </span><br><span class="line"></span><br><span class="line"><span class="comment"># scripts/make-rules/common.mk 通过判断有没有设置 V 选项，来选择不同的行为</span></span><br><span class="line"><span class="keyword">ifndef</span> V    </span><br><span class="line">MAKEFLAGS += --no-print-directory    </span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还可以通过下面的方法来使用 V </span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">origin</span> V)</span>, undefined)                                </span><br><span class="line">MAKEFLAGS += --no-print-directory              </span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或在 Makefile 中是直接使用的 Option</span></span><br><span class="line">BINS ?= <span class="variable">$(<span class="built_in">foreach</span> cmd,$&#123;COMMANDS&#125;,$(<span class="built_in">notdir</span> $&#123;cmd&#125;)</span>)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="section">go.build: go.build.verify $(addprefix go.build., $(addprefix <span class="variable">$(PLATFORM)</span>., <span class="variable">$(BINS)</span>))</span></span><br></pre></td></tr></table></figure>

<p><strong>定义环境变量</strong>：多处同时生效，避免重复工作。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GO := go                                          </span><br><span class="line">GO_SUPPORTED_VERSIONS ?= 1.13|1.14|1.15|1.16|1.17    </span><br><span class="line">GO_LDFLAGS += -X <span class="variable">$(VERSION_PACKAGE)</span>.GitVersion=<span class="variable">$(VERSION)</span> \    </span><br><span class="line">  -X <span class="variable">$(VERSION_PACKAGE)</span>.GitCommit=<span class="variable">$(GIT_COMMIT)</span> \       </span><br><span class="line">  -X <span class="variable">$(VERSION_PACKAGE)</span>.GitTreeState=<span class="variable">$(GIT_TREE_STATE)</span> \                          </span><br><span class="line">  -X <span class="variable">$(VERSION_PACKAGE)</span>.BuildDate=<span class="variable">$(<span class="built_in">shell</span> date -u +&#x27;%Y-%m-%dT%H:%M:%SZ&#x27;)</span>    </span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(DLV)</span>,)                                                                                                                              </span><br><span class="line">  GO_BUILD_FLAGS += -gcflags <span class="string">&quot;all=-N -l&quot;</span>    </span><br><span class="line">  LDFLAGS = <span class="string">&quot;&quot;</span>      </span><br><span class="line"><span class="keyword">endif</span>                                                                                   </span><br><span class="line">GO_BUILD_FLAGS += -tags=jsoniter -ldflags <span class="string">&quot;<span class="variable">$(GO_LDFLAGS)</span>&quot;</span> </span><br><span class="line">...</span><br><span class="line">FIND := find . ! -path &#x27;./third_party/*&#x27; ! -path &#x27;./vendor/*&#x27;    </span><br><span class="line">XARGS := xargs --no-run-if-empty </span><br></pre></td></tr></table></figure>

<p><strong>调用自身</strong>：比如 A-Target 目标命令中需要完成操作 B-Action，而操作 B-Action 已经通过伪目标 B-Target 实现过。为了达到最大的代码复用度，最好的方式是在 A-Target 的命令中执行 B-Target。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">tools.verify.%:</span></span><br><span class="line">  @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 默认情况下，Makefile 在切换目录时会输出：</span></span><br><span class="line"><span class="comment"># make tools.install.codegen</span></span><br><span class="line"><span class="comment"># ===========&gt; Installing codegen</span></span><br><span class="line"><span class="comment"># make[1]: Entering directory `/home/colin/workspace/golang/src/github.com/marmotedu/iam&#x27;</span></span><br><span class="line"><span class="comment"># make[1]: Leaving directory `/home/colin/workspace/golang/src/github.com/marmotedu/iam&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以设置 MAKEFLAGS += --no-print-directory 来禁止 Makefile 打印 Entering directory 等信息。</span></span><br></pre></td></tr></table></figure>

<h2 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h2><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p>使用 Dockerfile 而非 <code>docker commit</code> 命令基于容器构建镜像，</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一行必须指定构建该镜像所基于的容器镜像</span></span><br><span class="line"><span class="keyword">FROM</span> centos:centos8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 维护者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> Lingfei Kong &lt;colin404@foxmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像的操作指令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;Asia/Shanghai&quot;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /opt/iam</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> iam-apiserver /opt/iam/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器启动时执行指令</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;/opt/iam/bin/iam-apiserver&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他指令：EXPOSE、HEALTHCHECK、STOPSIGNAL。</span></span><br></pre></td></tr></table></figure>

<p>最佳实践：</p>
<ul>
<li><p>  建议所有的 Dockerfile 指令大写，可与在镜像内执行的指令区分。</p>
</li>
<li><p>  尽量选择官方的、体积小的镜像（比如 busybox &lt; debian &lt; centos &lt; ubuntu）。最好确保同一个项目中使用统一的基础镜像。如无特殊需求可以选择使用 debian:jessie 或者 alpine。</p>
</li>
<li><p>  在构建镜像时，删除不需要的文件，只安装需要的文件，保持镜像干净、轻量。</p>
</li>
<li><p>  使用更少的层，把相关的内容放到一个层，并使用换行符分割。可进一步减小镜像的体积，也方便查看镜像历史。</p>
</li>
<li><p>  不要在 Dockerfile 中修改文件权限。修改文件权限 Docker 在构建时会重新复制一份，会导致镜像体积越来越大。</p>
</li>
<li><p>  给镜像打上标签，可帮助理解镜像的功能，比如 <code>docker build -t=&quot;nginx:3.0-onbuild&quot;</code>。</p>
</li>
<li><p>  FROM 指令应该包含 tag，比如 FROM debian:jessie。</p>
</li>
<li><p>  充分利用缓存。Docker 构建引擎会顺序执行 Dockerfile 的指令，一旦缓存失效，后续命令将不能使用缓存。应尽量将所有的 Dockerfile 文件中相同的部分都放在前面，不同的部分放在后面。</p>
</li>
<li><p>  优先使用 COPY 而非 ADD 指令。COPY 功能简单且够用。ADD 可变的行为会导致该指令的行为不清晰，不利于后期维护和理解。</p>
</li>
<li><p>  推荐将 CMD 和 ENTRYPOINT 指令结合使用，使用 execl 格式的 ENTRYPOINT 指令设置固定的默认命令和参数，然后使用 CMD 指令设置可变的参数。</p>
</li>
<li><p>  尽量使用 Dockerfile 共享镜像。可使开发者明确知道 Docker 镜像的构建过程，且可将 Dockerfile 文件加入版本控制跟踪。</p>
</li>
<li><p>  使用 .dockerignore 忽略构建镜像时非必需的文件，提高构建速度。</p>
</li>
<li><p>  使用多阶段构建可大幅减小最终镜像的体积。比如 COPY 指令中可能包含一些安装包，安装后这些内容就废弃掉。</p>
</li>
</ul>
<p>多阶段构建示例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.11</span>-alpine AS build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖包</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go get github.com/golang/mock/mockgen</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制源码并执行 build，此处当文件有变化会产生新的一层镜像层</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /go/src/iam/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go build -o /bin/iam</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缩小到一层镜像</span></span><br><span class="line"><span class="keyword">FROM</span> busybox</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=build /bin/iam /bin/iam</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;/bin/iam&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;--help&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h3><p>使用 YAML 定义和配置 Kubernetes 资源，YAML 支持丰富的数据，且结构清晰、层次分明、表达性极强、易于维护。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">&lt;string&gt;</span>                    <span class="comment"># string 类型，指定 group 的名称，默认为 core。可以使用 `kubectl api-versions` 命令获取当前版本支持的所有 group。</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&lt;string&gt;</span>                          <span class="comment"># string 类型，资源类别。</span></span><br><span class="line"><span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span>                      <span class="comment"># 资源的元数据。</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span>                        <span class="comment"># string类型，资源名称。</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span>                   <span class="comment"># string类型，资源所属的命名空间。</span></span><br><span class="line">  <span class="attr">lables:</span> <span class="string">&lt;</span> <span class="string">map[string]string&gt;</span>          <span class="comment"># map类型，资源的标签。</span></span><br><span class="line">  <span class="attr">annotations:</span> <span class="string">&lt;</span> <span class="string">map[string]string&gt;</span>     <span class="comment"># map类型，资源的标注。</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">&lt;string&gt;</span>                    <span class="comment"># 资源的 REST API路径，格式为：/api/&lt;group&gt;/namespaces/&lt;namespace&gt;/&lt;type&gt;/&lt;name&gt;。例如：/api/v1/namespaces/default/services/iam-apiserver</span></span><br><span class="line"><span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span>                          <span class="comment"># 定义用户期望的资源状态（disired state）。</span></span><br><span class="line"><span class="attr">status:</span> <span class="string">&lt;Object&gt;</span>                        <span class="comment"># 资源当前的状态，以只读的方式显示资源的最近状态。这个字段由kubernetes维护，用户无法定义。</span></span><br></pre></td></tr></table></figure>

<p>常用命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看资源清单</span></span><br><span class="line">kubectl api-resources</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看资源介绍</span></span><br><span class="line">kubectl explain</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取 YAML 模板</span></span><br><span class="line">kubectl run</span><br></pre></td></tr></table></figure>

<p>编写技巧：</p>
<ul>
<li><p>  使用在线的工具 <a target="_blank" rel="noopener" href="https://k8syaml.com/">Kubernetes YAML Generator</a> 来自动生成模板 YAML 文件。</p>
</li>
<li><p>  使用 <code>kubectl run</code> 命令获取 YAML 模板。</p>
</li>
<li><p>  导出集群中已有的资源描述。</p>
</li>
</ul>
<p>使用 <a target="_blank" rel="noopener" href="https://github.com/instrumenta/kubeval">instrumenta/kubeval</a> 验证 YAML 是否符合 Kubernetes API 模式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz</span><br><span class="line">tar xf kubeval-linux-amd64.tar.gz</span><br><span class="line">mv kubeval $HOME/bin</span><br><span class="line"></span><br><span class="line">kubeval deployments/iam.invalid.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> ERR  - iam/templates/iam-configmap.yaml: Duplicate <span class="string">&#x27;ConfigMap&#x27;</span> resource <span class="string">&#x27;iam&#x27;</span> <span class="keyword">in</span> namespace <span class="string">&#x27;&#x27;</span></span></span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="https://github.com/zegl/kube-score">zegl/kube-score</a> 分析 YAML，根据内置的检查对其评分（安全建议和最佳实践，比如以非 Root 用户启动容器、为 Pods 设置健康检查、定义资源请求和限制）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/zegl/kube-score/cmd/kube-score</span><br><span class="line"></span><br><span class="line">kube-score score -o ci deployments/iam.invalid.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> [OK] iam-apiserver apps/v1/Deployment</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [OK] iam-apiserver apps/v1/Deployment</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [OK] iam-apiserver apps/v1/Deployment</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [OK] iam-apiserver apps/v1/Deployment</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [CRITICAL] iam-apiserver apps/v1/Deployment: The pod does not have a matching NetworkPolicy</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [CRITICAL] iam-apiserver apps/v1/Deployment: Container has the same readiness and liveness probe</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [CRITICAL] iam-apiserver apps/v1/Deployment: (iam-apiserver) The pod has a container with a writable root filesystem</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [CRITICAL] iam-apiserver apps/v1/Deployment: (iam-apiserver) The container is running with a low user ID</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [CRITICAL] iam-apiserver apps/v1/Deployment: (iam-apiserver) The container running with a low group ID</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [OK] iam-apiserver apps/v1/Deployment</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加上 -o human 可查看详细的错误原因和解决方案。</span></span><br></pre></td></tr></table></figure>

<h3 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h3><p>待续。</p>
<h2 id="研发流程示例"><a href="#研发流程示例" class="headerlink" title="研发流程示例"></a>研发流程示例</h2><p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/ab6ac57696c0e90cf82624f78a82333b.png" alt="img"></p>
<p>演进维度：研发模式（瀑布模式，迭代模式，敏捷模式） -&gt; CI/CD -&gt; DevOps。</p>
<img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/ddb314275ba1bab28413221bc56ac80f.png" alt="img" style="zoom:100%;" />

<p>软件生命周期：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/9a290c28b0c238dd69e24dcc9f5c7ea3.png" alt="img"></p>
<p>角色分工：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/40a1e20b153bb3ba1005cea4aefe62d5.png" alt="img"></p>
<h3 id="需求阶段"><a href="#需求阶段" class="headerlink" title="需求阶段"></a>需求阶段</h3><p>参与产品讨论，详细了解需求，为后续开发打下基础。</p>
<p>通过需求评审后，输出详细的需求文档。</p>
<h3 id="设计阶段"><a href="#设计阶段" class="headerlink" title="设计阶段"></a>设计阶段</h3><p>包括产品设计、交互设计、视觉设计、技术设计、技术评审、需求排期。</p>
<p>开发人员需要做好调研、设计领先的技术架构，技术方案获得团队一致通过。</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/81296e3f9f0f90e77dd771ee4f61b71b-163906708572615.png" alt="img"></p>
<h3 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h3><p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/137a2a20067d1472c9f00c6387a30857-163906712099217.png" alt="img"></p>
<p>根据项目规模和协作模式，选择采用 Git Flow 工作流。</p>
<p>代码开发阶段基本流程包括：创建 feature 分支 -&gt; 完成开发工作 -&gt; 生成代码 -&gt; 版权检查 -&gt; 代码格式化 -&gt; 静态检查 -&gt; 单元测试 -&gt; 构建二进制文件（可执行 <code>make</code> 命令一键完成）。</p>
<p>首先在 master 分支上创建常驻的 develop 分支，并基于 develop 分支 <strong>新建 feature 分支</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b feature/helloworld develop</span><br></pre></td></tr></table></figure>

<p>分支名称需符合 Git Flow 命名规范，否则 githooks 会导致 commit 失败（参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/githooks/pre-commit">iam/pre-commit</a>）：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">master</span></span><br><span class="line"><span class="title">develop</span></span><br><span class="line">feature + <span class="string">&quot;/&quot;</span> + x.y.z-a</span><br><span class="line">release</span><br><span class="line">hotfix</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  git 不会提交 .git/hooks 下的 githooks 脚本，需要通过以下手段确保开发者 clone 仓库后，仍然能安装指定的 githooks 脚本到 .git/hooks 目录（参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/scripts/make-rules/common.mk#L74">iam/common.mk</a>）：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Copy githook scripts when execute makefile</span>    </span><br><span class="line">COPY_GITHOOK:=$(shell cp -f githooks/* .git/hooks/) </span><br></pre></td></tr></table></figure>
</blockquote>
<p>在 feature 分支 <strong>完成开发工作</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 通过 iamctl new helloworld 命令创建 helloworld 命令模板</span></span><br><span class="line">iamctl new helloworld -d internal/iamctl/cmd/helloworld</span><br><span class="line"><span class="meta">#</span><span class="bash"> Command file generated: internal/iamctl/cmd/helloworld/helloworld.go</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑 internal/iamctl/cmd/cmd.go 文件，在源码文件中添加helloworld.NewCmdHelloworld(f, ioStreams),，加载 helloworld 命令。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> import (</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     <span class="string">&quot;github.com/marmotedu/iam/internal/iamctl/cmd/helloworld&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> )</span></span><br><span class="line"><span class="meta">#</span><span class="bash">         ...</span></span><br><span class="line"><span class="meta">#</span><span class="bash">         &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">             Message: <span class="string">&quot;Troubleshooting and Debugging Commands:&quot;</span>,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">             Commands: []*cobra.Command&#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 validate.NewCmdValidate(f, ioStreams),</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 helloworld.NewCmdHelloworld(f, ioStreams),</span></span><br><span class="line"><span class="meta">#</span><span class="bash">             &#125;,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">         &#125;,</span></span><br></pre></td></tr></table></figure>

<p>使用 make <strong>生成代码</strong>（比如清理先前的文件再重新生成），要求操作具有幂等性：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make gen    # gen.run: gen.clean gen.errcode gen.docgo.doc</span><br></pre></td></tr></table></figure>

<p>针对开源软件需进行 <strong>版权检查</strong>，检查新文件是否添加版权头信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make verify-copyright  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果检查失败，可只需 make add-copyright 自动添加。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>  如果 Makefile 的 command 需要某个命令，可以使该目标依赖类似 tools.verify.addlicense 的目标，可检查该工具是否已安装，没有就先安装。</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: copyright.verify    </span></span><br><span class="line"><span class="section">copyright.verify: tools.verify.addlicense </span></span><br><span class="line">  ...</span><br><span class="line"><span class="section">tools.verify.%:          </span></span><br><span class="line">  @if ! which <span class="variable">$*</span> &amp;&gt;/dev/null; then <span class="variable">$(MAKE)</span> tools.install.<span class="variable">$*</span>; fi</span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: install.addlicense                              </span></span><br><span class="line"><span class="section">install.addlicense:        </span></span><br><span class="line">  @<span class="variable">$(GO)</span> get -u github.com/marmotedu/addlicense</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>代码格式化</strong>：依次执行 gofmt、goimports（自动增删依赖的包，并将依赖包按字母序排序并分类）、golines（超过 120 行的代码按规则折行处理）等，并使用 <code>go mod edit -fmt</code> 格式化 go.mod 文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make format</span><br></pre></td></tr></table></figure>

<p><strong>静态检查</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make lint</span><br></pre></td></tr></table></figure>

<p><strong>单元测试</strong>：注意检查测试覆盖率，达不到预期阈值就需要补充测试用例，否则禁止合并到 develop 和 master 分支（也可由 GitHub Actions CI 等自动化流水线工具检查）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make test</span><br><span class="line"><span class="meta">#</span><span class="bash"> 排除不需要单元测试的包。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> go <span class="built_in">test</span> `go list ./...|egrep -v $(subst $(SPACE),<span class="string">&#x27;|&#x27;</span>,$(sort $(EXCLUDE_TESTS)))`</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 把 mock_.* .go 文件中的函数单元测试信息从 coverage.out 中删除。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">&#x27;/mock_.*.go/d&#x27;</span> $(OUTPUT_DIR)/coverage.out</span></span><br><span class="line"></span><br><span class="line">make cover COVERAGE=90</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">test</span> coverage is 62.1%</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">test</span> coverage does not meet expectations: 90%, please add <span class="built_in">test</span> cases!</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> make[1]: *** [go.test.cover] Error 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> make: *** [cover] Error 2</span></span><br></pre></td></tr></table></figure>

<p><strong>构建二进制文件</strong>：自动构建 cmd/ 目录下的所有组件，也可以构建其中一或多个组件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make build</span><br><span class="line"><span class="meta">#</span><span class="bash"> make build BINS=<span class="string">&quot;iam-apiserver iamctl&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>以上步骤可随时根据需要执行，发现问题及时改正。</p>
<blockquote>
<p>  Makefile 技巧：</p>
<p>  随着项目的扩展 Makefile 会加入大量管理功能，其中 help 命令可实现自动解析：</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## help: Show this help info.    </span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: help           </span></span><br><span class="line"><span class="section">help: Makefile               </span></span><br><span class="line">  @echo -e <span class="string">&quot;\nUsage: make &lt;TARGETS&gt; &lt;OPTIONS&gt; ...\n\nTargets:&quot;</span></span><br><span class="line">  <span class="comment"># 自动解析 Makefile 中 ## 开头的注释行，从而自动生成 make help 输出。</span></span><br><span class="line">  @sed -n &#x27;s/^<span class="comment">##//p&#x27; $&lt; | column -t -s &#x27;:&#x27; | sed -e &#x27;s/^/ /&#x27;</span></span><br><span class="line">  @echo <span class="string">&quot;$$USAGE_OPTIONS&quot;</span>    </span><br></pre></td></tr></table></figure>

<p>  变量可以在 Makefile options 中被指定：</p>
  <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">origin</span> COVERAGE)</span>,undefined)    </span><br><span class="line">COVERAGE := 60    </span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment"># make COVERAGE=90</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>其中版本号可使用 <code>gsemver</code> 生成，参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/scripts/ensure_tag.sh">iam/ensure_tag.sh</a>。</p>
<hr>
<p>以下步骤则为提交阶段，将代码 <strong>提交到 feature 分支</strong>（建议只添加与 feature/helloworld 相关的改动，明确一个 commit 所做的变更，方便以后追溯），并 <strong>push 到远端仓库</strong>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add internal/iamctl/cmd/helloworld internal/iamctl/cmd/cmd.go</span><br><span class="line">git commit -m &quot;feat: add new iamctl command &#x27;helloworld&#x27;&quot;</span><br><span class="line">git push origin feature/helloworld</span><br></pre></td></tr></table></figure>

<p>提交时 githooks 会检查 commit message 是否符合规范（利用 go-gitlint，参考 <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/githooks/commit-msg">iam/commit-msg</a>，也可以自行执行命令检查 <code>go-gitlint</code>）。</p>
<p>配置 GitHub Actions，当有代码被 Push 时会 <strong>触发 CI 流水线</strong>。由于保证了线上 CI 流程和本地 CI 流程完全一致。如果 CI 不通过，则需要修改代码直到通过为止。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">IamCI</span></span><br><span class="line"><span class="attr">on:</span> </span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branchs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">opened</span>, <span class="string">reopened</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="comment"># 拉取代码</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">    <span class="comment"># 设置 Go 编译环境</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Go</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/setup-go@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">go-version:</span> <span class="number">1.16</span></span><br><span class="line">    <span class="comment"># 执行 make 命令</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">all</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">make</span></span><br></pre></td></tr></table></figure>

<p><strong>提交 pull request</strong>：在 GitHub 上基于 feature 创建 PR，并指定 reviewers 进行 CR，此时也会触发 CI 流水线。</p>
<p><strong>code viewer</strong>：可选择 Comment、Approve、Request Changes。</p>
<ul>
<li><p>  不通过：直接在 feature/helloworld 分支修正代码，并 push 到远端的 feature/helloworld 分支，再通知 reviewers 再次 review。push 事件发生会再触发 GitHub Actions CI 流水线。</p>
</li>
<li><p>  通过：maintainer 将新的代码合并到 develop 分支。如选择 Create a merge commit 方式，将 PR 合并到 develop 分支（<code>git merge --no-ff</code>，好处是所有的 commit 都会追加到 develop 分支，并生成 merge commit，便于回溯历史）。</p>
</li>
</ul>
<p>合并到 develop 分支后触发 CI 流程。</p>
<blockquote>
<p>  使用 CHANGELOG 可展示每个版本之间的变更内容，作为 Release Note 的一部分。可以借助 git-chglog 工具来自动生成，配置文件参考：<a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/githooks/commit-msg">iam/commit-msg</a></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git-chglog v1.0.0 CHANGELOG/CHANGELOG-1.0.0.md</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="测试阶段"><a href="#测试阶段" class="headerlink" title="测试阶段"></a>测试阶段</h3><p>对于开发人员，需要基于 develop 分支 <strong>创建 release 分支</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b release/1.0.0 develop</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>将 release/1.0.0 分支代码 <strong>提交测试</strong>，如测试失败可直接在 release/1.0.0 修复、本地构建并提交：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">git add internal/iamctl/cmd/helloworld/</span><br><span class="line">git commit -m &quot;fix: fix helloworld print bug&quot;</span><br><span class="line">git push origin release/1.0.0</span><br></pre></td></tr></table></figure>

<p>push 到 release/1.0.0 后，GitHub Actions 会执行 CI 流水线，要求修改直到流水线执行成功为止。由测试人员完成功能测试、性能测试、集成测试、系统测试等。</p>
<blockquote>
<p>   测试人员根据需求文档创建测试计划、编写测试用例，并与开发人员一起评审测试计划和用例。通过后测试人员根据测试计划和测试用例对服务进行测试（测试计划的创建和测试用例的编写可与开发阶段并行）。</p>
</blockquote>
<blockquote>
<p>  在此阶段为了不阻塞测试，确保项目按时发布，开发人员应优先解决测试同学的 Bug（至少是阻塞类的 Bug）。为减少不必要的沟通和排障，安装部署文档要尽可能详尽和准确，并及时地跟进测试。</p>
</blockquote>
<p>测试通过后将 release/1.0.0 分支 <strong>合并到 master 分支和 develop 分支</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout develop</span><br><span class="line">git merge --no-ff release/1.0.0</span><br><span class="line">git checkout master</span><br><span class="line">git merge --no-ff release/1.0.0</span><br><span class="line">git tag -a v1.0.0 -m &quot;add print hello world&quot; # master分支打tag</span><br></pre></td></tr></table></figure>

<p>删除 feature 和 release 分支：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch -d feature/helloworld</span><br><span class="line">git branch -d release/1.0.0</span><br></pre></td></tr></table></figure>

<h3 id="发布阶段"><a href="#发布阶段" class="headerlink" title="发布阶段"></a>发布阶段</h3><p>遵循发布规范，谨慎发布到现网，并做好现网验证。</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/37yy6e0896daa8f97883631624996388.png" alt="img"></p>
<h3 id="运营阶段"><a href="#运营阶段" class="headerlink" title="运营阶段"></a>运营阶段</h3><p>协助运维快速定位并恢复系统，协助运营开发运营类功能接口。</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/e0a4d8ed5f3a6a8a4bc4035e261881b5.png" alt="img"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>工程规范：</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/marmotedu/geekbang-go/blob/master/%E5%BC%80%E6%BA%90%E8%A7%84%E8%8C%83%E8%AF%A6%E7%BB%86%E5%88%97%E8%A1%A8.md">开源规范详细列表</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/tree/master/docs/guide/zh-CN/api">IAM API 介绍</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://semver.org/lang/zh-CN/">语义化版本 2.0.0</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/marmotedu/iam/blob/master/docs/devel/zh-CN/scope.md">IAM commit message scope</a></p>
</li>
</ul>
<p>README 生成：<a target="_blank" rel="noopener" href="https://readme.so/">readme.so</a></p>
<p>API 设计：</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://docs.github.com/en/rest">GitHub REST API</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/API-design-guide/API-design-guide-README.md">Google API Design Guide</a></p>
</li>
</ul>
<p>API 文档：可自行编写（<a target="_blank" rel="noopener" href="https://editor.swagger.io/">Swagger Editor</a>），或用工具自动生成。</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/go-swagger/go-swagger">go-swagger/go-swagger</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/swaggo/swag">swaggo/swag</a></p>
</li>
</ul>
<p>项目管理：</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/marmotedu/geekbang-go/blob/master/Go%E9%A1%B9%E7%9B%AE%E9%80%9A%E5%B8%B8%E5%8C%85%E5%90%AB%E7%9A%84%E5%8A%9F%E8%83%BD.md">Go 项目通常包含的功能</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/marmotedu/geekbang-go/blob/master/Makefile%E5%B8%B8%E8%A7%81%E7%AE%A1%E7%90%86%E5%86%85%E5%AE%B9.md">Makefile 常见管理内容</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/wang_yb/p/3990952.html">Makefile 使用总结</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/seisman/how-to-write-makefile">跟我一起写 Makefile</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/marmotedu/geekbang-go/blob/master/makefile/Makefile%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E5%88%97%E8%A1%A8.md">Makefile 常用函数列表</a></p>
</li>
</ul>
<p>Git commit：</p>
<ul>
<li><p>  commitizen-go：进入交互模式并根据提示生成 commit message 后提交。</p>
</li>
<li><p>  commit-msg：githooks，在 commit-msg 中指定检查的规则，可根据需要实现脚本。</p>
</li>
<li><p>  go-gitlint：检查历史提交的 commit message 是否符合 Angular 规范，可将该工具添加在 CI 流程中，确保 commit message 合规。</p>
</li>
<li><p>  gsemver：语义化版本自动生成工具。</p>
</li>
<li><p>  git-chglog：根据 commit message 生成 CHANGELOG。</p>
</li>
</ul>
<p>License 文档生成：<a target="_blank" rel="noopener" href="https://github.com/marmotedu/addlicense">marmotedu/addlicense</a></p>
<p>静态检查：<a target="_blank" rel="noopener" href="https://github.com/golangci/golangci-lint">golangci/golangci-lint</a></p>
<p>编码规范及最佳实践：</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/xxjwxc/uber_go_guide_cn">Uber Go 语言编码规范</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://go.dev/doc/effective_go">Effective Go</a>：Golang 官方编写，包含编写 Go 代码的一些建议，可理解为最佳实践。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/golang/go/wiki/CodeReviewComments">Code Review Comments</a>：Golang 官方编写的 Go 最佳实践，作为 Effective Go 的补充。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://rakyll.org/style-packages/">Style guideline for Go packages</a>：包含了如何组织 Go 包、如何命名 Go 包、如何写 Go 包文档的一些建议。</p>
</li>
</ul>
<p>代码生成：</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/cheekybits/genny">cheekybits/genny</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/taylorchu/generic">taylorchu/generic</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/joeshaw/gengen">joeshaw/gengen</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/clipperhouse/gen">clipperhouse/gen</a></p>
</li>
</ul>
<p>API 测试：</p>
<ul>
<li>  Insomnia：跨平台的 REST API 客户端，用于接口管理、测试。</li>
</ul>
<p>Mock 测试：</p>
<ul>
<li><p>  golang/mock：官方提供的 Mock 框架。实现基于 interface 的 Mock 功能，可与 Golang 内置的 testing 包集成，是最常用的 Mock 工具。golang/mock 提供了 mockgen 工具用来生成 interface 对应的 Mock 源文件。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/DATA-DOG/go-sqlmock">DATA-DOG/go-sqlmock</a>：可用于模拟数据库连接，在遇到数据库依赖时可以使用。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/jarcoal/httpmock">jarcoal/httpmock</a>：可用于 Mock HTTP 请求。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/bouk/monkey">bouk/monkey</a>：猴子补丁，可通过替换函数指针的方式来修改任意函数的实现。如果以上不能满足需求，可尝试通过猴子补丁来 Mock 依赖。</p>
</li>
</ul>
<p>单元测试：</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/cweill/gotests">cweill/gotests</a>：自动生成单元测试模板。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/stretchr/testify">stretchr/testify</a>：Go test 预判工具，使测试代码更优雅和高效，测试结果更详细。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/smartystreets/goconvey">smartystreets/goconvey</a>：管理和运行测试用例，同时提供了丰富的断言函数，并支持 Web 界面特性。</p>
</li>
</ul>
<p>Kubernetes：</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://k8syaml.com/">Kubernetes YAML Generator</a>：Kubernetes YAML 文件模板。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/instrumenta/kubeval">instrumenta/kubeval</a>：验证 YAML 是否符合 Kubernetes API 模式。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/zegl/kube-score">zegl/kube-score</a>：分析 Kubernetes YAML，并根据内置的检查对其评分（根据安全建议和最佳实践选择）。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/stelligent/config-lint">stelligent/config-lint</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/cloud66-oss/copper">cloud66-oss/copper</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/open-policy-agent/conftest">open-policy-agent/conftest</a></p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://github.com/FairwindsOps/polaris">FairwindsOps/polaris</a></p>
</li>
</ul>
<p>其它工具：</p>
<p><img src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/Go_engineering-specification-design.assets/90ca527c2863fe642f9ab3d5b90fe980.png" alt="img"></p>
<p>专栏提供的设计 Demo：<a target="_blank" rel="noopener" href="https://github.com/marmotedu">marmotedu</a>。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    </article>
    <!-- license -->
    
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/2021/11/06/Go_modules_management/" title="Go Modules 管理总结">
                    <div class="prevTitle">Go Modules 管理总结</div>
                </a>
            
        </li>
    </ul>
    <!-- comment -->
    
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->

    <div id="lv-container" data-id="city" data-uid= MTAyMC80ODYzMi8yNTEyNg==>
        <script type="text/javascript">
            (function (d, s) {
                var j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') { return; }
                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活 JavaScript</noscript>
    </div>


            

            

            

            <!-- utteranc评论 -->


            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->


            
            

            

        </div>
    
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
    <!-- Mathjax -->
    
</main>

                <!-- profile -->
                
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
    
        <div class="social">
            
    
        
            
                <a href="mailto:yipwinghong@outlook.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/yipwinghong" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                    
                    <img class="profile-qr" src="https://ywh-oss.oss-cn-shenzhen.aliyuncs.com/WeChat.jpg" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="https://www.v2ex.com/member/yipwinghong" class="iconfont-archer v2ex" target="_blank" title=v2ex></a>
            
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    


        </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    
    <!-- 不蒜子  -->
    
        <div class="busuanzi-container">
            
             
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
            
        </div>
    	
</footer>

        </div>
        <!-- toc -->
        
            <div class="toc-wrapper toc-wrapper-loding" style=







    top:0vh;

>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Go-%E5%B7%A5%E7%A8%8B%E5%8C%96%E8%A7%84%E8%8C%83%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">Go 工程化规范设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.</span> <span class="toc-text">开源规范</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E8%A7%84%E8%8C%83"><span class="toc-number">1.2.</span> <span class="toc-text">文档规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#README-%E6%96%87%E6%A1%A3"><span class="toc-number">1.2.1.</span> <span class="toc-text">README 文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3"><span class="toc-number">1.2.2.</span> <span class="toc-text">项目文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-%E6%96%87%E6%A1%A3"><span class="toc-number">1.2.3.</span> <span class="toc-text">API 文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Swagger"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">Swagger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E8%A7%84%E8%8C%83"><span class="toc-number">1.3.</span> <span class="toc-text">版本规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">自动生成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Git-%E8%A7%84%E8%8C%83"><span class="toc-number">1.4.</span> <span class="toc-text">Git 规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Commit-%E8%A7%84%E8%8C%83"><span class="toc-number">1.4.1.</span> <span class="toc-text">Commit 规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Header"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Body"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">Body</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Footer"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">Footer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Revert-Commit"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">Revert Commit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%A1%E7%90%86-Commit"><span class="toc-number">1.4.1.5.</span> <span class="toc-text">管理 Commit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-Commit"><span class="toc-number">1.4.1.6.</span> <span class="toc-text">修改 Commit</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.2.</span> <span class="toc-text">分支管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">集中式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%88%86%E6%94%AF"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">功能分支</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Git-Flow%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">Git Flow（推荐）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Forking%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">Forking（推荐）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.5.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83"><span class="toc-number">1.6.</span> <span class="toc-text">编码规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">代码架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">分层架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="toc-number">1.6.2.</span> <span class="toc-text">命名规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.6.2.5.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">1.6.2.6.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F"><span class="toc-number">1.6.2.7.</span> <span class="toc-text">常量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Error"><span class="toc-number">1.6.2.8.</span> <span class="toc-text">Error</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E8%A7%84%E8%8C%83"><span class="toc-number">1.6.3.</span> <span class="toc-text">注释规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85-1"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%EF%BC%8C%E5%B8%B8%E9%87%8F"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">变量，常量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93-1"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.3.4.</span> <span class="toc-text">方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.3.5.</span> <span class="toc-text">类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.4.</span> <span class="toc-text">设计模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%A3%80%E6%9F%A5"><span class="toc-number">1.6.5.</span> <span class="toc-text">静态检查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">使用技巧</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86"><span class="toc-number">1.6.6.</span> <span class="toc-text">日志处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">日志级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9"><span class="toc-number">1.6.6.2.</span> <span class="toc-text">日志内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.6.3.</span> <span class="toc-text">最佳实践</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%9E%84%E5%BB%BA"><span class="toc-number">1.6.7.</span> <span class="toc-text">应用构建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.</span> <span class="toc-text">代码测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.</span> <span class="toc-text">单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mock-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">Mock 测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E7%8E%87"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">覆盖率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E5%B1%82%EF%BC%88Models%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">模型层（Models）测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%82%EF%BC%88Controller%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.4.</span> <span class="toc-text">控制层（Controller）测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82-%EF%BC%88Service%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.5.</span> <span class="toc-text">业务层 （Service）测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%93%E5%BA%93%E5%B1%82%EF%BC%88Repository%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.6.</span> <span class="toc-text">仓库层（Repository）测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">基准测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.3.</span> <span class="toc-text">示例测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TestMain"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">TestMain</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fake-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.4.</span> <span class="toc-text">Fake 测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.5.</span> <span class="toc-text">性能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-wrk"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">使用 wrk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API-%E6%80%A7%E8%83%BD%E5%8F%82%E8%80%83"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">API 性能参考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">1.8.</span> <span class="toc-text">性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%87%E9%9B%86%E6%95%B0%E6%8D%AE"><span class="toc-number">1.8.1.</span> <span class="toc-text">采集数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E9%87%87%E6%A0%B7%E5%9B%BE"><span class="toc-number">1.8.2.</span> <span class="toc-text">分析采样图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%81%AB%E7%84%B0%E5%9B%BE"><span class="toc-number">1.8.3.</span> <span class="toc-text">分析火焰图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE"><span class="toc-number">1.8.4.</span> <span class="toc-text">分析数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.9.</span> <span class="toc-text">API 设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RESTful-API"><span class="toc-number">1.9.1.</span> <span class="toc-text">RESTful API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#URI"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">URI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">HTTP 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E8%B7%AF%E5%BE%84"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">返回路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">错误码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API-%E7%89%88%E6%9C%AC"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">API 版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API-%E5%91%BD%E5%90%8D"><span class="toc-number">1.9.1.6.</span> <span class="toc-text">API 命名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5-%E8%BF%87%E6%BB%A4-%E6%8E%92%E5%BA%8F-%E6%90%9C%E7%B4%A2"><span class="toc-number">1.9.1.7.</span> <span class="toc-text">分页 &#x2F; 过滤 &#x2F; 排序 &#x2F; 搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D"><span class="toc-number">1.9.1.8.</span> <span class="toc-text">域名</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RPC-API"><span class="toc-number">1.9.2.</span> <span class="toc-text">RPC API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gRPC"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">gRPC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDK"><span class="toc-number">1.9.3.</span> <span class="toc-text">SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">设计思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E6%9C%89%E4%BA%91%E5%8E%82%E5%95%86%E7%9A%84-SDK-%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">公有云厂商的 SDK 设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#client-go-%E9%A3%8E%E6%A0%BC%E7%9A%84-SDK-%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">client-go 风格的 SDK 设计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">1.9.4.</span> <span class="toc-text">命令行工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.10.</span> <span class="toc-text">项目管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Go-%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.10.1.</span> <span class="toc-text">Go 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GOPATH"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">GOPATH</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">依赖管理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Makefile-%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.10.2.</span> <span class="toc-text">Makefile 设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%92%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">规划实现功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E7%BB%93%E6%9E%84"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">设计结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">编写技巧</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-number">1.11.</span> <span class="toc-text">项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker"><span class="toc-number">1.11.1.</span> <span class="toc-text">Docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes"><span class="toc-number">1.11.2.</span> <span class="toc-text">Kubernetes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Helm"><span class="toc-number">1.11.3.</span> <span class="toc-text">Helm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A0%94%E5%8F%91%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.12.</span> <span class="toc-text">研发流程示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E9%98%B6%E6%AE%B5"><span class="toc-number">1.12.1.</span> <span class="toc-text">需求阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E9%98%B6%E6%AE%B5"><span class="toc-number">1.12.2.</span> <span class="toc-text">设计阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5"><span class="toc-number">1.12.3.</span> <span class="toc-text">开发阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%98%B6%E6%AE%B5"><span class="toc-number">1.12.4.</span> <span class="toc-text">测试阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E9%98%B6%E6%AE%B5"><span class="toc-number">1.12.5.</span> <span class="toc-text">发布阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%90%A5%E9%98%B6%E6%AE%B5"><span class="toc-number">1.12.6.</span> <span class="toc-text">运营阶段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.13.</span> <span class="toc-text">参考资料</span></a></li></ol></li></ol>
            </div>
        
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 78
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
        
            
            
            <div class="archive-year"> 2021 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/10</span>
            <a class="archive-post-title" href="/2021/12/10/Go_engineering-specification-design/">Go 工程化规范设计</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/06</span>
            <a class="archive-post-title" href="/2021/11/06/Go_modules_management/">Go Modules 管理总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/15</span>
            <a class="archive-post-title" href="/2021/10/15/Go_concurrency_primitives/">Go 并发原语</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/10</span>
            <a class="archive-post-title" href="/2021/10/10/Design_data-lineage/">数据血缘功能设计</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/26</span>
            <a class="archive-post-title" href="/2021/09/26/2021-09-26_diary/">迟来的一次复盘</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span>
            <a class="archive-post-title" href="/2021/09/12/DB_mysql-optimization-basic/">MySQL 性能优化基础</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span>
            <a class="archive-post-title" href="/2021/09/05/DB_b-trees-more-than-i-thought-id-want-to-know/">关于 B-Trees 的更多细节（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/11</span>
            <a class="archive-post-title" href="/2021/08/11/Go_microservices_availability_design/">微服务可用性设计</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/10</span>
            <a class="archive-post-title" href="/2021/08/10/Algorithm_reliable-distributed-timer/">可靠的分布式计时器（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/04</span>
            <a class="archive-post-title" href="/2021/08/04/Go_engineering-standard/">Go 工程化标准实践</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/31</span>
            <a class="archive-post-title" href="/2021/07/31/Go_memory-model/">Go 内存模型（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/28</span>
            <a class="archive-post-title" href="/2021/07/28/Go_channel-applications/">Go Channel 应用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/25</span>
            <a class="archive-post-title" href="/2021/07/25/Fenix_build-services/">《凤凰架构》阅读笔记（五）：服务构建与流量治理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/23</span>
            <a class="archive-post-title" href="/2021/07/23/Fenix_transparent-multilevel-diversion-system/">《凤凰架构》阅读笔记（四）：透明多级分流系统</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/22</span>
            <a class="archive-post-title" href="/2021/07/22/Fenix_transaction/">《凤凰架构》阅读笔记（三）：事务处理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/21</span>
            <a class="archive-post-title" href="/2021/07/21/Fenix_access-remote-service/">《凤凰架构》阅读笔记（二）：访问远程服务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/18</span>
            <a class="archive-post-title" href="/2021/07/18/Go_error_handling/">Go 异常处理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/15</span>
            <a class="archive-post-title" href="/2021/07/15/Fenix_architecture-evolution/">《凤凰架构》阅读笔记（一）：软件架构演进</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/12</span>
            <a class="archive-post-title" href="/2021/07/12/Go_microservices_governance/">微服务概览与治理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/09</span>
            <a class="archive-post-title" href="/2021/07/09/Algorithm_max-flow-problem/">最大流问题</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span>
            <a class="archive-post-title" href="/2021/07/08/Algorithm_minimum_spanning_tree_problem/">最小生成树问题</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span>
            <a class="archive-post-title" href="/2021/07/08/Algorithm_shortest-path-problem/">最短路径问题</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/01</span>
            <a class="archive-post-title" href="/2021/07/01/DistributedSystem_gossip-dissemination/">分布式系统模式：Gossip 传播（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span>
            <a class="archive-post-title" href="/2021/06/23/DistributedSystem_versioned-value/">分布式系统模式：版本化值（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/19</span>
            <a class="archive-post-title" href="/2021/06/19/Algorithm_consistent-hashing/">一致性哈希（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/13</span>
            <a class="archive-post-title" href="/2021/06/13/Go_cheat-sheet/">Go Cheat Sheet</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/10</span>
            <a class="archive-post-title" href="/2021/06/10/Go_a-tour-of-go/">A tour of Go</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span>
            <a class="archive-post-title" href="/2021/06/06/2021-06-06_diary/">Weekly Summary (2021-05-31_2021-06-06)</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/05</span>
            <a class="archive-post-title" href="/2021/06/05/2021-06-05_diary/">基于记忆规律的学习方法</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/31</span>
            <a class="archive-post-title" href="/2021/05/31/2021-05-31_diary/">2021 下半年工作学习安排</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/16</span>
            <a class="archive-post-title" href="/2021/05/16/Algorithm_how-to-solve-the-secret-santa-problem-using-graph-theory/">如何用图论解决 Secret Santa 问题？（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span>
            <a class="archive-post-title" href="/2021/05/12/DB_using-postgresql-as-a-data-warehouse/">把 PostgreSQL 用作数据仓库（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/28</span>
            <a class="archive-post-title" href="/2021/04/28/OS_linux-memory-monitoring/">Linux 内存原理与分析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/20</span>
            <a class="archive-post-title" href="/2021/04/20/OS_linux-io-monitoring/">Linux I/O 原理与分析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/10</span>
            <a class="archive-post-title" href="/2021/04/10/OS_linux-cpu-monitoring/">Linux CPU 原理与分析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span>
            <a class="archive-post-title" href="/2021/04/05/OS_linux-network-monitoring/">Linux 网络原理与分析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span>
            <a class="archive-post-title" href="/2021/04/01/OS_system_initialization/">Linux - 架构与系统初始化</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/17</span>
            <a class="archive-post-title" href="/2021/03/17/Java_cpp-for-java-programmers/">Java 程序员的 C++（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span>
            <a class="archive-post-title" href="/2021/02/24/DDIA_note-13/">《DDIA》阅读笔记（九）：一致性与共识（共识问题）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/21</span>
            <a class="archive-post-title" href="/2021/02/21/2021-02-21_diary/">近期工作学习规划</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span>
            <a class="archive-post-title" href="/2021/02/19/DDIA_note-12/">《DDIA》阅读笔记（九）：一致性与共识（顺序保证）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span>
            <a class="archive-post-title" href="/2021/02/13/DDIA_note-11/">《DDIA》阅读笔记（九）：一致性与共识（可线性化）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span>
            <a class="archive-post-title" href="/2021/02/06/DDIA_note-10/">《DDIA》阅读笔记（八）：分布式系统的挑战</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/27</span>
            <a class="archive-post-title" href="/2021/01/27/DDIA_note-9/">《DDIA》阅读笔记（七）：事务</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/22</span>
            <a class="archive-post-title" href="/2021/01/22/DDIA_note-8/">《DDIA》阅读笔记（六）：数据分区</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/21</span>
            <a class="archive-post-title" href="/2021/01/21/DDIA_note-7/">《DDIA》阅读笔记（五）：数据复制（无主节点）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/20</span>
            <a class="archive-post-title" href="/2021/01/20/DDIA_note-6/">《DDIA》阅读笔记（五）：数据复制（多主节点）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/10</span>
            <a class="archive-post-title" href="/2021/01/10/DB_right-database/">选择合适的数据库（译）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/09</span>
            <a class="archive-post-title" href="/2021/01/09/DDIA_note-5/">《DDIA》阅读笔记（五）：数据复制（单主节点）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span>
            <a class="archive-post-title" href="/2021/01/01/DB_tree-table-design-summary/">树形表结构设计总结</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2020 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/13</span>
            <a class="archive-post-title" href="/2020/12/13/DDIA_note-3/">《DDIA》阅读笔记（三）：数据存储与检索</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/04</span>
            <a class="archive-post-title" href="/2020/12/04/DDIA_note-2/">《DDIA》阅读笔记（二）：数据模型与查询语言</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/02</span>
            <a class="archive-post-title" href="/2020/12/02/DDIA_note-1/">《DDIA》阅读笔记（一）：可靠、可扩展与可维护的应用系统</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span>
            <a class="archive-post-title" href="/2020/10/08/Maven_external_dependencies_management/">Maven 打包依赖外置</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/04</span>
            <a class="archive-post-title" href="/2020/10/04/Java_prod-analysis-cmd/">Java 应用常用调试分析方法总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span>
            <a class="archive-post-title" href="/2020/09/24/Kafka_cheat-sheet/">Kafka Cheat Sheet</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/09</span>
            <a class="archive-post-title" href="/2020/08/09/Arthas_cheat-sheet/">Arthas Cheat Sheet</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">07/12</span>
            <a class="archive-post-title" href="/2020/07/12/Java_override-and-bridge-method/">Java 多态、重写与桥接方法</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span>
            <a class="archive-post-title" href="/2020/06/30/Java_memory-area/">Java 内存区域</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span>
            <a class="archive-post-title" href="/2020/05/28/DB_data-warehouse-design-basic/">数据仓库设计基础</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/08</span>
            <a class="archive-post-title" href="/2020/04/08/2020-04-08_diary/">关于使用思维导图做笔记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/28</span>
            <a class="archive-post-title" href="/2020/03/28/Algorithm_leetcode-high-frequency-problems/">LeetCode 高频面试题</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/06</span>
            <a class="archive-post-title" href="/2020/03/06/InfoSecty_personal-infomation-security-guide/">個人信息安全保護指南</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/22</span>
            <a class="archive-post-title" href="/2020/02/22/2020-02-22_diary/">免费 JetBrains 全家桶</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/16</span>
            <a class="archive-post-title" href="/2020/02/16/Nginx_cheat-sheet/">Nginx Cheat Sheet</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span>
            <a class="archive-post-title" href="/2020/02/15/Git_cheat-sheet/">Git Cheat Sheet</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span>
            <a class="archive-post-title" href="/2020/02/15/Docker&K8S_cheat-sheet/">Docker & K8S Cheat Sheet</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/03</span>
            <a class="archive-post-title" href="/2020/02/03/Java_jstat-monitor-analysis/">JVM jstat 监控分析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/01</span>
            <a class="archive-post-title" href="/2020/02/01/Java_GC-log-analysis/">JVM GC 日志分析</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span>
            <a class="archive-post-title" href="/2020/01/01/Java_JVM_mindmap/">Java 虚拟机与并发编程</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2019 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span>
            <a class="archive-post-title" href="/2019/12/05/Design_design-patterns/">设计模式与设计原则</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/04</span>
            <a class="archive-post-title" href="/2019/10/04/Python_async-programming/">Python 异步编程总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span>
            <a class="archive-post-title" href="/2019/09/19/Python_data-structure/">Python 数据结构应用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span>
            <a class="archive-post-title" href="/2019/09/13/Python_decorator/">Python 装饰器基本用法</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/22</span>
            <a class="archive-post-title" href="/2019/08/22/Python_OOP-summary/">Python 类与对象总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span>
            <a class="archive-post-title" href="/2019/06/28/JavaScript_cheat-sheet/">JavaScript Cheat Sheet</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span>
            <a class="archive-post-title" href="/2019/06/02/JavaScript_ES6-grammar/">ES6 语法总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/20</span>
            <a class="archive-post-title" href="/2019/05/20/Vue_user-guide/">Vue 学习笔记</a>
        </li>
    
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
        
            <span class="sidebar-tag-name" data-tags="杂事">
                <span class="iconfont-archer">&#xe606;</span>
                杂事
            </span>
        
            <span class="sidebar-tag-name" data-tags="技术">
                <span class="iconfont-archer">&#xe606;</span>
                技术
            </span>
        
            <span class="sidebar-tag-name" data-tags="算法">
                <span class="iconfont-archer">&#xe606;</span>
                算法
            </span>
        
            <span class="sidebar-tag-name" data-tags="Java">
                <span class="iconfont-archer">&#xe606;</span>
                Java
            </span>
        
            <span class="sidebar-tag-name" data-tags="数据库">
                <span class="iconfont-archer">&#xe606;</span>
                数据库
            </span>
        
            <span class="sidebar-tag-name" data-tags="大数据">
                <span class="iconfont-archer">&#xe606;</span>
                大数据
            </span>
        
            <span class="sidebar-tag-name" data-tags="设计">
                <span class="iconfont-archer">&#xe606;</span>
                设计
            </span>
        
            <span class="sidebar-tag-name" data-tags="分布式系统">
                <span class="iconfont-archer">&#xe606;</span>
                分布式系统
            </span>
        
            <span class="sidebar-tag-name" data-tags="Docker">
                <span class="iconfont-archer">&#xe606;</span>
                Docker
            </span>
        
            <span class="sidebar-tag-name" data-tags="Kubernetes">
                <span class="iconfont-archer">&#xe606;</span>
                Kubernetes
            </span>
        
            <span class="sidebar-tag-name" data-tags="Go">
                <span class="iconfont-archer">&#xe606;</span>
                Go
            </span>
        
            <span class="sidebar-tag-name" data-tags="信息安全">
                <span class="iconfont-archer">&#xe606;</span>
                信息安全
            </span>
        
            <span class="sidebar-tag-name" data-tags="Maven">
                <span class="iconfont-archer">&#xe606;</span>
                Maven
            </span>
        
            <span class="sidebar-tag-name" data-tags="Nginx">
                <span class="iconfont-archer">&#xe606;</span>
                Nginx
            </span>
        
            <span class="sidebar-tag-name" data-tags="Linux">
                <span class="iconfont-archer">&#xe606;</span>
                Linux
            </span>
        
            <span class="sidebar-tag-name" data-tags="OS">
                <span class="iconfont-archer">&#xe606;</span>
                OS
            </span>
        
            <span class="sidebar-tag-name" data-tags="Python">
                <span class="iconfont-archer">&#xe606;</span>
                Python
            </span>
        
            <span class="sidebar-tag-name" data-tags="Git">
                <span class="iconfont-archer">&#xe606;</span>
                Git
            </span>
        
            <span class="sidebar-tag-name" data-tags="微服务">
                <span class="iconfont-archer">&#xe606;</span>
                微服务
            </span>
        
            <span class="sidebar-tag-name" data-tags="JavaScript">
                <span class="iconfont-archer">&#xe606;</span>
                JavaScript
            </span>
        
            <span class="sidebar-tag-name" data-tags="MySQL">
                <span class="iconfont-archer">&#xe606;</span>
                MySQL
            </span>
        
            <span class="sidebar-tag-name" data-tags="Kafka">
                <span class="iconfont-archer">&#xe606;</span>
                Kafka
            </span>
        
            <span class="sidebar-tag-name" data-tags="Vue">
                <span class="iconfont-archer">&#xe606;</span>
                Vue
            </span>
        
            <span class="sidebar-tag-name" data-tags="前端">
                <span class="iconfont-archer">&#xe606;</span>
                前端
            </span>
        
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="《数据密集型应用系统设计》阅读笔记">
            <span class="iconfont-archer">&#xe60a;</span>
            《数据密集型应用系统设计》阅读笔记
        </span>
    
        <span class="sidebar-category-name" data-categories="《凤凰架构》阅读笔记">
            <span class="iconfont-archer">&#xe60a;</span>
            《凤凰架构》阅读笔记
        </span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://yipwinghong.github.io",
        root: siteMetaRoot,
        author: "Kyle Yip"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->


        <!-- main func -->
        <script src="/scripts/main.js?v=20211217"></script>
        <!-- dark mode -->
        <script src="/scripts/dark.js?v=20211217"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" defer></script>
        <!-- algolia -->
        
        <!-- busuanzi -->
        
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        
        <!-- CNZZ -->
        
        <!-- async load share.js -->
        
            <script src="/scripts/share.js?v=20211217" async></script>
        
        <!-- mermaid -->
        
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
